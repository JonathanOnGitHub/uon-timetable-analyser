<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teaching Load Analyser</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

body{
font-family:Arial;
margin:0;
background:#f4f6f9;
}

header{
background:#041e42;
color:white;
padding:20px;
}

.container{
padding:20px;
}

button{
background:#0066cc;
color:white;
border:none;
padding:8px 14px;
margin:4px;
cursor:pointer;
}

.tab-button{
background:#ccc;
color:black;
}

.tab-button.active{
background:#0066cc;
color:white;
}

table{
border-collapse:collapse;
width:100%;
background:white;
}

th,td{
border:1px solid #ccc;
padding:6px;
text-align:center;
}

th{
background:#041e42;
color:white;
cursor:pointer;
}

.total-row{
background:#dbe5f1;
font-weight:bold;
}

.modal{
display:none;
position:fixed;
top:10%;
left:10%;
width:80%;
height:75%;
background:white;
border:2px solid #041e42;
overflow:auto;
padding:15px;
}

.close{
float:right;
cursor:pointer;
font-weight:bold;
}

</style>
</head>
<body>

<header>
<h2>Teaching Load Analyser</h2>
All processing happens locally in your browser.
</header>

<div class="container">

Title:
<input id="titleInput" size="40">

<br><br>

<input type="file" id="fileInput" multiple accept=".html">

<label>
<input type="checkbox" id="realisticToggle">
Merge overlaps (staff view only)
</label>

<br>

<button onclick="analyse()">Analyse</button>
<button onclick="exportExcel()">Export Excel</button>
<button onclick="exportPNG()">Export PNG</button>

<br><br>

<button class="tab-button active" onclick="switchTab('staff',event)">Staff View</button>
<button class="tab-button" onclick="switchTab('module',event)">Module View</button>

<div id="tableContainer"></div>

</div>

<div id="modal" class="modal">
<span class="close" onclick="closeModal()">Close</span>
<div id="modalContent"></div>
</div>

<script>

let rawSessions=[];
let currentView="staff";

let sortState={column:"name",direction:1};

function colourScale(hours){

if(hours==0) return "white";
if(hours<2) return "#cfe2ff";
if(hours<5) return "#6fa8dc";
if(hours<8) return "#f6b26b";
return "#e06666";
}

function parseWeeks(text){

let result=[];

text.split(",").forEach(p=>{

if(p.includes("-")){
let[a,b]=p.split("-").map(Number);
for(let i=a;i<=b;i++) result.push(i);
}
else result.push(Number(p));

});

return result;
}

function parseTime(t){

let[h,m]=t.split(":").map(Number);
return h*60+m;
}

function analyse(){

rawSessions=[];

Promise.all([...fileInput.files].map(f=>f.text()))
.then(texts=>{

texts.forEach(parseHTML);
render();

});
}

function parseHTML(html){

let doc=new DOMParser().parseFromString(html,"text/html");

doc.querySelectorAll("table").forEach(table=>{

let headers=[...table.querySelectorAll("th")].map(h=>h.innerText.trim());

if(!headers.includes("Activity")) return;

table.querySelectorAll("tr").forEach((row,i)=>{

if(i===0) return;

let cells=row.querySelectorAll("td");

if(!cells.length) return;

let obj={};

headers.forEach((h,i)=>obj[h]=cells[i]?.innerHTML.trim()||"");

let staff=obj["Staff"].split("<br>").map(s=>s.trim()).filter(Boolean);

let weeks=parseWeeks(obj["Weeks"]);

let day=obj["Day"];
let start=parseTime(obj["Start"]);
let end=parseTime(obj["End"]);

weeks.forEach(week=>{

rawSessions.push({

module:obj["Module Code"],
staffList:staff,
week,
day,
start,
end,
duration:(end-start)/60,
raw:obj

});

});

});

});
}

function mergeIntervals(intervals){

intervals.sort((a,b)=>a[0]-b[0]);

let merged=[];

intervals.forEach(i=>{

if(!merged.length)
merged.push(i);
else{

let last=merged[merged.length-1];

if(i[0]<=last[1])
last[1]=Math.max(last[1],i[1]);
else
merged.push(i);

}

});

return merged;
}

function aggregateStaff(){

let realistic=realisticToggle.checked;

let result={};

rawSessions.forEach(s=>{

s.staffList.forEach(staff=>{

if(!result[staff]) result[staff]={_total:0};

if(!result[staff][s.week])
result[staff][s.week]={};

if(!result[staff][s.week][s.day])
result[staff][s.week][s.day]=[];

result[staff][s.week][s.day].push([s.start,s.end]);

});

});

Object.keys(result).forEach(staff=>{

Object.keys(result[staff]).forEach(week=>{

if(week=="_total") return;

let weekTotal=0;

Object.values(result[staff][week]).forEach(intervals=>{

if(realistic)
intervals=mergeIntervals(intervals);

weekTotal+=intervals.reduce((sum,i)=>sum+(i[1]-i[0]),0)/60;

});

result[staff][week]=weekTotal;
result[staff]._total+=weekTotal;

});

});

return result;
}

function aggregateModule(){

let result={};

rawSessions.forEach(s=>{

if(!result[s.module])
result[s.module]={_total:0};

if(!result[s.module][s.week])
result[s.module][s.week]=0;

result[s.module][s.week]+=s.duration;
result[s.module]._total+=s.duration;

});

return result;
}

function aggregate(){

return currentView=="staff"
?aggregateStaff()
:aggregateModule();
}

function render(){

let data=aggregate();

let weeks=[...new Set(rawSessions.map(s=>s.week))].sort((a,b)=>a-b);

let keys=Object.keys(data);

keys.sort((a,b)=>{

if(sortState.column=="name")
return a.localeCompare(b)*sortState.direction;

if(sortState.column=="total")
return (data[a]._total-data[b]._total)*sortState.direction;

return ((data[a][sortState.column]||0)-(data[b][sortState.column]||0))
*sortState.direction;

});

let html="<div id='exportArea'>";

if(titleInput.value)
html+="<h3>"+titleInput.value+"</h3>";

html+="<table><thead><tr>";

html+="<th onclick='sortBy(\"name\")'>"+
(currentView=="staff"?"Staff":"Module")+
"</th>";

weeks.forEach(w=>{
html+="<th onclick='sortBy("+w+")'>Week "+w+"</th>";
});

html+="<th onclick='sortBy(\"total\")'>Total</th>";

html+="</tr></thead><tbody>";

let grandWeeks=new Array(weeks.length).fill(0);
let grandTotal=0;

keys.forEach(key=>{

html+="<tr><td>"+key+"</td>";

weeks.forEach((w,i)=>{

let v=data[key][w]||0;

grandWeeks[i]+=v;

html+="<td style='background:"+colourScale(v)+"' onclick='showDetails(\""+key+"\","+w+")'>"+
v.toFixed(2)+"</td>";

});

grandTotal+=data[key]._total;

html+="<td style='background:"+colourScale(data[key]._total)+"'><b>"+
data[key]._total.toFixed(2)+"</b></td>";

html+="</tr>";

});

html+="<tr class='total-row'><td>Grand Total</td>";

grandWeeks.forEach(v=>{
html+="<td>"+v.toFixed(2)+"</td>";
});

html+="<td>"+grandTotal.toFixed(2)+"</td>";

html+="</tr></tbody></table></div>";

tableContainer.innerHTML=html;
}

function sortBy(col){

if(sortState.column==col)
sortState.direction*=-1;
else{
sortState.column=col;
sortState.direction=1;
}

render();
}

function switchTab(tab,e){

currentView=tab;

document.querySelectorAll(".tab-button")
.forEach(b=>b.classList.remove("active"));

e.target.classList.add("active");

render();
}

function showDetails(key,week){

let filtered=rawSessions.filter(s=>
(!key||(currentView=="staff"?s.staffList.includes(key):s.module==key))
&&(!week||s.week==week)
);

let html="<table><tr><th>Week</th><th>Day</th><th>Module</th><th>Staff</th><th>Hours</th></tr>";

filtered.forEach(s=>{
html+="<tr>";
html+="<td>"+s.week+"</td>";
html+="<td>"+s.day+"</td>";
html+="<td>"+s.module+"</td>";
html+="<td>"+s.staffList.join(", ")+"</td>";
html+="<td>"+s.duration.toFixed(2)+"</td>";
html+="</tr>";
});

html+="</table>";

modalContent.innerHTML=html;
modal.style.display="block";
}

function closeModal(){
modal.style.display="none";
}

function exportExcel(){
let wb=XLSX.utils.table_to_book(document.querySelector("table"));
XLSX.writeFile(wb,"teaching_load.xlsx");
}

function exportPNG(){
html2canvas(exportArea).then(canvas=>{
let link=document.createElement("a");
link.download="teaching_load.png";
link.href=canvas.toDataURL();
link.click();
});
}

</script>
</body>
</html>
