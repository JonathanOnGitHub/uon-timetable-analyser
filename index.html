<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UoN Timetable Load Analyser</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Mono:wght@400;500&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --navy:   #10263B;
  --navy80: #1e4068;
  --navy10: #f0f3f6;
  --navy05: #f7f9fb;
  --green:  #005F36;
  --gold:   #DEB406;
  --gold-lt:#f5e270;
  --red:    #B91C2E;
  --white:  #ffffff;
  --border: #d0d8e2;
  --muted:  #5a6e82;
  --text:   #10263B;
  --shadow: 0 2px 10px rgba(16,38,59,.09);
  --shadow-lg: 0 8px 32px rgba(16,38,59,.14);
  --radius: 10px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Source Sans 3', sans-serif;
  font-size: 16px;
  font-weight: 400;
  color: var(--text);
  background: var(--navy10);
  min-height: 100vh;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  background: var(--navy);
  border-bottom: 3px solid var(--gold);
  padding: 0 40px;
  height: 64px;
  display: flex;
  align-items: center;
  gap: 14px;
  position: sticky;
  top: 0;
  z-index: 100;
}
header h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.45rem;
  font-weight: 900;
  color: var(--white);
  letter-spacing: -.02em;
  white-space: nowrap;
}
.header-badge {
  font-family: 'DM Mono', monospace;
  font-size: .65rem;
  color: rgba(255,255,255,.45);
  background: rgba(255,255,255,.1);
  border: 1px solid rgba(255,255,255,.18);
  padding: 2px 8px;
  border-radius: 4px;
}
header .spacer { flex: 1; }
.hdr-btn {
  background: rgba(255,255,255,.12);
  border: 1px solid rgba(255,255,255,.22);
  color: rgba(255,255,255,.8);
  font-family: 'DM Mono', monospace;
  font-size: .72rem;
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
  transition: all .15s;
  letter-spacing: .04em;
}
.hdr-btn:hover { background: rgba(255,255,255,.22); color: #fff; }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main { max-width: 1360px; margin: 0 auto; padding: 32px 40px 60px; }

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 24px;
}
.card-header {
  padding: 18px 24px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card-title {
  font-family: 'DM Mono', monospace;
  font-size: .7rem;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: var(--navy);
  font-weight: 500;
}
.card-body { padding: 20px 24px 24px; }

/* ‚îÄ‚îÄ IMPORT SWITCHER ‚îÄ‚îÄ */
.method-tabs {
  display: flex;
  background: var(--navy);
  border-radius: var(--radius) var(--radius) 0 0;
  overflow: hidden;
  border-bottom: 2px solid var(--gold);
}
.method-tab {
  flex: 1;
  padding: 14px 20px;
  font-family: 'DM Mono', monospace;
  font-size: .75rem;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: rgba(255,255,255,.5);
  background: transparent;
  border: none;
  cursor: pointer;
  transition: all .15s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  position: relative;
}
.method-tab:hover { color: rgba(255,255,255,.8); background: rgba(255,255,255,.06); }
.method-tab.active { color: #fff; background: rgba(255,255,255,.14); font-weight: 500; }
.method-tab.active::after {
  content: '';
  position: absolute;
  bottom: -2px; left: 0; right: 0;
  height: 2px;
  background: var(--gold);
}
.method-divider { width: 1px; background: rgba(255,255,255,.15); margin: 10px 0; }

.method-pane { display: none; padding: 24px; }
.method-pane.active { display: block; }

/* ‚îÄ‚îÄ DROPZONE ‚îÄ‚îÄ */
.dropzone {
  display: block;
  width: 100%;
  box-sizing: border-box;
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 36px 20px;
  text-align: center;
  cursor: pointer;
  transition: all .2s;
  background: var(--navy05);
  user-select: none;
}
.dropzone:hover, .dropzone.over {
  border-color: var(--navy);
  background: rgba(16,38,59,.05);
}
.dropzone .dz-icon { font-size: 2rem; margin-bottom: 8px; }
.dropzone .dz-main { font-size: .95rem; color: var(--text); }
.dropzone .dz-main strong { color: var(--navy); }
.dropzone .dz-sub { font-size: .78rem; color: var(--muted); margin-top: 4px; }

/* ‚îÄ‚îÄ BOOKMARKLET STEPS ‚îÄ‚îÄ */
.bm-steps {
  display: flex;
  gap: 0;
  margin-bottom: 20px;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.bm-step {
  flex: 1;
  padding: 14px 16px;
  background: var(--navy05);
  border-right: 1px solid var(--border);
}
.bm-step:last-child { border-right: none; }
.bm-step-num {
  font-family: 'DM Mono', monospace;
  font-size: .62rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
  margin-bottom: 6px;
}
.bm-step-content { font-size: .88rem; color: var(--text); }

/* ‚îÄ‚îÄ DRAG LINK ‚îÄ‚îÄ */
.drag-link {
  display: inline-block;
  background: var(--navy);
  color: #fff;
  padding: 7px 16px;
  border-radius: 6px;
  font-size: .83rem;
  font-weight: 500;
  cursor: grab;
  text-decoration: none;
  transition: background .15s;
}
.drag-link:hover { background: var(--navy80); }

/* ‚îÄ‚îÄ SOURCES LIST ‚îÄ‚îÄ */
#sourcesWrap { display: none; border-top: 1px solid var(--border); padding: 16px 24px 20px; }
.sources-hdr {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.sources-lbl {
  font-family: 'DM Mono', monospace;
  font-size: .68rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
}
.sources-total { font-family: 'DM Mono', monospace; font-size: .72rem; color: var(--green); font-weight: 500; }
#sourcesList { display: flex; flex-direction: column; gap: 7px; }
.src-item {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--navy05);
  border: 1px solid var(--border);
  border-left: 3px solid var(--green);
  border-radius: 7px;
  padding: 9px 12px;
}
.src-name { flex: 1; font-size: .88rem; font-weight: 500; }
.src-meta { font-family: 'DM Mono', monospace; font-size: .65rem; color: var(--muted); margin-top: 2px; }
.src-remove {
  background: none;
  border: 1px solid var(--border);
  color: var(--muted);
  border-radius: 5px;
  width: 26px; height: 26px;
  cursor: pointer;
  font-size: .85rem;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
  flex-shrink: 0;
}
.src-remove:hover { border-color: var(--red); color: var(--red); background: rgba(185,28,46,.06); }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  border-radius: 6px;
  font-family: 'Source Sans 3', sans-serif;
  font-size: .9rem;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all .15s;
  text-decoration: none;
}
.btn-primary { background: var(--navy); color: #fff; }
.btn-primary:hover { background: var(--navy80); }
.btn-primary:disabled { opacity: .5; cursor: not-allowed; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { border-color: var(--navy); color: var(--navy); background: rgba(16,38,59,.04); }
.btn-sm { padding: 5px 12px; font-size: .8rem; }
.btn-danger { background: var(--red); color: #fff; border: none; }
.btn-danger:hover { background: #9a1525; }
.btn-danger.done { background: rgba(185,28,46,.1); border: 1px solid var(--red); color: var(--red); }
.btn-working { background: var(--border); color: var(--muted); cursor: not-allowed; }

/* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
#statusBar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 11px 18px;
  border-radius: 8px;
  font-family: 'DM Mono', monospace;
  font-size: .76rem;
  color: var(--muted);
  background: var(--white);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  margin-bottom: 24px;
}
#statusBar .dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--border);
  flex-shrink: 0;
}
#statusBar.ok .dot { background: var(--green); }
#statusBar.ok { color: var(--green); }
#statusBar.err .dot { background: var(--red); }
#statusBar.err { color: var(--red); }

/* ‚îÄ‚îÄ MAPPING PANEL ‚îÄ‚îÄ */
#mappingPanel { display: none; }
#mappingPanel.show { display: block; }
.map-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
  gap: 12px;
  margin: 16px 0 20px;
}
.map-field label {
  display: block;
  font-family: 'DM Mono', monospace;
  font-size: .66rem;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--muted);
  margin-bottom: 5px;
}
.map-field select {
  width: 100%;
  background: var(--navy05);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: 'DM Mono', monospace;
  font-size: .76rem;
  padding: 7px 10px;
  outline: none;
  cursor: pointer;
  transition: border-color .15s;
}
.map-field select:focus { border-color: var(--navy); }

/* ‚îÄ‚îÄ KPI ROW ‚îÄ‚îÄ */
#kpiRow {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(148px, 1fr));
  gap: 14px;
  margin-bottom: 24px;
}
.kpi {
  background: var(--white);
  border: 1px solid var(--border);
  border-top: 3px solid var(--navy);
  border-radius: var(--radius);
  padding: 18px 16px;
  text-align: center;
  box-shadow: var(--shadow);
}
.kpi.clash { border-top-color: var(--red); }
.kpi-val {
  font-family: 'Playfair Display', serif;
  font-size: 2rem;
  font-weight: 700;
  color: var(--navy);
  line-height: 1;
  margin-bottom: 5px;
}
.kpi.clash .kpi-val { color: var(--red); }
.kpi-lbl {
  font-family: 'DM Mono', monospace;
  font-size: .62rem;
  text-transform: uppercase;
  letter-spacing: .1em;
  color: var(--muted);
}

/* ‚îÄ‚îÄ RESULTS TABS ‚îÄ‚îÄ */
.results-toolbar {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.tab-strip {
  display: flex;
  gap: 3px;
  border-bottom: 2px solid var(--navy);
  margin-bottom: 22px;
}
.tab-btn {
  padding: 9px 18px;
  font-family: 'DM Mono', monospace;
  font-size: .7rem;
  text-transform: uppercase;
  letter-spacing: .07em;
  color: var(--muted);
  background: transparent;
  border: 1px solid transparent;
  border-bottom: none;
  border-radius: 6px 6px 0 0;
  cursor: pointer;
  position: relative;
  top: 2px;
  transition: all .15s;
}
.tab-btn:hover { color: var(--navy); background: rgba(16,38,59,.04); }
.tab-btn.active { background: var(--navy); color: #fff; border-color: var(--navy); }
.tab-pane { display: none; }
.tab-pane.active { display: block; }

/* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
.filter-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.filter-bar input, .filter-bar select {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-family: 'DM Mono', monospace;
  font-size: .76rem;
  padding: 7px 11px;
  outline: none;
  transition: border-color .15s;
  box-shadow: 0 1px 3px rgba(16,38,59,.05);
}
.filter-bar input { min-width: 200px; }
.filter-bar input:focus, .filter-bar select:focus { border-color: var(--navy); }

/* ‚îÄ‚îÄ DATA TABLE ‚îÄ‚îÄ */
.tbl-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: .9rem; }
thead tr { border-bottom: 2px solid var(--navy); background: var(--navy05); }
th {
  font-family: 'DM Mono', monospace;
  font-size: .66rem;
  text-transform: uppercase;
  letter-spacing: .09em;
  color: var(--navy);
  font-weight: 600;
  text-align: left;
  padding: 11px 14px;
  cursor: pointer;
  white-space: nowrap;
  user-select: none;
}
th:hover { color: var(--navy80); }
th.asc::after { content: ' ‚Üë'; color: var(--gold); }
th.desc::after { content: ' ‚Üì'; color: var(--gold); }
td { padding: 10px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
tbody tr { cursor: default; }
tbody tr.clickable { cursor: pointer; }
tbody tr.clickable:hover td { background: rgba(16,38,59,.03); }
tbody tr.clickable td:first-child { color: var(--navy); text-decoration: underline; text-decoration-color: rgba(16,38,59,.25); text-underline-offset: 3px; }
tbody tr.clash-row td { background: rgba(185,28,46,.05); }
tbody tr.clash-row td:first-child { border-left: 3px solid var(--red); }

/* ‚îÄ‚îÄ BADGES / BARS ‚îÄ‚îÄ */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-family: 'DM Mono', monospace;
  font-size: .68rem;
  font-weight: 500;
}
.badge-green { background: rgba(0,95,54,.1); color: var(--green); border: 1px solid rgba(0,95,54,.2); }
.badge-gold  { background: rgba(222,180,6,.15); color: #7a5e00; border: 1px solid rgba(222,180,6,.3); }
.badge-navy  { background: rgba(16,38,59,.08); color: var(--navy); border: 1px solid rgba(16,38,59,.15); }
.badge-red   { background: rgba(185,28,46,.1); color: var(--red); border: 1px solid rgba(185,28,46,.25); }
.badge-ok    { background: rgba(0,95,54,.1); color: var(--green); border: 1px solid rgba(0,95,54,.2); }
.clash-pill {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 4px;
  font-family: 'DM Mono', monospace;
  font-size: .62rem;
  background: rgba(185,28,46,.1);
  color: var(--red);
  border: 1px solid rgba(185,28,46,.25);
  margin-left: 6px;
  cursor: help;
}
.mini-bar { display: inline-block; width: 70px; height: 5px; background: var(--border); border-radius: 3px; vertical-align: middle; margin-left: 8px; overflow: hidden; }
.mini-bar-fill { height: 100%; background: var(--gold); border-radius: 3px; }

/* ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ */
.heatmap-grid { display: inline-flex; flex-direction: column; gap: 3px; }
.heatmap-row { display: flex; gap: 3px; align-items: center; }
.heatmap-label { font-family: 'DM Mono', monospace; font-size: .66rem; color: var(--text); width: 130px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.heatmap-col-header { font-family: 'DM Mono', monospace; font-size: .6rem; color: var(--navy); width: 34px; text-align: center; }
.heatmap-cell { width: 34px; height: 26px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-family: 'DM Mono', monospace; font-size: .58rem; font-weight: 500; cursor: default; transition: transform .12s, box-shadow .12s; position: relative; }
.heatmap-cell[onclick] { cursor: pointer; }
.heatmap-cell[onclick]:hover { transform: scale(1.3); box-shadow: 0 2px 8px rgba(16,38,59,.25); z-index: 5; }


/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty { text-align: center; padding: 60px 20px; color: var(--muted); }
.empty-icon { font-size: 2.5rem; margin-bottom: 12px; }
.empty p { font-size: .9rem; }

/* ‚îÄ‚îÄ EXPORT BAR ‚îÄ‚îÄ */
.export-bar { display: flex; justify-content: flex-end; margin-bottom: 12px; }

/* ‚îÄ‚îÄ DRILL-DOWN PANEL ‚îÄ‚îÄ */
#ddOverlay {
  position: fixed; inset: 0;
  background: rgba(16,38,59,.3);
  z-index: 400;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s;
}
#ddOverlay.open { opacity: 1; pointer-events: auto; }
#ddPanel {
  position: fixed; top: 0; right: 0;
  width: min(540px, 100vw);
  height: 100vh;
  background: var(--white);
  border-left: 3px solid var(--navy);
  box-shadow: var(--shadow-lg);
  display: flex; flex-direction: column;
  transform: translateX(100%);
  transition: transform .24s cubic-bezier(.4,0,.2,1);
  z-index: 401;
}
#ddPanel.open { transform: translateX(0); }
.dd-hdr {
  background: var(--navy);
  border-bottom: 3px solid var(--gold);
  padding: 18px 22px;
  display: flex; align-items: flex-start; gap: 12px;
  flex-shrink: 0;
}
.dd-hdr-text { flex: 1; min-width: 0; }
.dd-hdr-lbl { font-family: 'DM Mono', monospace; font-size: .62rem; text-transform: uppercase; letter-spacing: .12em; color: rgba(255,255,255,.5); margin-bottom: 4px; }
.dd-hdr-title { font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 900; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dd-close { background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.22); color: #fff; width: 30px; height: 30px; border-radius: 5px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background .15s; }
.dd-close:hover { background: rgba(255,255,255,.25); }
.dd-stats { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.dd-stat { flex: 1; padding: 13px 14px; text-align: center; border-right: 1px solid var(--border); }
.dd-stat:last-child { border-right: none; }
.dd-stat-val { font-family: 'Playfair Display', serif; font-size: 1.35rem; font-weight: 700; color: var(--navy); line-height: 1; margin-bottom: 3px; }
.dd-stat-lbl { font-family: 'DM Mono', monospace; font-size: .6rem; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); }
.dd-body { flex: 1; overflow-y: auto; }
.dd-group-hdr { font-family: 'DM Mono', monospace; font-size: .64rem; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); padding: 12px 20px 7px; background: var(--navy05); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1; }
.dd-row { display: grid; grid-template-columns: 88px 1fr auto; gap: 8px; padding: 11px 20px; border-bottom: 1px solid var(--border); align-items: start; }
.dd-row:hover { background: rgba(16,38,59,.02); }
.dd-row.clash { border-left: 3px solid var(--red); background: rgba(185,28,46,.04); }
.dd-time { font-family: 'DM Mono', monospace; font-size: .71rem; color: var(--navy); font-weight: 600; padding-top: 2px; }
.dd-mod { font-size: .88rem; font-weight: 500; color: var(--text); line-height: 1.3; }
.dd-meta { font-family: 'DM Mono', monospace; font-size: .64rem; color: var(--muted); margin-top: 3px; }
.dd-hrs { font-family: 'DM Mono', monospace; font-size: .71rem; color: var(--muted); white-space: nowrap; text-align: right; padding-top: 2px; }
.dd-clash-flag { font-family: 'DM Mono', monospace; font-size: .6rem; color: var(--red); text-align: right; margin-top: 3px; }

/* ‚îÄ‚îÄ FAQ MODAL ‚îÄ‚îÄ */
#faqOverlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.6);
  z-index: 500;
  opacity: 0;
  pointer-events: none;
  transition: opacity .15s;
  display: flex; align-items: center; justify-content: center; padding: 20px;
}
#faqOverlay.open { opacity: 1; pointer-events: auto; }
.faq-modal {
  background: var(--white);
  border-radius: 14px;
  border-top: 4px solid var(--navy);
  max-width: 700px; width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  padding: 38px;
  position: relative;
  box-shadow: var(--shadow-lg);
  transform: translateY(12px);
  transition: transform .2s;
}
#faqOverlay.open .faq-modal { transform: translateY(0); }
.faq-close { position: absolute; top: 14px; right: 18px; background: none; border: none; color: var(--muted); font-size: 1.3rem; cursor: pointer; transition: color .15s; }
.faq-close:hover { color: var(--navy); }
.faq-modal h2 { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: 900; color: var(--navy); margin-bottom: 22px; }
.faq-item { margin-bottom: 24px; }
.faq-item h3 { font-family: 'DM Mono', monospace; font-size: .72rem; text-transform: uppercase; letter-spacing: .1em; color: var(--navy); font-weight: 600; margin-bottom: 7px; }
.faq-item p { font-size: .9rem; color: var(--text); line-height: 1.7; font-weight: 300; }
.faq-item p + p { margin-top: 7px; }
.faq-hr { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
.faq-box { background: var(--navy05); border-left: 3px solid var(--gold); border-radius: 0 6px 6px 0; padding: 12px 15px; margin-top: 9px; font-family: 'DM Mono', monospace; font-size: .74rem; color: var(--muted); line-height: 1.6; }
.faq-box strong { color: var(--navy); }

@media (max-width: 768px) {
  main { padding: 20px; }
  header { padding: 0 20px; }
  .bm-steps { flex-direction: column; }
  .bm-step { border-right: none; border-bottom: 1px solid var(--border); }
}
</style>
</head>
<body>

<header>
  <h1>Timetable Load Analyser</h1>
  <span class="header-badge">UoN</span>
  <div class="spacer"></div>
  <button class="hdr-btn" id="faqBtn">? FAQ</button>
</header>

<!-- Drill-down overlay + panel -->
<div id="ddOverlay"></div>
<div id="ddPanel">
  <div class="dd-hdr">
    <div class="dd-hdr-text">
      <div class="dd-hdr-lbl" id="ddLabel"></div>
      <div class="dd-hdr-title" id="ddTitle"></div>
    </div>
    <button class="dd-close" id="ddClose">‚úï</button>
  </div>
  <div class="dd-stats" id="ddStats"></div>
  <div class="dd-body" id="ddBody"></div>
</div>

<!-- FAQ overlay -->
<div id="faqOverlay">
  <div class="faq-modal">
    <button class="faq-close" id="faqClose">√ó</button>
    <h2>Frequently Asked Questions</h2>

    <div class="faq-item">
      <h3>What data does this tool need?</h3>
      <p>At minimum a staff name or module name column. It works best with start time, end time, date or week number, and semester columns too.</p>
    </div>
    <hr class="faq-hr">
    <div class="faq-item">
      <h3>How do I import data?</h3>
      <p><strong>Upload:</strong> Go to your timetable page, use File ‚Üí Save Page As ‚Üí Web Page (HTML). Drop that file into the upload zone. The tool merges all matching tables automatically.</p>
      <p><strong>Bookmarklet:</strong> Drag the "Scrape Timetable" button to your bookmarks bar. Navigate to your timetable page and click it ‚Äî data is copied to clipboard. Switch back here and paste.</p>
      <p><strong>Multiple sources:</strong> You can load Semester 1 and Semester 2 from separate pages. Each goes through the mapping step and is merged into one combined dataset. Use the source list to remove individual imports.</p>
    </div>
    <hr class="faq-hr">
    <div class="faq-item">
      <h3>Multiple HTML tables on one page?</h3>
      <p>Not a problem. The tool detects all tables with matching headers and merges them. Unrelated tables (navigation, summaries) are ignored. The status bar confirms how many were merged.</p>
    </div>
    <hr class="faq-hr">
    <div class="faq-item">
      <h3>Sessions with multiple staff?</h3>
      <p>When a cell contains multiple staff names separated by a line break (&lt;br&gt;), each name becomes its own row ‚Äî same module, time, and room ‚Äî so every person's contribution is counted individually.</p>
    </div>
    <hr class="faq-hr">
    <div class="faq-item">
      <h3>How does clash detection work?</h3>
      <p>‚ö° Detect Clashes checks every staff member for sessions whose times overlap on the same day. It requires start and end times to be mapped.</p>
      <div class="faq-box">
        <strong>1. Convert</strong> each session to an absolute time interval (date + start ‚Üí date + end)<br>
        <strong>2. Compare</strong> every pair of sessions per staff member for overlaps<br>
        <strong>3. Flag</strong> overlapping sessions with a red ‚ö† marker<br>
        <strong>4. Merge</strong> overlapping intervals to compute true effective hours
      </div>
    </div>
    <hr class="faq-hr">
    <div class="faq-item">
      <h3>Raw Hours vs Effective Hours?</h3>
      <p><strong>Raw Hours</strong> = simple sum of all session durations. Two simultaneous 2-hour sessions = 4 raw hours.</p>
      <p><strong>Effective Hours</strong> = actual time possible after removing overlaps. Same scenario = 2 effective hours. The difference (shown in red) is total time the timetable places someone in two places at once.</p>
    </div>
    <hr class="faq-hr">
    <div class="faq-item">
      <h3>Is my data private?</h3>
      <p>Completely. Everything runs in your browser ‚Äî no server, no uploads. You can verify with F12 ‚Üí Network: zero data requests during analysis. The only external call is loading Google Fonts on startup.</p>
    </div>
    <hr class="faq-hr">
    <div class="faq-item">
      <h3>Can I export results?</h3>
      <p>Yes ‚Äî every analysis tab has an Export CSV button. Downloads the current view ready for Excel.</p>
    </div>
  </div>
</div>

<main>

  <!-- ‚îÄ‚îÄ IMPORT CARD ‚îÄ‚îÄ -->
  <div class="card" style="padding:0;overflow:hidden;">
    <div class="method-tabs">
      <button class="method-tab active" data-method="upload">üìÅ Upload File</button>
      <div class="method-divider"></div>
      <button class="method-tab" data-method="scrape">üîñ Bookmarklet Scraper</button>
    </div>

    <!-- Upload pane -->
    <div class="method-pane active" data-pane="upload">
      <p style="color:var(--muted);font-size:.9rem;margin-bottom:18px;">Save your timetable page as HTML (File ‚Üí Save Page As) or export as CSV, then drop it below. You can load multiple files ‚Äî each will be added to the dataset.</p>
      <label class="dropzone" id="dropzone" for="fileInput">
        <div class="dz-icon">‚¨Ü</div>
        <div class="dz-main">Drop file here or <strong>click to browse</strong></div>
        <div class="dz-sub">Supports .html ¬∑ .htm ¬∑ .csv</div>
      </label>
      <input type="file" id="fileInput" accept=".html,.htm,.csv,.txt" style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none;">
      <div style="margin-top:14px;display:flex;justify-content:flex-end;">
        <button class="btn btn-outline btn-sm" id="clearAllBtn">Clear All</button>
      </div>
    </div>

    <!-- Scrape pane -->
    <div class="method-pane" data-pane="scrape">
      <div class="bm-steps">
        <div class="bm-step">
          <div class="bm-step-num">Step 1</div>
          <div class="bm-step-content">Drag this button to your bookmarks bar:<br><br><a id="bmLink" href="#" class="drag-link">üîñ Scrape Timetable</a></div>
        </div>
        <div class="bm-step">
          <div class="bm-step-num">Step 2</div>
          <div class="bm-step-content">Go to your timetable page and click the bookmarklet. Data is copied to your clipboard automatically.</div>
        </div>
        <div class="bm-step">
          <div class="bm-step-num">Step 3</div>
          <div class="bm-step-content">Come back here and paste below, then click Parse.</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;">
        <label style="font-family:'DM Mono',monospace;font-size:.68rem;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);">Paste scraped data</label>
        <button class="btn btn-outline btn-sm" id="copyBmBtn">Copy bookmarklet code</button>
      </div>
      <textarea id="pasteArea" placeholder="Paste the copied data here‚Ä¶" style="width:100%;height:90px;background:var(--navy05);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'DM Mono',monospace;font-size:.75rem;padding:10px 12px;resize:vertical;outline:none;transition:border-color .15s;"></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
        <button class="btn btn-primary" id="parsePasteBtn">Parse Pasted Data ‚Üí</button>
        <button class="btn btn-outline btn-sm" id="clearAllBtn2">Clear All</button>
      </div>
    </div>

    <!-- Sources list -->
    <div id="sourcesWrap">
      <div class="sources-hdr">
        <span class="sources-lbl">Loaded sources</span>
        <span class="sources-total" id="sourcesTotal"></span>
      </div>
      <div id="sourcesList"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ -->
  <div id="statusBar"><div class="dot"></div><span id="statusText">No data loaded. Upload a file or paste scraped data to begin.</span></div>

  <!-- ‚îÄ‚îÄ COLUMN MAPPING ‚îÄ‚îÄ -->
  <div class="card" id="mappingPanel">
    <div class="card-header"><span class="card-title">üóÇ Column Mapping ‚Äî map your columns to the right fields</span></div>
    <div class="card-body">
      <p style="color:var(--muted);font-size:.88rem;margin-bottom:4px;">Auto-detected selections shown. Adjust if needed, then click Analyse.</p>
      <div class="map-grid" id="mapGrid"></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary" id="applyMappingBtn">Analyse ‚Üí</button>
        <button class="btn btn-outline" id="cancelMappingBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ -->
  <div id="results" style="display:none;">

    <div id="kpiRow"></div>

    <!-- Toolbar: clash button -->
    <div class="results-toolbar">
      <button class="btn btn-danger" id="clashBtn">‚ö° Detect Clashes</button>
      <span id="clashSummary" style="font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);"></span>
    </div>

    <!-- Tab strip -->
    <div class="tab-strip">
      <button class="tab-btn active" data-tab="staff">By Staff</button>
      <button class="tab-btn" data-tab="module">By Module</button>
      <button class="tab-btn" data-tab="week">By Week</button>
      <button class="tab-btn" data-tab="semester">By Semester</button>
      <button class="tab-btn" data-tab="heatmap">Heatmap</button>
      <button class="tab-btn" data-tab="clashes" id="clashesTabBtn" style="display:none;">‚ö† Clashes</button>
      <button class="tab-btn" data-tab="raw">Raw Data</button>
    </div>

    <!-- By Staff -->
    <div class="tab-pane active" data-tab="staff">
      <div class="filter-bar">
        <input type="text" id="staffSearch" placeholder="Filter staff‚Ä¶">
        <select id="staffSemSel"></select>
      </div>
      <div class="export-bar"><button class="btn btn-outline btn-sm" data-export="staff">Export CSV</button></div>
      <div class="tbl-wrap" id="staffTbl"></div>
    </div>

    <!-- By Module -->
    <div class="tab-pane" data-tab="module">
      <div class="filter-bar"><input type="text" id="modSearch" placeholder="Filter modules‚Ä¶"></div>
      <div class="export-bar"><button class="btn btn-outline btn-sm" data-export="module">Export CSV</button></div>
      <div class="tbl-wrap" id="moduleTbl"></div>
    </div>

    <!-- By Week -->
    <div class="tab-pane" data-tab="week">
      <div class="filter-bar"><select id="weekStaffSel"></select></div>
      <div class="export-bar"><button class="btn btn-outline btn-sm" data-export="week">Export CSV</button></div>
      <div class="tbl-wrap" id="weekTbl"></div>
    </div>

    <!-- By Semester -->
    <div class="tab-pane" data-tab="semester">
      <div class="export-bar"><button class="btn btn-outline btn-sm" data-export="semester">Export CSV</button></div>
      <div class="tbl-wrap" id="semesterTbl"></div>
    </div>

    <!-- Heatmap -->
    <div class="tab-pane" data-tab="heatmap">
      <div class="filter-bar">
        <label style="font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);">Show:</label>
        <select id="heatMetric">
          <option value="hours">Hours per week</option>
          <option value="sessions">Sessions per week</option>
        </select>
      </div>
      <div style="overflow-x:auto;padding-bottom:8px;" id="heatmapWrap"></div>
    </div>

    <!-- Clashes -->
    <div class="tab-pane" data-tab="clashes">
      <div class="filter-bar"><input type="text" id="clashSearch" placeholder="Filter by staff or module‚Ä¶"></div>
      <div class="export-bar"><button class="btn btn-outline btn-sm" data-export="clashes">Export CSV</button></div>
      <div class="tbl-wrap" id="clashTbl"></div>
    </div>

    <!-- Raw Data -->
    <div class="tab-pane" data-tab="raw">
      <div class="filter-bar"><input type="text" id="rawSearch" placeholder="Search all fields‚Ä¶"></div>
      <div class="export-bar"><button class="btn btn-outline btn-sm" data-export="raw">Export CSV</button></div>
      <div class="tbl-wrap" id="rawTbl"></div>
    </div>

  </div>
</main>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Everything inside DOMContentLoaded ‚Äî no top-level DOM calls
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIELD_KEYS = ['staff','module','date','startTime','endTime','duration','type','room','week','semester'];
const FIELD_LABELS = {staff:'Staff Name',module:'Module/Course',date:'Date',startTime:'Start Time',endTime:'End Time',duration:'Duration (hrs)',type:'Session Type',room:'Room',week:'Week Number',semester:'Semester'};
const HINTS = {
  staff:['staff','lecturer','tutor','teacher','instructor','name','faculty','convener'],
  module:['module','course','unit','subject','code','title','class'],
  date:['date','day'],
  startTime:['start','begin','from'],
  endTime:['end','finish','until'],
  duration:['duration','hours','hrs','length','mins'],
  type:['type','session','activity','kind','format'],
  room:['room','venue','location','building'],
  week:['week','wk'],
  semester:['semester','term','period','sem'],
};

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sources   = [];   // {id, name, icon, mappedRows}
let mapped    = [];   // flattened all sources
let pending   = {rawRows:[], columns:[], name:'', icon:'üìÑ'};
let clashInfo = {run:false, pairs:[], effHours:{}};
let sortState = {};   // {tableId: {col, dir}}
let drillIndex= {};   // key -> rows[]

// ‚îÄ‚îÄ BOOKMARKLET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BM_SRC = `(function(){
  var tables=Array.from(document.querySelectorAll('table')).filter(function(t){return t.rows.length>1;});
  if(!tables.length){alert('No tables found on this page.');return;}
  var sig=function(t){return Array.from(t.rows[0].cells).map(function(c){return (c.innerText||c.textContent||'').trim();}).join('|');};
  var counts={};
  tables.forEach(function(t){var s=sig(t);counts[s]=(counts[s]||0)+1;});
  var best=Object.keys(counts).sort(function(a,b){return counts[b]-counts[a]||b.split('|').length-a.split('|').length;})[0];
  var matching=tables.filter(function(t){return sig(t)===best;});
  var headers=best.split('|');
  var rows=[];
  matching.forEach(function(t){
    for(var i=1;i<t.rows.length;i++){
      var row={};
      Array.from(t.rows[i].cells).forEach(function(c,j){
        var cl=c.cloneNode(true);
        cl.querySelectorAll('br').forEach(function(b){b.replaceWith('\\x00');});
        row[headers[j]||'col'+j]=(cl.innerText||cl.textContent||'').trim();
      });
      if(Object.values(row).some(function(v){return v;}))rows.push(row);
    }
  });
  var out=JSON.stringify({type:'table',headers:headers,rows:rows});
  navigator.clipboard.writeText(out)
    .then(function(){alert('Scraped '+rows.length+' rows from '+matching.length+' table(s).\\nColumns: '+headers.join(', ')+'\\n\\nPaste into the analyser!');})
    .catch(function(){prompt('Copy this:',out);});
})();`;

const bmLink = document.getElementById('bmLink');
bmLink.href = 'javascript:' + encodeURIComponent(BM_SRC);

document.getElementById('copyBmBtn').addEventListener('click', () => {
  navigator.clipboard.writeText('javascript:' + encodeURIComponent(BM_SRC)).then(() => {
    const b = document.getElementById('copyBmBtn');
    b.textContent = 'Copied!';
    setTimeout(() => b.textContent = 'Copy bookmarklet code', 2000);
  });
});

// ‚îÄ‚îÄ IMPORT METHOD TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.method-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const method = tab.dataset.method;
    document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.method-pane').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.querySelector(`.method-pane[data-pane="${method}"]`).classList.add('active');
  });
});

// ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const dropzone  = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');

dropzone.addEventListener('dragover',  e => { e.preventDefault(); dropzone.classList.add('over'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('over'));
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('over');
  const f = e.dataTransfer.files[0];
  if (f) loadFile(f);
});
fileInput.addEventListener('change', function() {
  if (this.files[0]) { loadFile(this.files[0]); this.value = ''; }
});

function loadFile(file) {
  pending.name = file.name;
  pending.icon = file.name.match(/\.csv$/i) ? 'üìä' : 'üìÑ';
  const reader = new FileReader();
  reader.onload = e => {
    if (file.name.match(/\.csv$/i)) parseCSV(e.target.result);
    else parseHTML(e.target.result);
  };
  reader.readAsText(file);
}

// ‚îÄ‚îÄ PASTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('parsePasteBtn').addEventListener('click', doPaste);

function doPaste() {
  const text = document.getElementById('pasteArea').value.trim();
  if (!text) { setStatus('err', 'Nothing pasted.'); return; }
  pending.name = 'Pasted data ' + (sources.length + 1);
  pending.icon = 'üìã';
  // Try JSON (bookmarklet output)
  try {
    const obj = JSON.parse(text);
    if (obj.type === 'table' && obj.rows) {
      pending.columns = obj.headers;
      pending.rawRows = obj.rows;
      setStatus('ok', `Scraped data: ${obj.rows.length} rows, ${obj.headers.length} columns`);
      showMapping();
      return;
    }
  } catch(e) {}
  // Try CSV/TSV
  const sep = text.includes('\t') ? '\t' : ',';
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length >= 2) {
    const headers = lines[0].split(sep).map(h => h.trim().replace(/^"|"$/g,''));
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const vals = lines[i].split(sep).map(v => v.trim().replace(/^"|"$/g,''));
      const row = {};
      headers.forEach((h,j) => row[h] = vals[j] || '');
      if (Object.values(row).some(v=>v)) rows.push(row);
    }
    pending.columns = headers;
    pending.rawRows = rows;
    setStatus('ok', `Parsed ${rows.length} rows from pasted text`);
    showMapping();
    return;
  }
  setStatus('err', 'Could not parse pasted data. Expected JSON from bookmarklet or CSV text.');
}

// ‚îÄ‚îÄ CLEAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function clearAll() {
  sources = []; mapped = [];
  pending = {rawRows:[], columns:[], name:'', icon:'üìÑ'};
  clashInfo = {run:false, pairs:[], effHours:{}};
  sortState = {};
  document.getElementById('pasteArea').value = '';
  document.getElementById('sourcesWrap').style.display = 'none';
  document.getElementById('sourcesList').innerHTML = '';
  document.getElementById('results').style.display = 'none';
  document.getElementById('mappingPanel').classList.remove('show');
  setStatus('', 'No data loaded. Upload a file or paste scraped data to begin.');
}
document.getElementById('clearAllBtn').addEventListener('click', clearAll);
document.getElementById('clearAllBtn2').addEventListener('click', clearAll);

// ‚îÄ‚îÄ HTML PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseHTML(html) {
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const tables = Array.from(doc.querySelectorAll('table')).filter(t => t.rows.length > 1);
  if (!tables.length) { setStatus('err', 'No tables found in HTML file.'); return; }

  const sig = t => Array.from(t.rows[0].cells).map(c => (c.innerText||c.textContent||'').trim()).join('|');
  const counts = {};
  tables.forEach(t => { const s = sig(t); counts[s] = (counts[s]||0) + 1; });
  const best = Object.keys(counts).sort((a,b) => counts[b]-counts[a] || b.split('|').length-a.split('|').length)[0];
  const matching = tables.filter(t => sig(t) === best);
  const headers = best.split('|');

  const DELIM = '\x00';
  const rows = [];
  let expanded = 0;

  matching.forEach(t => {
    for (let i = 1; i < t.rows.length; i++) {
      const cellVals = Array.from(t.rows[i].cells).map(c => {
        const cl = c.cloneNode(true);
        cl.querySelectorAll('br').forEach(br => br.replaceWith(DELIM));
        return (cl.innerText || cl.textContent || '').trim();
      });
      const split = cellVals.map(v => v.split(DELIM).map(s=>s.trim()).filter(Boolean));
      const maxSplit = Math.max(...split.map(s=>s.length));
      if (maxSplit <= 1) {
        const row = {};
        headers.forEach((h,j) => row[h||'col'+j] = (split[j]&&split[j][0]) || '');
        if (Object.values(row).some(v=>v)) rows.push(row);
      } else {
        expanded += maxSplit - 1;
        for (let k = 0; k < maxSplit; k++) {
          const row = {};
          headers.forEach((h,j) => {
            const p = split[j];
            row[h||'col'+j] = p.length > 1 ? (p[k]!==undefined ? p[k] : p[p.length-1]) : (p[0]||'');
          });
          if (Object.values(row).some(v=>v)) rows.push(row);
        }
      }
    }
  });

  if (!rows.length) { setStatus('err', 'Tables found but no data rows extracted.'); return; }
  const skip = tables.length - matching.length;
  pending.columns = headers;
  pending.rawRows = rows;
  setStatus('ok', `Merged ${matching.length} table(s) ‚Üí ${rows.length} rows${skip ? ` ¬∑ ${skip} non-matching ignored` : ''}${expanded ? ` ¬∑ ${expanded} multi-staff rows expanded` : ''}`);
  showMapping();
}

// ‚îÄ‚îÄ CSV PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if (lines.length < 2) { setStatus('err', 'CSV appears empty.'); return; }
  const headers = csvLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = csvLine(lines[i]);
    const row = {};
    headers.forEach((h,j) => row[h] = vals[j]||'');
    if (Object.values(row).some(v=>v)) rows.push(row);
  }
  pending.columns = headers;
  pending.rawRows = rows;
  setStatus('ok', `Loaded ${rows.length} rows from CSV`);
  showMapping();
}
function csvLine(line) {
  const r=[]; let cur='', inQ=false;
  for (let i=0;i<line.length;i++) {
    const c=line[i];
    if (c==='"') inQ=!inQ;
    else if (c===',' && !inQ) { r.push(cur.trim()); cur=''; }
    else cur+=c;
  }
  r.push(cur.trim());
  return r;
}

// ‚îÄ‚îÄ COLUMN MAPPING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showMapping() {
  const grid = document.getElementById('mapGrid');
  grid.innerHTML = '';
  FIELD_KEYS.forEach(key => {
    const div = document.createElement('div');
    div.className = 'map-field';
    const lbl = document.createElement('label');
    lbl.textContent = FIELD_LABELS[key];
    const sel = document.createElement('select');
    sel.id = 'mapSel_' + key;
    sel.innerHTML = '<option value="">‚Äî skip ‚Äî</option>';
    pending.columns.forEach(col => {
      const opt = document.createElement('option');
      opt.value = col; opt.textContent = col;
      sel.appendChild(opt);
    });
    const match = pending.columns.find(c => HINTS[key].some(h => c.toLowerCase().includes(h)));
    if (match) sel.value = match;
    div.appendChild(lbl); div.appendChild(sel);
    grid.appendChild(div);
  });
  document.getElementById('mappingPanel').classList.add('show');
}

document.getElementById('applyMappingBtn').addEventListener('click', applyMapping);
document.getElementById('cancelMappingBtn').addEventListener('click', () => {
  document.getElementById('mappingPanel').classList.remove('show');
  pending = {rawRows:[], columns:[], name:'', icon:'üìÑ'};
});

function applyMapping() {
  const mapping = {};
  FIELD_KEYS.forEach(key => {
    const sel = document.getElementById('mapSel_' + key);
    if (sel && sel.value) mapping[key] = sel.value;
  });
  if (!mapping.staff && !mapping.module) { alert('Please map at least Staff or Module.'); return; }

  const newRows = pending.rawRows.map(row => {
    const r = {};
    FIELD_KEYS.forEach(k => r[k] = mapping[k] ? (row[mapping[k]]||'') : '');
    if (!r.duration && r.startTime && r.endTime) r.duration = calcDuration(r.startTime, r.endTime);
    if (!r.duration) r.duration = 1;
    else r.duration = parseFloat(r.duration) || 1;
    if (!r.week && r.date) r.week = dateToWeek(r.date);
    if (!r.semester && r.week) r.semester = weekToSem(+r.week);
    return r;
  }).filter(r => r.staff || r.module);

  sources.push({ id: Date.now(), name: pending.name, icon: pending.icon, mappedRows: newRows });
  rebuildMapped();
  pending = {rawRows:[], columns:[], name:'', icon:'üìÑ'};
  document.getElementById('mappingPanel').classList.remove('show');
  document.getElementById('pasteArea').value = '';
  renderSources();
  buildResults();
}

function rebuildMapped() {
  mapped = sources.flatMap(s => s.mappedRows);
}

// ‚îÄ‚îÄ SOURCES LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSources() {
  const wrap = document.getElementById('sourcesWrap');
  const list = document.getElementById('sourcesList');
  if (!sources.length) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'block';
  document.getElementById('sourcesTotal').textContent = `${mapped.length} rows total`;
  list.innerHTML = sources.map(s => {
    const sems = [...new Set(s.mappedRows.map(r=>r.semester).filter(Boolean))].join(', ') || 'no semester detected';
    return `<div class="src-item">
      <span style="font-size:1.1rem">${s.icon}</span>
      <div style="flex:1;min-width:0">
        <div class="src-name">${s.name}</div>
        <div class="src-meta">${s.mappedRows.length} rows ¬∑ ${sems}</div>
      </div>
      <button class="src-remove" data-srcid="${s.id}" title="Remove">‚úï</button>
    </div>`;
  }).join('');
  list.querySelectorAll('.src-remove').forEach(btn => {
    btn.addEventListener('click', () => removeSource(+btn.dataset.srcid));
  });
}

function removeSource(id) {
  sources = sources.filter(s => s.id !== id);
  if (!sources.length) { clearAll(); return; }
  rebuildMapped();
  renderSources();
  buildResults();
  setStatus('ok', `${sources.length} source(s) ¬∑ ${mapped.length} rows total`);
}

// ‚îÄ‚îÄ TIME HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toMins(s) {
  if (!s) return null;
  const ampm = s.match(/(\d+)(?::(\d+))?\s*(am|pm)/i);
  if (ampm) {
    let h=+ampm[1], m=+(ampm[2]||0);
    if (ampm[3].toLowerCase()==='pm' && h!==12) h+=12;
    if (ampm[3].toLowerCase()==='am' && h===12) h=0;
    return h*60+m;
  }
  const hm = s.match(/(\d+):(\d+)/);
  return hm ? +hm[1]*60 + +hm[2] : null;
}
function calcDuration(st, en) {
  const s=toMins(st), e=toMins(en);
  if (s===null||e===null) return 1;
  return Math.max(0.5, (e-s)/60);
}
function toAbsInterval(row) {
  let dayOffset = 0;
  if (row.date) {
    try { const d=new Date(row.date); if(!isNaN(d)) dayOffset=Math.floor(d.getTime()/86400000)*1440; } catch(e){}
  }
  const s = toMins(row.startTime);
  if (s===null) return null;
  let e = toMins(row.endTime);
  if (e===null) e = s + Math.round((row.duration||1)*60);
  return [dayOffset+s, dayOffset+e];
}
function mergeIntervals(ivs) {
  if (!ivs.length) return 0;
  ivs.sort((a,b)=>a[0]-b[0]);
  const m=[ivs[0]];
  for (let i=1;i<ivs.length;i++) {
    const last=m[m.length-1];
    if (ivs[i][0]<last[1]) last[1]=Math.max(last[1],ivs[i][1]);
    else m.push(ivs[i]);
  }
  return m.reduce((s,[a,b])=>s+(b-a),0)/60;
}
function dateToWeek(ds) {
  try { const d=new Date(ds); if(isNaN(d)) return ''; const j=new Date(d.getFullYear(),0,1); return Math.ceil(((d-j)/86400000+j.getDay()+1)/7); } catch(e){ return ''; }
}
function weekToSem(w) {
  if (!w) return 'Unknown';
  if (w<=20) return 'Semester 1';
  if (w<=40) return 'Semester 2';
  return 'Summer';
}

// ‚îÄ‚îÄ BUILD RESULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildResults() {
  clashInfo = {run:false, pairs:[], effHours:{}};
  const cb = document.getElementById('clashBtn');
  cb.textContent = '‚ö° Detect Clashes';
  cb.className = 'btn btn-danger';
  document.getElementById('clashSummary').textContent = '';
  document.getElementById('clashesTabBtn').style.display = 'none';
  mapped.forEach(r => { r._clash=false; r._clashWith=''; });

  document.getElementById('results').style.display = 'block';
  if (sources.length > 1) setStatus('ok', `${sources.length} sources ¬∑ ${mapped.length} rows total`);
  buildKPIs();
  populateFilters();
  renderAllTables();
}

function buildKPIs() {
  const totalHrs = mapped.reduce((s,r)=>s+r.duration,0);
  const staff   = new Set(mapped.map(r=>r.staff).filter(Boolean));
  const mods    = new Set(mapped.map(r=>r.module).filter(Boolean));
  const weeks   = new Set(mapped.map(r=>r.week).filter(Boolean));
  const sems    = new Set(mapped.map(r=>r.semester).filter(Boolean));
  const clashN  = clashInfo.run ? mapped.filter(r=>r._clash).length : null;
  const effHrs  = clashInfo.run ? Object.values(clashInfo.effHours).reduce((s,h)=>s+h,0) : null;

  const kpis = [
    [mapped.length,'Sessions',''],
    [totalHrs.toFixed(1),'Total Hours',''],
    [staff.size,'Staff',''],
    [mods.size,'Modules',''],
    [weeks.size,'Weeks',''],
    [sems.size,'Semesters',''],
  ];
  if (clashInfo.run) {
    kpis.push([clashN,'Clashing Sessions','clash']);
    kpis.push([effHrs.toFixed(1),'Effective Hours','']);
  }
  document.getElementById('kpiRow').innerHTML = kpis.map(([v,l,cls])=>
    `<div class="kpi ${cls}"><div class="kpi-val">${v}</div><div class="kpi-lbl">${l}</div></div>`
  ).join('');
}

function populateFilters() {
  const sems  = ['', ...new Set(mapped.map(r=>r.semester).filter(Boolean))].sort();
  const staff = ['', ...new Set(mapped.map(r=>r.staff).filter(Boolean))].sort();
  const semSel = document.getElementById('staffSemSel');
  semSel.innerHTML = sems.map(s=>`<option value="${s}">${s||'All Semesters'}</option>`).join('');
  const wkSel = document.getElementById('weekStaffSel');
  wkSel.innerHTML = staff.map(s=>`<option value="${s}">${s||'All Staff'}</option>`).join('');
}

function renderAllTables() {
  renderStaff(); renderModule(); renderWeek(); renderSemester(); renderHeatmap(); renderClashes(); renderRaw();
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.querySelector(`.tab-pane[data-tab="${btn.dataset.tab}"]`).classList.add('active');
  });
});

function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  const btn = document.querySelector(`.tab-btn[data-tab="${name}"]`);
  if (btn) btn.classList.add('active');
  const pane = document.querySelector(`.tab-pane[data-tab="${name}"]`);
  if (pane) pane.classList.add('active');
}

// ‚îÄ‚îÄ RENDER HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTable(containerId, rows, cols, cellFn, rowClassFn, limit) {
  const el = document.getElementById(containerId);
  if (!rows.length) { el.innerHTML='<div class="empty"><div class="empty-icon">üîç</div><p>No data to display.</p></div>'; return; }

  const st = sortState[containerId] || {col:null, dir:-1};
  if (st.col) {
    rows = [...rows].sort((a,b) => {
      const av = isNaN(a[st.col]) ? (a[st.col]||'') : +a[st.col];
      const bv = isNaN(b[st.col]) ? (b[st.col]||'') : +b[st.col];
      return av > bv ? st.dir : av < bv ? -st.dir : 0;
    });
  }

  const display = limit ? rows.slice(0,limit) : rows;
  const thead = '<thead><tr>' + cols.map(([k,l])=>{
    let cls = st.col===k ? (st.dir===1?'asc':'desc') : '';
    return `<th class="${cls}" data-sort="${k}" data-tbl="${containerId}">${l}</th>`;
  }).join('') + '</tr></thead>';

  const tbody = '<tbody>' + display.map(row=>{
    const cls = [rowClassFn?rowClassFn(row):'', row._drillKey?'clickable':''].filter(Boolean).join(' ');
    const click = row._drillKey ? `data-drill="${encodeURIComponent(row._drillKey)}" data-dlabel="${row._drillLabel||''}"` : '';
    return `<tr class="${cls}" ${click}>${cols.map(([k])=>`<td>${cellFn?cellFn(row,k):(row[k]??'')}</td>`).join('')}</tr>`;
  }).join('') +
  (limit && rows.length>limit ? `<tr><td colspan="${cols.length}" style="text-align:center;color:var(--muted);font-family:'DM Mono',monospace;font-size:.72rem;padding:14px;">‚Ä¶and ${rows.length-limit} more rows</td></tr>` : '') +
  '</tbody>';

  el.innerHTML = '<table>' + thead + tbody + '</table>';
}

// Sort click delegation
document.addEventListener('click', e => {
  const th = e.target.closest('th[data-sort]');
  if (!th) return;
  const tbl = th.dataset.tbl, col = th.dataset.sort;
  const st = sortState[tbl] || {col:null, dir:-1};
  sortState[tbl] = {col, dir: st.col===col ? -st.dir : -1};
  rerender(tbl);
});

// Drill-down click delegation
document.addEventListener('click', e => {
  const tr = e.target.closest('tr[data-drill]');
  if (!tr) return;
  const key = decodeURIComponent(tr.dataset.drill);
  const label = tr.dataset.dlabel;
  openDrawer(label, key, drillIndex[key]||[]);
});

function rerender(tbl) {
  const map = {staffTbl:renderStaff, moduleTbl:renderModule, weekTbl:renderWeek, semesterTbl:renderSemester, clashTbl:renderClashes, rawTbl:renderRaw};
  if (map[tbl]) map[tbl]();
}

function miniBar(val, max) {
  const pct = max > 0 ? (val/max*100).toFixed(1) : 0;
  return `${val.toFixed(1)}<span class="mini-bar"><span class="mini-bar-fill" style="width:${pct}%"></span></span>`;
}

// ‚îÄ‚îÄ BY STAFF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStaff() {
  const filt = document.getElementById('staffSearch').value.toLowerCase();
  const sem  = document.getElementById('staffSemSel').value;
  const agg  = {};
  mapped.forEach(r => {
    if (!r.staff) return;
    if (filt && !r.staff.toLowerCase().includes(filt)) return;
    if (sem && r.semester !== sem) return;
    if (!agg[r.staff]) agg[r.staff] = {hours:0, sessions:0, clashes:0, mods:new Set(), sems:new Set()};
    agg[r.staff].hours += r.duration;
    agg[r.staff].sessions++;
    if (r._clash) agg[r.staff].clashes++;
    if (r.module) agg[r.staff].mods.add(r.module);
    if (r.semester) agg[r.staff].sems.add(r.semester);
    drillIndex[r.staff] = drillIndex[r.staff] || [];
  });
  // rebuild drill index
  drillIndex = {};
  mapped.forEach(r => {
    if (r.staff) { if(!drillIndex[r.staff]) drillIndex[r.staff]=[]; drillIndex[r.staff].push(r); }
    if (r.module) { if(!drillIndex['mod:'+r.module]) drillIndex['mod:'+r.module]=[]; drillIndex['mod:'+r.module].push(r); }
    const wk = 'wk:'+r.week; if (r.week) { if(!drillIndex[wk]) drillIndex[wk]=[]; drillIndex[wk].push(r); }
    const sm = 'sem:'+r.semester; if (r.semester) { if(!drillIndex[sm]) drillIndex[sm]=[]; drillIndex[sm].push(r); }
    // Heatmap drill: staff|wk<week> -> rows for that staff member that week
    if (r.staff && r.week) {
      const hwk = r.staff+'|wk'+r.week;
      if (!drillIndex[hwk]) drillIndex[hwk]=[];
      drillIndex[hwk].push(r);
    }
  });
  window._drillIndex = drillIndex;

  const rows = Object.entries(agg).map(([name,d]) => ({
    name, hours:d.hours, sessions:d.sessions, clashes:d.clashes,
    effHours: clashInfo.run ? (clashInfo.effHours[name]||d.hours) : null,
    mods:d.mods.size, sems:[...d.sems].join(', '),
    _drillKey: name, _drillLabel: 'Staff Member'
  }));
  const maxH = Math.max(...rows.map(r=>r.hours), 1);
  const showClash = clashInfo.run;

  const cols = [['name','Staff'],['hours', showClash?'Raw Hours':'Hours']];
  if (showClash) cols.push(['effHours','Effective Hours'],['clashes','Clashes']);
  cols.push(['sessions','Sessions'],['mods','Modules'],['sems','Semesters']);

  renderTable('staffTbl', rows, cols, (row,k) => {
    if (k==='hours') return miniBar(row.hours, maxH);
    if (k==='effHours') {
      const eff = row.effHours??row.hours;
      const diff = row.hours - eff;
      return `<strong>${eff.toFixed(1)}</strong>${diff>0.01?` <span style="color:var(--red);font-size:.75rem">(-${diff.toFixed(1)})</span>`:''}`;
    }
    if (k==='clashes') return row.clashes>0 ? `<span class="badge badge-red">${row.clashes}</span>` : `<span class="badge badge-ok">0</span>`;
    if (k==='sessions') return `<span class="badge badge-green">${row.sessions}</span>`;
    return row[k]??'';
  });
}
document.getElementById('staffSearch').addEventListener('input', renderStaff);
document.getElementById('staffSemSel').addEventListener('change', renderStaff);

// ‚îÄ‚îÄ BY MODULE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderModule() {
  const filt = document.getElementById('modSearch').value.toLowerCase();
  const agg = {};
  mapped.forEach(r => {
    if (!r.module) return;
    if (filt && !r.module.toLowerCase().includes(filt)) return;
    if (!agg[r.module]) agg[r.module] = {hours:0, sessions:0, staff:new Set(), weeks:new Set()};
    agg[r.module].hours += r.duration;
    agg[r.module].sessions++;
    if (r.staff) agg[r.module].staff.add(r.staff);
    if (r.week)  agg[r.module].weeks.add(r.week);
  });
  const rows = Object.entries(agg).map(([mod,d])=>({
    module:mod, hours:d.hours, sessions:d.sessions, staffN:d.staff.size, weeksN:d.weeks.size,
    _drillKey:'mod:'+mod, _drillLabel:'Module'
  }));
  const maxH = Math.max(...rows.map(r=>r.hours),1);
  renderTable('moduleTbl', rows,
    [['module','Module'],['hours','Total Hours'],['sessions','Sessions'],['staffN','Staff'],['weeksN','Weeks Active']],
    (row,k) => {
      if (k==='hours') return miniBar(row.hours, maxH);
      if (k==='sessions') return `<span class="badge badge-gold">${row.sessions}</span>`;
      return row[k]??'';
    }
  );
}
document.getElementById('modSearch').addEventListener('input', renderModule);

// ‚îÄ‚îÄ BY WEEK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWeek() {
  const staffF = document.getElementById('weekStaffSel').value;
  const agg = {};
  mapped.forEach(r => {
    if (!r.week) return;
    if (staffF && r.staff !== staffF) return;
    if (!agg[r.week]) agg[r.week] = {hours:0, sessions:0, staff:new Set(), mods:new Set()};
    agg[r.week].hours += r.duration;
    agg[r.week].sessions++;
    if (r.staff) agg[r.week].staff.add(r.staff);
    if (r.module) agg[r.week].mods.add(r.module);
  });
  const rows = Object.entries(agg).sort((a,b)=>+a[0]-(+b[0])).map(([wk,d])=>({
    week:wk, hours:d.hours, sessions:d.sessions, staffN:d.staff.size, modsN:d.mods.size,
    _drillKey:'wk:'+wk, _drillLabel:'Week'
  }));
  const maxH = Math.max(...rows.map(r=>r.hours),1);
  renderTable('weekTbl', rows,
    [['week','Week'],['hours','Hours'],['sessions','Sessions'],['staffN','Staff Active'],['modsN','Modules']],
    (row,k) => {
      if (k==='hours') return miniBar(row.hours, maxH);
      if (k==='sessions') return `<span class="badge badge-navy">${row.sessions}</span>`;
      return row[k]??'';
    }
  );
}
document.getElementById('weekStaffSel').addEventListener('change', renderWeek);

// ‚îÄ‚îÄ BY SEMESTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSemester() {
  const agg = {};
  mapped.forEach(r => {
    const s = r.semester||'Unknown';
    if (!agg[s]) agg[s] = {hours:0, sessions:0, staff:new Set(), mods:new Set()};
    agg[s].hours += r.duration; agg[s].sessions++;
    if (r.staff)   agg[s].staff.add(r.staff);
    if (r.module)  agg[s].mods.add(r.module);
  });
  const rows = Object.entries(agg).map(([sem,d])=>({
    semester:sem, hours:d.hours, sessions:d.sessions, staffN:d.staff.size, modsN:d.mods.size,
    avgPerStaff: d.staff.size ? (d.hours/d.staff.size).toFixed(1) : '‚Äî',
    _drillKey:'sem:'+sem, _drillLabel:'Semester'
  }));
  renderTable('semesterTbl', rows,
    [['semester','Semester'],['hours','Total Hours'],['sessions','Sessions'],['staffN','Staff'],['modsN','Modules'],['avgPerStaff','Avg Hrs/Staff']],
    (row,k) => {
      if (k==='sessions') return `<span class="badge badge-green">${row.sessions}</span>`;
      if (k==='hours') return `<strong>${(+row.hours).toFixed(1)}</strong>`;
      return row[k]??'';
    }
  );
}

// ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHeatmap() {
  const metric = document.getElementById('heatMetric').value;
  const staffList = [...new Set(mapped.map(r=>r.staff).filter(Boolean))].sort();
  const weekList  = [...new Set(mapped.map(r=>r.week).filter(Boolean))].sort((a,b)=>+a-+b);
  const wrap = document.getElementById('heatmapWrap');

  if (!staffList.length || !weekList.length) {
    wrap.innerHTML = '<div class="empty"><div class="empty-icon">üìä</div><p>Need staff and week data for heatmap.</p></div>';
    return;
  }

  const grid = {};
  mapped.forEach(r => {
    if (!r.staff||!r.week) return;
    const k = r.staff+'|'+r.week;
    if (!grid[k]) grid[k]={hours:0,sessions:0};
    grid[k].hours += r.duration; grid[k].sessions++;
  });

  const vals = Object.values(grid).map(v => metric==='hours'?v.hours:v.sessions);
  const maxV = Math.max(...vals, 1);

  function heatColour(v, max) {
    if (!v) return 'rgba(16,38,59,.06)';
    const t = v/max;
    const r = Math.round(16 + (222-16)*t);
    const g = Math.round(38 + (180-38)*t*0.5);
    const b = Math.round(59 + (6-59)*t);
    return `rgb(${r},${g},${b})`;
  }

  const colHdr = '<div class="heatmap-row"><div class="heatmap-label"></div>' +
    weekList.map(w=>`<div class="heatmap-col-header">W${w}</div>`).join('') + '</div>';

  const rowsHtml = staffList.map(staff =>
    '<div class="heatmap-row"><div class="heatmap-label" title="'+staff+'">'+staff+'</div>' +
    weekList.map(wk => {
      const k = staff+'|'+wk;
      const v = grid[k] ? (metric==='hours'?grid[k].hours:grid[k].sessions) : 0;
      const bg = heatColour(v, maxV);
      const textCol = v/maxV > 0.5 ? 'rgba(255,255,255,.9)' : 'rgba(16,38,59,.8)';
      const lbl = v > 0 ? (metric==='hours'?v.toFixed(1):v) : '';
      const clickable = v > 0 ? `onclick="openDrawer('Staff Member','${staff.replace(/'/g,"\\'")}',(window._drillIndex||{})['${staff.replace(/'/g,"\\'")}'+'|wk'+'${wk}']||[])" style="cursor:pointer;"` : '';
      return `<div class="heatmap-cell" ${clickable} style="background:${bg};color:${textCol}" title="${staff} ¬∑ Wk${wk}: ${v>0?(metric==='hours'?v.toFixed(1)+' hrs':v+' sessions'):'none ‚Äì click to drill down'}">${lbl}</div>`;
    }).join('') + '</div>'
  ).join('');

  wrap.innerHTML = '<div class="heatmap-grid">' + colHdr + rowsHtml + '</div>';
}
document.getElementById('heatMetric').addEventListener('change', renderHeatmap);

// ‚îÄ‚îÄ CLASHES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderClashes() {
  const filt = document.getElementById('clashSearch').value.toLowerCase();
  let pairs = clashInfo.pairs;
  if (filt) pairs = pairs.filter(p => p.staff.toLowerCase().includes(filt) || (p.modA||'').toLowerCase().includes(filt) || (p.modB||'').toLowerCase().includes(filt));
  if (!pairs.length) {
    document.getElementById('clashTbl').innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div><p>No clashes found.</p></div>';
    return;
  }
  renderTable('clashTbl', pairs,
    [['staff','Staff'],['date','Date'],['timeA','Session A'],['modA','Module A'],['timeB','Session B'],['modB','Module B'],['mins','Overlap (mins)']],
    (row,k) => {
      if (k==='mins') return `<span class="badge badge-red">${row[k]} min${row[k]!==1?'s':''}</span>`;
      if (k==='staff') return `<strong>${row[k]}</strong>`;
      return row[k]||'‚Äî';
    }
  );
}
document.getElementById('clashSearch').addEventListener('input', renderClashes);

// ‚îÄ‚îÄ RAW DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRaw() {
  const filt = document.getElementById('rawSearch').value.toLowerCase();
  const rows = filt ? mapped.filter(r => Object.values(r).some(v=>String(v).toLowerCase().includes(filt))) : mapped;
  const cols = FIELD_KEYS.filter(k => rows.some(r=>r[k]));
  renderTable('rawTbl', rows, cols.map(k=>[k,FIELD_LABELS[k]]),
    (row,k) => {
      let v = row[k]??'';
      if (k==='staff' && row._clash) return `${v}<span class="clash-pill" title="${row._clashWith||'Overlaps with another session'}">‚ö† clash</span>`;
      return v;
    },
    row => row._clash ? 'clash-row' : '',
    200
  );
}
document.getElementById('rawSearch').addEventListener('input', renderRaw);

// ‚îÄ‚îÄ CLASH DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('clashBtn').addEventListener('click', () => {
  if (!mapped.some(r => r.startTime||r.endTime)) {
    alert('Clash detection needs Start Time and/or End Time columns mapped.');
    return;
  }
  const btn = document.getElementById('clashBtn');
  btn.textContent = '‚è≥ Working‚Ä¶';
  btn.className = 'btn btn-working';
  btn.disabled = true;
  document.getElementById('clashSummary').textContent = 'Analysing‚Ä¶';

  setTimeout(() => {
    mapped.forEach(r => { r._clash=false; r._clashWith=''; });

    const byStaff = {};
    mapped.forEach((r,i) => {
      if (!r.staff) return;
      if (!byStaff[r.staff]) byStaff[r.staff] = [];
      byStaff[r.staff].push({row:r, i, iv:toAbsInterval(r)});
    });

    const pairs = [];
    const effHours = {};

    Object.entries(byStaff).forEach(([staff, sessions]) => {
      const ivs = sessions.map(s=>s.iv).filter(Boolean);
      effHours[staff] = ivs.length ? mergeIntervals(ivs) : sessions.reduce((s,x)=>s+(x.row.duration||1),0);
      for (let a=0; a<sessions.length; a++) {
        for (let b=a+1; b<sessions.length; b++) {
          const sa=sessions[a], sb=sessions[b];
          if (!sa.iv||!sb.iv) continue;
          const os = Math.max(sa.iv[0],sb.iv[0]);
          const oe = Math.min(sa.iv[1],sb.iv[1]);
          if (oe > os) {
            const mins = Math.round(oe-os);
            const dA = `${sa.row.startTime||'?'}‚Äì${sa.row.endTime||'?'} ${sa.row.module||''}`.trim();
            const dB = `${sb.row.startTime||'?'}‚Äì${sb.row.endTime||'?'} ${sb.row.module||''}`.trim();
            sa.row._clash=true; sa.row._clashWith='Clashes with: '+dB;
            sb.row._clash=true; sb.row._clashWith='Clashes with: '+dA;
            pairs.push({
              staff,
              date: sa.row.date||(sa.row.week?'Wk '+sa.row.week:'‚Äî'),
              timeA:`${sa.row.startTime||'?'}‚Äì${sa.row.endTime||'?'}`,
              modA: sa.row.module||'‚Äî',
              timeB:`${sb.row.startTime||'?'}‚Äì${sb.row.endTime||'?'}`,
              modB: sb.row.module||'‚Äî',
              mins
            });
          }
        }
      }
    });

    clashInfo = {run:true, pairs, effHours};

    btn.disabled = false;
    btn.className = pairs.length ? 'btn btn-danger done' : 'btn btn-primary';
    btn.textContent = `‚ö° ${pairs.length} Clash${pairs.length!==1?'es':''} Found`;

    const clashTab = document.getElementById('clashesTabBtn');
    clashTab.style.display = '';
    document.getElementById('clashSummary').textContent = pairs.length===0
      ? 'No simultaneous sessions detected.'
      : `${pairs.length} overlap${pairs.length!==1?'s':''} across ${new Set(pairs.map(p=>p.staff)).size} staff member(s).`;

    buildKPIs();
    renderStaff();
    renderRaw();
    renderClashes();
    if (pairs.length) switchTab('clashes');
  }, 50);
});

// ‚îÄ‚îÄ DRILL-DOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDrawer(label, title, sessions) {
  document.getElementById('ddLabel').textContent = label;
  document.getElementById('ddTitle').textContent = title;

  const hrs   = sessions.reduce((s,r)=>s+r.duration,0);
  const staff = new Set(sessions.map(r=>r.staff).filter(Boolean));
  const mods  = new Set(sessions.map(r=>r.module).filter(Boolean));
  const clN   = sessions.filter(r=>r._clash).length;

  const stats = [[sessions.length,'Sessions'],[hrs.toFixed(1),'Hours'],[mods.size>1?mods.size:staff.size, mods.size>1?'Modules':'Staff']];
  if (clashInfo.run) stats.push([clN,'Clashes']);
  document.getElementById('ddStats').innerHTML = stats.map(([v,l])=>
    `<div class="dd-stat"><div class="dd-stat-val">${v}</div><div class="dd-stat-lbl">${l}</div></div>`
  ).join('');

  // Helper: get day-of-week from a row (from date field, or fall back to a 'day' hint in existing fields)
  const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  function getDayOfWeek(r) {
    if (r.date) {
      const d = new Date(r.date);
      if (!isNaN(d)) return DAYS[d.getDay()];
    }
    // Some timetables store day name directly in date or a separate field
    for (const val of Object.values(r)) {
      const s = String(val||'').trim();
      const found = DAYS.find(day => s.toLowerCase().startsWith(day.toLowerCase()));
      if (found) return found;
    }
    return null;
  }

  // Group by week, then sub-group by day
  const grouped = {};
  sessions.forEach(r => {
    const g = r.week ? `Week ${r.week}` : (r.date || r.semester || 'Unscheduled');
    if (!grouped[g]) grouped[g] = [];
    grouped[g].push(r);
  });
  const grpKeys = Object.keys(grouped).sort((a,b) => {
    const na=+(a.replace(/\D/g,'')), nb=+(b.replace(/\D/g,''));
    return (!isNaN(na)&&!isNaN(nb)) ? na-nb : a.localeCompare(b);
  });

  // Day sort order
  const DAY_ORDER = {Monday:0,Tuesday:1,Wednesday:2,Thursday:3,Friday:4,Saturday:5,Sunday:6};

  let html = '';
  grpKeys.forEach(grp => {
    const allSess = grouped[grp];
    const totalHrs = allSess.reduce((s,r)=>s+(r.duration||1),0);
    html += `<div class="dd-group-hdr">${grp} <span style="opacity:.6;font-weight:400">‚Äî ${allSess.length} session${allSess.length!==1?'s':''} ¬∑ ${totalHrs.toFixed(1)}h</span></div>`;

    // Sub-group by day of week if available
    const byDay = {};
    let hasDays = false;
    allSess.forEach(r => {
      const day = getDayOfWeek(r);
      if (day) hasDays = true;
      const key = day || '__none__';
      if (!byDay[key]) byDay[key] = [];
      byDay[key].push(r);
    });

    if (hasDays) {
      // Sort day groups in Mon‚ÄìSun order
      const dayKeys = Object.keys(byDay).sort((a,b) => {
        const oa = DAY_ORDER[a]??99, ob = DAY_ORDER[b]??99;
        return oa - ob;
      });
      dayKeys.forEach(day => {
        const daySess = byDay[day].slice().sort((a,b)=>(a.startTime||'').localeCompare(b.startTime||''));
        if (day !== '__none__') {
          html += `<div style="padding:7px 20px 4px;font-family:'DM Mono',monospace;font-size:.62rem;text-transform:uppercase;letter-spacing:.1em;color:var(--navy);background:rgba(16,38,59,.04);border-bottom:1px solid var(--border);">üìÖ ${day}</div>`;
        }
        daySess.forEach(r => {
          const time = r.startTime ? `${r.startTime}${r.endTime?'‚Äì'+r.endTime:''}` : '‚Äî';
          const meta = [r.type, r.room].filter(Boolean).join(' ¬∑ ');
          const who  = label==='Staff Member' ? (r.module||'‚Äî') : (r.staff||'‚Äî');
          const secondary = label==='Staff Member' ? '' : `<div class="dd-meta">${r.staff||''}</div>`;
          html += `<div class="dd-row${r._clash?' clash':''}">
            <div class="dd-time">${time}</div>
            <div><div class="dd-mod">${who}</div>${secondary}${meta?`<div class="dd-meta">${meta}</div>`:''}</div>
            <div><div class="dd-hrs">${(r.duration||1).toFixed(1)}h</div>${r._clash?'<div class="dd-clash-flag">‚ö† clash</div>':''}</div>
          </div>`;
        });
      });
    } else {
      // No day info ‚Äî fall back to time-sorted flat list
      const sess = allSess.slice().sort((a,b)=>(a.startTime||'').localeCompare(b.startTime||''));
      sess.forEach(r => {
        const time = r.startTime ? `${r.startTime}${r.endTime?'‚Äì'+r.endTime:''}` : '‚Äî';
        const meta = [r.type, r.room].filter(Boolean).join(' ¬∑ ');
        const who  = label==='Staff Member' ? (r.module||'‚Äî') : (r.staff||'‚Äî');
        const secondary = label==='Staff Member' ? '' : `<div class="dd-meta">${r.staff||''}</div>`;
        const flatDay = getDayOfWeek(r);
        html += `<div class="dd-row${r._clash?' clash':''}">
          <div class="dd-time">${time}${flatDay?`<div class="dd-meta" style="margin-top:3px;color:var(--navy);opacity:.7">${flatDay.slice(0,3)}</div>`:''}</div>
          <div><div class="dd-mod">${who}</div>${secondary}${meta?`<div class="dd-meta">${meta}</div>`:''}</div>
          <div><div class="dd-hrs">${(r.duration||1).toFixed(1)}h</div>${r._clash?'<div class="dd-clash-flag">‚ö† clash</div>':''}</div>
        </div>`;
      });
    }
  });

  document.getElementById('ddBody').innerHTML = html;
  document.getElementById('ddOverlay').classList.add('open');
  document.getElementById('ddPanel').classList.add('open');
}

function closeDrawer() {
  document.getElementById('ddOverlay').classList.remove('open');
  document.getElementById('ddPanel').classList.remove('open');
}
document.getElementById('ddOverlay').addEventListener('click', closeDrawer);
document.getElementById('ddClose').addEventListener('click', closeDrawer);

// ‚îÄ‚îÄ FAQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('faqBtn').addEventListener('click', () => document.getElementById('faqOverlay').classList.add('open'));
document.getElementById('faqClose').addEventListener('click', () => document.getElementById('faqOverlay').classList.remove('open'));
document.getElementById('faqOverlay').addEventListener('click', e => { if (e.target===document.getElementById('faqOverlay')) document.getElementById('faqOverlay').classList.remove('open'); });

document.addEventListener('keydown', e => {
  if (e.key==='Escape') { closeDrawer(); document.getElementById('faqOverlay').classList.remove('open'); }
});

// ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('[data-export]').forEach(btn => {
  btn.addEventListener('click', () => exportCSV(btn.dataset.export));
});

function exportCSV(type) {
  let headers, rows;
  if (type==='raw') {
    headers = FIELD_KEYS;
    rows = mapped.map(r => FIELD_KEYS.map(k=>`"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(','));
  } else if (type==='staff') {
    headers=['Staff','Raw Hours','Sessions','Modules'];
    const agg={};
    mapped.forEach(r=>{if(!r.staff)return;if(!agg[r.staff])agg[r.staff]={h:0,s:0,m:new Set()};agg[r.staff].h+=r.duration;agg[r.staff].s++;if(r.module)agg[r.staff].m.add(r.module);});
    rows=Object.entries(agg).map(([n,d])=>`"${n}",${d.h.toFixed(1)},${d.s},${d.m.size}`);
  } else if (type==='module') {
    headers=['Module','Hours','Sessions','Staff'];
    const agg={};
    mapped.forEach(r=>{if(!r.module)return;if(!agg[r.module])agg[r.module]={h:0,s:0,st:new Set()};agg[r.module].h+=r.duration;agg[r.module].s++;if(r.staff)agg[r.module].st.add(r.staff);});
    rows=Object.entries(agg).map(([m,d])=>`"${m}",${d.h.toFixed(1)},${d.s},${d.st.size}`);
  } else if (type==='week') {
    headers=['Week','Hours','Sessions'];
    const agg={};
    mapped.forEach(r=>{if(!r.week)return;if(!agg[r.week])agg[r.week]={h:0,s:0};agg[r.week].h+=r.duration;agg[r.week].s++;});
    rows=Object.entries(agg).sort((a,b)=>+a[0]-+b[0]).map(([w,d])=>`${w},${d.h.toFixed(1)},${d.s}`);
  } else if (type==='semester') {
    headers=['Semester','Hours','Sessions','Staff','Modules'];
    const agg={};
    mapped.forEach(r=>{const s=r.semester||'Unknown';if(!agg[s])agg[s]={h:0,ses:0,st:new Set(),m:new Set()};agg[s].h+=r.duration;agg[s].ses++;if(r.staff)agg[s].st.add(r.staff);if(r.module)agg[s].m.add(r.module);});
    rows=Object.entries(agg).map(([s,d])=>`"${s}",${d.h.toFixed(1)},${d.ses},${d.st.size},${d.m.size}`);
  } else if (type==='clashes') {
    headers=['Staff','Date','Session A','Module A','Session B','Module B','Overlap mins'];
    rows=clashInfo.pairs.map(p=>`"${p.staff}","${p.date}","${p.timeA}","${p.modA}","${p.timeB}","${p.modB}",${p.mins}`);
  }
  const csv = [headers.join(','),...rows].join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = `timetable_${type}_${Date.now()}.csv`;
  a.click();
}

// ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(type, msg) {
  const bar = document.getElementById('statusBar');
  bar.className = type ? `status-bar ${type}` : '';
  // reset inline class since we use id styling
  bar.id = 'statusBar';
  if (type==='ok') bar.style.cssText='display:flex;align-items:center;gap:10px;padding:11px 18px;border-radius:8px;font-family:\'DM Mono\',monospace;font-size:.76rem;color:var(--green);background:var(--white);border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:24px;';
  else if (type==='err') bar.style.cssText='display:flex;align-items:center;gap:10px;padding:11px 18px;border-radius:8px;font-family:\'DM Mono\',monospace;font-size:.76rem;color:var(--red);background:var(--white);border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:24px;';
  else bar.style.cssText='display:flex;align-items:center;gap:10px;padding:11px 18px;border-radius:8px;font-family:\'DM Mono\',monospace;font-size:.76rem;color:var(--muted);background:var(--white);border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:24px;';
  const dot = bar.querySelector('.dot');
  if (dot) dot.style.background = type==='ok'?'var(--green)':type==='err'?'var(--red)':'var(--border)';
  document.getElementById('statusText').textContent = msg;
}

}); // end DOMContentLoaded
</script>
</body>
</html>
