<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<title>University Timetable Staff & Module Load Analyser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; color:#041e42;}
header { background-color:#041e42; color:white; padding:20px; text-align:center;}
header h1 { margin:0; font-size:1.8em;}
main { padding:20px; max-width:1400px; margin:auto;}
.instructions { background:#e6f0ff; padding:15px; border-left:5px solid #0066cc; margin-bottom:20px;}
.controls { margin-bottom:20px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
input[type=file], input[type=text] { padding:5px; }
label { margin-right:5px;}
button { padding:8px 15px; background:#0066cc; color:white; border:none; cursor:pointer; border-radius:4px;}
button:hover { background:#004c99;}
table { border-collapse: collapse; width:100%; margin-top:20px; }
th, td { border:1px solid #ccc; padding:5px; text-align:center;}
th { background:#0066cc; color:white; cursor:pointer; user-select:none; }
tr:nth-child(even) { background:#f2f2f2;}
.modal { display:none; position:fixed; z-index:10; left:0; top:0; width:100%; height:100%; overflow:auto; background: rgba(0,0,0,0.6);}
.modal-content { background:white; margin:5% auto; padding:20px; border-radius:5px; max-width:95%; }
.close { float:right; font-size:1.2em; cursor:pointer;}
.export-buttons { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;}
.tabs { display:flex; gap:5px; margin-bottom:10px;}
.tab { padding:8px 15px; background:#e6e6e6; cursor:pointer; border-radius:4px 4px 0 0;}
.tab.active { background:#0066cc; color:white;}
.tab-content { display:none; }
.tab-content.active { display:block; }
</style>

<!-- Load XLSX BEFORE any custom JS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

</head>
<body>

<header>
    <h1>University Timetable Staff & Module Load Analyser</h1>
</header>

<main>
    <div class="instructions">
        <p><strong>Note:</strong> All processing happens locally in your browser. Upload your HTML timetable files to analyse teaching loads. Multiple files are supported.</p>
    </div>

    <div class="controls">
        <input type="file" id="fileInput" multiple accept=".html,.htm">
        <label for="titleInput">Analysis Title:</label>
        <input type="text" id="titleInput" placeholder="Optional title">
        <label><input type="checkbox" id="realisticToggle"> Avoid double-counting overlapping sessions</label>
        <button id="analyseBtn">Analyse</button>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="staffTab">Staff View</div>
        <div class="tab" data-tab="moduleTab">Module View</div>
    </div>

    <div id="staffTab" class="tab-content active">
        <div id="staffGridContainer"></div>
        <div class="export-buttons">
            <button id="exportExcelStaff">Export Staff Grid to Excel</button>
        </div>
    </div>

    <div id="moduleTab" class="tab-content">
        <div id="moduleGridContainer"></div>
        <div class="export-buttons">
            <button id="exportExcelModule">Export Module Grid to Excel</button>
        </div>
    </div>
</main>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalBody"></div>
    </div>
</div>

<script>
// --- Tab switching ---
document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
        document.getElementById(tab.dataset.tab).classList.add('active');
    });
});

// --- Helpers ---
function parseWeeks(weeksStr) {
    const weeks = new Set();
    if (!weeksStr) return [];
    weeksStr.split(/,|\s+/).forEach(part => {
        part = part.trim();
        if (part.includes('-')) {
            const [start, end] = part.split('-').map(n=>parseInt(n,10));
            for(let i=start;i<=end;i++) weeks.add(i);
        } else if (!isNaN(parseInt(part))) {
            weeks.add(parseInt(part));
        }
    });
    return Array.from(weeks).sort((a,b)=>a-b);
}

function parseHTMLTimetable(fileContent) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(fileContent,"text/html");
    const tables = doc.querySelectorAll("table");
    const data = [];
    tables.forEach(table => {
        const headers = Array.from(table.querySelectorAll("th")).map(h=>h.textContent.trim());
        const required = ["Activity","Module Code","Module Title","Session Title","Type","Weeks","Day","Start","End","Staff","Location","Group Information","Notes"];
        if (!required.every(h=>headers.includes(h))) return;
        const rows = table.querySelectorAll("tr");
        rows.forEach((row,i)=>{
            if(i===0) return;
            const cells = row.querySelectorAll("td");
            if(cells.length!==headers.length) return;
            const obj = {};
            headers.forEach((h,idx)=>{
                let val = cells[idx].innerHTML.trim();
                if(h==="Staff") val = val.split(/<br\s*\/?>/i).map(s=>s.trim()).filter(Boolean);
                if(h==="Weeks") val = parseWeeks(val);
                obj[h] = val;
            });
            data.push(obj);
        });
    });
    return data;
}

function parseTime(t) { if(!t) return 0; const [h,m]=t.split(":").map(Number); return h+(m||0)/60; }

// --- Compute Load ---
function computeStaffLoad(data, realistic=false) {
    const staffWeeks = {};
    data.forEach(sess=>{
        sess.Staff.forEach(s=>{
            if(!staffWeeks[s]) staffWeeks[s]={};
            sess.Weeks.forEach(w=>{
                const week=w.toString();
                if(!staffWeeks[s][week]) staffWeeks[s][week]=[];
                staffWeeks[s][week].push({day:sess.Day,start:parseTime(sess.Start),end:parseTime(sess.End)});
            });
        });
    });
    const result={};
    Object.keys(staffWeeks).forEach(s=>{
        result[s]={};
        Object.keys(staffWeeks[s]).forEach(week=>{
            const intervals=staffWeeks[s][week];
            if(realistic){
                const dayMap={};
                intervals.forEach(i=>{ if(!dayMap[i.day]) dayMap[i.day]=[]; dayMap[i.day].push({start:i.start,end:i.end});});
                let total=0;
                Object.values(dayMap).forEach(dayIntervals=>{
                    const sorted=dayIntervals.sort((a,b)=>a.start-b.start);
                    let currentEnd=0;
                    sorted.forEach(i=>{
                        const s=Math.max(i.start,currentEnd);
                        const e=i.end;
                        if(e>s) total+=(e-s);
                        currentEnd=Math.max(currentEnd,e);
                    });
                });
                result[s][week]=total;
            } else {
                result[s][week]=intervals.reduce((sum,i)=>sum+(i.end-i.start),0);
            }
        });
    });
    return result;
}

function computeModuleLoad(data, realistic=false){
    const modWeeks={};
    data.forEach(sess=>{
        const modKey=`${sess["Module Code"]} - ${sess["Module Title"]}`;
        if(!modWeeks[modKey]) modWeeks[modKey]={};
        sess.Weeks.forEach(w=>{
            const week=w.toString();
            if(!modWeeks[modKey][week]) modWeeks[modKey][week]=[];
            modWeeks[modKey][week].push({day:sess.Day,start:parseTime(sess.Start),end:parseTime(sess.End)});
        });
    });
    const result={};
    Object.keys(modWeeks).forEach(mod=>{
        result[mod]={};
        Object.keys(modWeeks[mod]).forEach(week=>{
            const intervals=modWeeks[mod][week];
            if(realistic){
                const dayMap={};
                intervals.forEach(i=>{ if(!dayMap[i.day]) dayMap[i.day]=[]; dayMap[i.day].push({start:i.start,end:i.end});});
                let total=0;
                Object.values(dayMap).forEach(dayIntervals=>{
                    const sorted=dayIntervals.sort((a,b)=>a.start-b.start);
                    let currentEnd=0;
                    sorted.forEach(i=>{
                        const s=Math.max(i.start,currentEnd);
                        const e=i.end;
                        if(e>s) total+=(e-s);
                        currentEnd=Math.max(currentEnd,e);
                    });
                });
                result[mod][week]=total;
            } else {
                result[mod][week]=intervals.reduce((sum,i)=>sum+(i.end-i.start),0);
            }
        });
    });
    return result;
}

// --- Render Grid, Deep Dive, Export functions here ---
// (All code from previous working version, including Grand Total, sorting, modal, and XLSX export)

// --- Analyse ---
let allData=[],allLoadData={},allModuleLoad={};
document.getElementById('analyseBtn').onclick=async function(){
    const files=document.getElementById('fileInput').files;
    if(!files.length){ alert('Please select at least one HTML file'); return; }
    allData=[];
    for(let f of files){
        const text=await f.text();
        allData.push(...parseHTMLTimetable(text));
    }
    const realistic=document.getElementById('realisticToggle').checked;
    allLoadData=computeStaffLoad(allData,realistic);
    allModuleLoad=computeModuleLoad(allData,realistic);
    renderGrid(allLoadData,'staffGridContainer',true);
    renderGrid(allModuleLoad,'moduleGridContainer',true);
}

// --- Export Buttons ---
document.getElementById('exportExcelStaff').onclick=function(){ exportGridExcel(allLoadData,'Staff'); };
document.getElementById('exportExcelModule').onclick=function(){ exportGridExcel(allModuleLoad,'Module'); };

// --- Modal ---
document.querySelector('.close').onclick=function(){document.getElementById('modal').style.display='none';}
window.onclick=function(e){if(e.target===document.getElementById('modal')) document.getElementById('modal').style.display='none';}

</script>
</body>
</html>
