<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timetable Load Analyser</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    /* University of Nottingham official palette */
    --bg: #f0f3f6;           /* 5% tint of Nottingham Blue - recommended digital bg */
    --surface: #ffffff;       /* white card surfaces */
    --surface2: #e6eaf0;      /* slightly deeper for inset elements */
    --border: #c8d0db;        /* soft blue-grey border */
    --accent: #10263B;        /* Nottingham Blue - primary */
    --accent-mid: #1e4068;    /* 80% tint - for hover states */
    --accent2: #005F36;       /* Forest Green - supporting */
    --accent3: #DEB406;       /* Rebels Gold - supporting */
    --text: #10263B;          /* Nottingham Blue for body text (brand guideline) */
    --muted: #5a6e82;         /* muted blue-grey */
    --danger: #B91C2E;        /* Jubilee Red - for clashes/errors */
    --success: #005F36;       /* Forest Green */
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-weight: 400;
    font-size: 16px;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  header {
    border-bottom: 3px solid var(--accent3);
    padding: 20px 40px;
    display: flex;
    align-items: center;
    gap: 16px;
    background: var(--accent);
  }
  header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.7rem;
    font-weight: 900;
    letter-spacing: -0.02em;
    color: #ffffff;
  }
  header span {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.1);
    padding: 3px 8px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.2);
  }

  main { padding: 40px; max-width: 1400px; margin: 0 auto; }

  /* ‚îÄ‚îÄ Import panel ‚îÄ‚îÄ */
  /* ‚îÄ‚îÄ Import card ‚îÄ‚îÄ */
  .import-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(16,38,59,0.07);
    margin-bottom: 32px;
    overflow: hidden;
  }
  .import-method-switcher {
    display: flex;
    border-bottom: 2px solid var(--accent);
    background: var(--accent);
  }
  .import-method-btn {
    flex: 1;
    padding: 14px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    cursor: pointer;
    border: none;
    background: transparent;
    color: rgba(255,255,255,0.55);
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    position: relative;
  }
  .import-method-btn:hover { color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.08); }
  .import-method-btn.active {
    color: #fff;
    background: rgba(255,255,255,0.15);
    font-weight: 600;
  }
  .import-method-btn.active::after {
    content: '';
    position: absolute;
    bottom: -2px; left: 0; right: 0;
    height: 3px;
    background: var(--accent3);
  }
  .import-method-divider {
    width: 1px;
    background: rgba(255,255,255,0.15);
    margin: 8px 0;
    flex-shrink: 0;
  }
  .import-method-pane {
    display: none;
    padding: 28px;
  }
  .import-method-pane.active { display: block; }
  .import-pane-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--accent);
    margin-bottom: 12px;
    font-weight: 600;
  }
  .import-pane-desc {
    color: var(--muted);
    font-size: 0.9rem;
    line-height: 1.6;
    margin-bottom: 20px;
  }
  .import-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 40px;
  }
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    box-shadow: 0 2px 8px rgba(16,38,59,0.07);
  }
  .panel h2 {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--accent);
    margin-bottom: 16px;
    font-weight: 600;
  }
  .panel p { color: var(--muted); font-size: 0.9rem; line-height: 1.6; margin-bottom: 16px; }

  .dropzone {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--muted);
    font-size: 0.9rem;
    background: var(--bg);
  }
  .dropzone:hover, .dropzone.drag-over {
    border-color: var(--accent);
    background: rgba(16,38,59,0.05);
    color: var(--accent);
  }
  .dropzone input { display: none; }
  .dropzone .icon { font-size: 2rem; margin-bottom: 8px; }

  .bookmarklet-box {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .bookmarklet-box code {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent2);
    word-break: break-all;
    display: block;
    margin-bottom: 12px;
    line-height: 1.6;
  }
  .btn {
    display: inline-block;
    padding: 8px 18px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-accent { background: var(--accent); color: #ffffff; }
  .btn-accent:hover { background: var(--accent-mid); }
  .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); background: rgba(16,38,59,0.04); }
  .btn-sm { padding: 5px 12px; font-size: 0.75rem; }

  .drag-link {
    display: inline-block;
    padding: 8px 16px;
    background: var(--accent);
    color: #fff;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: grab;
    text-decoration: none;
    margin-top: 4px;
  }
  .drag-link:hover { background: var(--accent-mid); }

  /* ‚îÄ‚îÄ Paste area ‚îÄ‚îÄ */
  textarea.paste-area {
    width: 100%;
    height: 120px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 12px;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
  }
  textarea.paste-area:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ */
  .status-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 32px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 1px 4px rgba(16,38,59,0.06);
  }
  .status-bar .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
  }
  .status-bar.loaded .dot { background: var(--success); }
  .status-bar.loaded { color: var(--success); }
  .status-bar.error .dot { background: var(--danger); }
  .status-bar.error { color: var(--danger); }

  /* ‚îÄ‚îÄ Field mapping ‚îÄ‚îÄ */
  .mapping-panel { display: none; }
  .mapping-panel.visible { display: block; }
  .mapping-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }
  .map-field label {
    display: block;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 5px;
  }
  .map-field select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 7px 10px;
    outline: none;
    cursor: pointer;
  }
  .map-field select:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    border-bottom: 2px solid var(--accent);
    padding-bottom: 0;
  }
  .tab {
    padding: 10px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    cursor: pointer;
    border-radius: 6px 6px 0 0;
    border: 1px solid transparent;
    border-bottom: none;
    transition: all 0.15s;
    position: relative;
    top: 2px;
  }
  .tab:hover { color: var(--accent); background: rgba(16,38,59,0.05); }
  .tab.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #ffffff;
  }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ‚îÄ‚îÄ Summary cards ‚îÄ‚îÄ */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }
  .kpi {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(16,38,59,0.07);
    border-top: 3px solid var(--accent);
  }
  .kpi .val {
    font-family: 'Playfair Display', serif;
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 6px;
  }
  .kpi .lbl {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  /* ‚îÄ‚îÄ Data tables ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }
  thead tr { border-bottom: 2px solid var(--accent); background: var(--bg); }
  th {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent);
    text-align: left;
    padding: 12px 14px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    font-weight: 600;
  }
  th:hover { color: var(--accent-mid); }
  th.sort-asc::after { content: ' ‚Üë'; color: var(--accent3); }
  th.sort-desc::after { content: ' ‚Üì'; color: var(--accent3); }
  td {
    padding: 11px 14px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
    font-size: 0.92rem;
  }
  tbody tr:hover td { background: rgba(16,38,59,0.03); }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    font-weight: 500;
  }
  .badge-teal { background: rgba(0,95,54,0.12); color: var(--accent2); border: 1px solid rgba(0,95,54,0.2); }
  .badge-yellow { background: rgba(222,180,6,0.15); color: #7a5e00; border: 1px solid rgba(222,180,6,0.3); }
  .badge-purple { background: rgba(16,38,59,0.1); color: var(--accent); border: 1px solid rgba(16,38,59,0.15); }

  /* ‚îÄ‚îÄ Bar mini charts ‚îÄ‚îÄ */
  .mini-bar {
    height: 6px;
    border-radius: 3px;
    background: var(--border);
    overflow: hidden;
    min-width: 80px;
    display: inline-block;
    vertical-align: middle;
    margin-left: 8px;
  }
  .mini-bar-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--accent3);
    transition: width 0.4s;
  }

  /* ‚îÄ‚îÄ Heatmap ‚îÄ‚îÄ */
  .heatmap-grid {
    display: grid;
    gap: 4px;
  }
  .heatmap-row { display: flex; gap: 4px; align-items: center; }
  .heatmap-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--text);
    width: 120px;
    flex-shrink: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .heatmap-cell {
    width: 36px;
    height: 28px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: rgba(0,0,0,0.7);
    font-weight: 500;
    transition: transform 0.15s;
    cursor: default;
    position: relative;
  }
  .heatmap-cell:hover { transform: scale(1.2); z-index: 10; }
  .heatmap-week-header {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--accent);
    width: 36px;
    text-align: center;
  }

  /* ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ */
  .filter-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .filter-bar input, .filter-bar select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    padding: 8px 12px;
    outline: none;
    transition: border-color 0.2s;
    box-shadow: 0 1px 3px rgba(16,38,59,0.06);
  }
  .filter-bar input:focus, .filter-bar select:focus { border-color: var(--accent); }
  .filter-bar input { min-width: 200px; }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--muted);
  }
  .empty-state .big { font-size: 3rem; margin-bottom: 16px; }
  .empty-state p { font-size: 0.9rem; line-height: 1.6; }

  /* ‚îÄ‚îÄ Export bar ‚îÄ‚îÄ */
  .export-bar {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-bottom: 16px;
  }

  /* ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ */
  .tooltip {
    position: fixed;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--text);
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
    display: none;
  }



  /* ‚îÄ‚îÄ FAQ Modal ‚îÄ‚îÄ */
  .faq-btn {
    margin-left: auto;
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.3);
    color: rgba(255,255,255,0.85);
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.05em;
  }
  .faq-btn:hover { background: rgba(255,255,255,0.22); color: #fff; border-color: rgba(255,255,255,0.5); }

  .modal-overlay {
    display: flex;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    border-top: 4px solid var(--accent);
    max-width: 720px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    padding: 40px;
    position: relative;
    animation: modalIn 0.2s ease;
    box-shadow: 0 20px 60px rgba(16,38,59,0.2);
  }
  @keyframes modalIn {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .modal-close {
    position: absolute;
    top: 16px; right: 20px;
    background: none;
    border: none;
    color: var(--muted);
    font-size: 1.4rem;
    cursor: pointer;
    line-height: 1;
    transition: color 0.15s;
  }
  .modal-close:hover { color: var(--accent); }

  .modal h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 24px;
    letter-spacing: -0.02em;
  }
  .faq-item { margin-bottom: 28px; }
  .faq-item h3 {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent);
    margin-bottom: 8px;
    font-weight: 600;
  }
  .faq-item p {
    color: var(--text);
    font-size: 0.875rem;
    line-height: 1.7;
    font-weight: 300;
  }
  .faq-item p + p { margin-top: 8px; }
  .faq-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 24px 0;
  }
  .faq-highlight {
    background: var(--bg);
    border-left: 3px solid var(--accent3);
    border-radius: 0 6px 6px 0;
    padding: 12px 16px;
    margin-top: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.6;
  }
  .faq-highlight strong { color: var(--accent); }

  /* ‚îÄ‚îÄ Drill-down side panel ‚îÄ‚îÄ */
  .drilldown-overlay {
    display: block;
    position: fixed;
    inset: 0;
    background: rgba(16,38,59,0.35);
    z-index: 1500;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .drilldown-overlay.open { opacity: 1; pointer-events: auto; }

  .drilldown-panel {
    position: fixed;
    top: 0; right: 0;
    width: min(560px, 100vw);
    height: 100vh;
    background: var(--surface);
    border-left: 3px solid var(--accent);
    box-shadow: -8px 0 40px rgba(16,38,59,0.18);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
    z-index: 1501;
  }
  .drilldown-panel.open { transform: translateX(0); }

  .drilldown-header {
    background: var(--accent);
    padding: 20px 24px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    flex-shrink: 0;
    border-bottom: 3px solid var(--accent3);
  }
  .drilldown-header-text { flex: 1; min-width: 0; }
  .drilldown-header-text .dd-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: rgba(255,255,255,0.6);
    margin-bottom: 4px;
  }
  .drilldown-header-text .dd-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.25rem;
    font-weight: 900;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .drilldown-close {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.25);
    color: #fff;
    font-size: 1.1rem;
    width: 32px; height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: background 0.15s;
  }
  .drilldown-close:hover { background: rgba(255,255,255,0.28); }

  .drilldown-stats {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .dd-stat {
    flex: 1;
    padding: 14px 16px;
    text-align: center;
    border-right: 1px solid var(--border);
  }
  .dd-stat:last-child { border-right: none; }
  .dd-stat .dd-stat-val {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 3px;
  }
  .dd-stat .dd-stat-lbl {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
  }

  .drilldown-body {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }

  .dd-section-head {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    padding: 14px 20px 8px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 1;
  }

  .dd-session-row {
    display: grid;
    grid-template-columns: 90px 1fr auto;
    gap: 8px;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    align-items: start;
    transition: background 0.1s;
    cursor: default;
  }
  .dd-session-row:hover { background: rgba(16,38,59,0.03); }
  .dd-session-row.is-clash { border-left: 3px solid var(--danger); background: rgba(185,28,46,0.04); }

  .dd-time {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--accent);
    font-weight: 600;
    padding-top: 2px;
  }
  .dd-module {
    font-size: 0.88rem;
    color: var(--text);
    font-weight: 500;
    line-height: 1.3;
  }
  .dd-meta {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    margin-top: 3px;
  }
  .dd-hrs {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    white-space: nowrap;
    padding-top: 2px;
    text-align: right;
  }
  .dd-clash-flag {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--danger);
    margin-top: 3px;
    text-align: right;
  }

  tbody tr.clickable-row { cursor: pointer; }
  tbody tr.clickable-row:hover td { background: rgba(16,38,59,0.05) !important; }
  tbody tr.clickable-row td:first-child {
    color: var(--accent);
    text-decoration: underline;
    text-decoration-color: rgba(16,38,59,0.25);
    text-underline-offset: 3px;
  }

  /* ‚îÄ‚îÄ Sources list ‚îÄ‚îÄ */
  .sources-list {
    margin-top: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .source-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    border-left: 3px solid var(--accent2);
  }
  .source-item .source-icon { font-size: 1rem; flex-shrink: 0; }
  .source-item .source-info { flex: 1; min-width: 0; }
  .source-item .source-name {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .source-item .source-meta {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    margin-top: 2px;
  }
  .source-remove {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 5px;
    width: 26px; height: 26px;
    cursor: pointer;
    font-size: 0.85rem;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .source-remove:hover { background: rgba(185,28,46,0.08); border-color: var(--danger); color: var(--danger); }
  .sources-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 20px;
    margin-bottom: 6px;
  }
  .sources-header-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
  }
  .sources-total {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--accent2);
    font-weight: 600;
  }
  /* ‚îÄ‚îÄ Clash detection ‚îÄ‚îÄ */
  .clash-btn { background: var(--danger); color: #fff; border: none; }
  .clash-btn:hover { background: #9a1525; }
  .clash-btn.active { background: #f8e8ea; border: 1px solid var(--danger); color: var(--danger); }
  .clash-badge { background: rgba(185,28,46,0.1); color: var(--danger); border: 1px solid rgba(185,28,46,0.25); }
  .safe-badge { background: rgba(0,95,54,0.1); color: var(--accent2); border: 1px solid rgba(0,95,54,0.2); }
  tr.clash-row td { background: rgba(185,28,46,0.05) !important; }
  tr.clash-row td:first-child { border-left: 3px solid var(--danger); }
  .clash-pill {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    background: rgba(185,28,46,0.1);
    color: var(--danger);
    border: 1px solid rgba(185,28,46,0.25);
    cursor: help;
    margin-left: 6px;
  }
  .kpi.kpi-clash { border-top-color: var(--danger); }
  .kpi.kpi-clash .val { color: var(--danger); }
  @media (max-width: 768px) {
    main { padding: 20px; }
    .import-grid { grid-template-columns: 1fr; }
    .import-method-btn { font-size: 0.68rem; padding: 12px 10px; }
    header { padding: 16px 20px; }
  }
</style>
</head>
<body>

<header>
  <h1>Timetable Load Analyser</h1>
  <span>v1.0</span>
  <button class="faq-btn" onclick="document.getElementById('faqModal').classList.add('open')">? FAQ</button>
</header>

<!-- ‚îÄ‚îÄ Drill-down Panel ‚îÄ‚îÄ -->
<div class="drilldown-overlay" id="ddOverlay" onclick="closeDrawer()"></div>
<div class="drilldown-panel" id="ddPanel">
  <div class="drilldown-header">
    <div class="drilldown-header-text">
      <div class="dd-label" id="ddLabel">Staff Member</div>
      <div class="dd-title" id="ddTitle">‚Äî</div>
    </div>
    <button class="drilldown-close" onclick="closeDrawer()">‚úï</button>
  </div>
  <div class="drilldown-stats" id="ddStats"></div>
  <div class="drilldown-body" id="ddBody"></div>
</div>

<!-- ‚îÄ‚îÄ FAQ Modal ‚îÄ‚îÄ -->
<div class="modal-overlay" id="faqModal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('faqModal').classList.remove('open')">√ó</button>
    <h2>Frequently Asked Questions</h2>

    <div class="faq-item">
      <h3>What data does this tool need?</h3>
      <p>The analyser works with any timetable data that contains at least a <strong>staff name</strong> or <strong>module name</strong> column. It works best when you also have <strong>start time</strong>, <strong>end time</strong>, <strong>date</strong> or <strong>week number</strong>, and <strong>semester</strong> columns ‚Äî but will do its best with whatever is available.</p>
    </div>

    <hr class="faq-divider">

    <div class="faq-item">
      <h3>How do I get my timetable data in?</h3>
      <p><strong>Option 1 ‚Äî File upload:</strong> In your browser, go to your timetable page and use File ‚Üí Save Page As ‚Üí "Web Page, Complete" (or "HTML Only"). Then drag that file into the upload panel. The analyser will extract and merge all tables on the page automatically.</p>
      <p><strong>Option 2 ‚Äî Bookmarklet:</strong> Drag the purple "üîñ Scrape Timetable" button to your bookmarks bar. Navigate to your timetable page, click the bookmarklet, and it will copy the table data to your clipboard. Paste it back into the analyser.</p>
    </div>

    <hr class="faq-divider">

    <div class="faq-item">
      <h3>My timetable has multiple tables on one page ‚Äî is that a problem?</h3>
      <p>No. The analyser detects all tables with the same column structure and merges them into one dataset automatically. Any navigation or summary tables with different columns are ignored. The status bar will confirm how many tables were merged and how many rows were loaded.</p>
    </div>

    <hr class="faq-divider">

    <div class="faq-item">
      <h3>What happens with sessions that have multiple staff?</h3>
      <p>When a timetable cell contains multiple staff names separated by a line break (a <code>&lt;br&gt;</code> tag in the HTML), the analyser detects this and <strong>splits the session into one row per staff member</strong>. Each person gets their own row carrying the same module, time, room, and other details. The status bar reports how many rows were expanded this way.</p>
      <p>This means every staff member's contribution is counted individually, even in jointly-taught sessions.</p>
    </div>

    <hr class="faq-divider">

    <div class="faq-item">
      <h3>How does clash detection work?</h3>
      <p>Clicking <strong>‚ö° Detect Clashes</strong> checks whether any staff member appears in two sessions whose times overlap on the same day. It requires start and end times to be mapped.</p>
      <p>For each staff member it:</p>
      <div class="faq-highlight">
        <strong>1. Converts</strong> every session to an absolute time interval (date + start ‚Üí date + end)<br>
        <strong>2. Compares</strong> every pair of that person's sessions to find overlaps<br>
        <strong>3. Flags</strong> any session involved in an overlap with a red ‚ö† clash marker<br>
        <strong>4. Calculates</strong> effective hours by merging overlapping intervals ‚Äî so double-counted time is removed only once, even if three sessions overlap
      </div>
    </div>

    <hr class="faq-divider">

    <div class="faq-item">
      <h3>What is the difference between Raw Hours and Effective Hours?</h3>
      <p><strong>Raw Hours</strong> is the simple sum of all session durations for a staff member ‚Äî exactly what the timetable records. If someone is listed in two simultaneous 2-hour sessions, raw hours counts 4 hours.</p>
      <p><strong>Effective Hours</strong> is the actual time a person could physically have taught, after removing impossible overlaps. The same two simultaneous 2-hour sessions would give 2 effective hours. This uses interval merging, so if three sessions overlap in a complex pattern, the deduction is still correct.</p>
      <p>The difference (shown in red in the Staff tab) is the total time the timetable has that person in two places at once.</p>
    </div>

    <hr class="faq-divider">

    <div class="faq-item">
      <h3>Is my data safe? Does anything leave my computer?</h3>
      <p>Everything runs entirely in your browser. No data is sent to any server ‚Äî there is no server. File uploads, paste input, all analysis, and CSV exports happen purely in local JavaScript memory. You can verify this by opening your browser's Network tab (F12) ‚Äî you will see zero data requests when using the tool.</p>
      <p>The only external request the page makes is loading the display fonts from Google Fonts when the page first opens.</p>
    </div>

    <hr class="faq-divider">

    <div class="faq-item">
      <h3>Can I export the results?</h3>
      <p>Yes ‚Äî every tab (By Staff, By Module, By Week, Clashes, Raw Data) has an <strong>Export CSV</strong> button that downloads the current view as a CSV file, ready to open in Excel or any spreadsheet application.</p>
    </div>

  </div>
</div>

<main>

  <!-- ‚îÄ‚îÄ Import Section ‚îÄ‚îÄ -->
  <div class="import-card">

    <!-- Method switcher -->
    <div class="import-method-switcher">
      <button class="import-method-btn active" id="methodBtn1" onclick="switchImportMethod('upload')">
        üìÅ Upload File
      </button>
      <div class="import-method-divider"></div>
      <button class="import-method-btn" id="methodBtn2" onclick="switchImportMethod('scrape')">
        üîñ Bookmarklet Scraper
      </button>
    </div>

    <!-- Pane 1: File Upload -->
    <div class="import-method-pane active" id="importPane-upload">
      <div class="import-pane-title">Upload HTML or CSV</div>
      <p class="import-pane-desc">Save your timetable page as HTML (File ‚Üí Save Page As in your browser) or export it as CSV, then drop the file below. All tables on the page will be detected and merged automatically.</p>
      <div class="dropzone" id="dropzone">
        <input type="file" id="fileInput" accept=".html,.htm,.csv,.txt">
        <div class="icon">‚¨Ü</div>
        <div>Drop file here or <strong>click to browse</strong></div>
        <div style="margin-top:6px;font-size:0.75rem;color:var(--muted);">Supports .html ¬∑ .htm ¬∑ .csv</div>
      </div>
      <div style="margin-top:16px;text-align:right;">
        <button class="btn btn-outline btn-sm" onclick="clearAll()">Clear All</button>
      </div>
    </div>

    <!-- Pane 2: Bookmarklet -->
    <div class="import-method-pane" id="importPane-scrape">
      <div class="import-pane-title">Bookmarklet Scraper</div>
      <p class="import-pane-desc">This method lets you scrape timetable data directly from a live page without saving a file. Drag the button below to your bookmarks bar once, then click it while viewing your timetable page ‚Äî the data will be copied to your clipboard ready to paste here.</p>

      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;padding:16px;background:var(--bg);border-radius:8px;border:1px solid var(--border);">
        <div style="flex:1;">
          <div style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);margin-bottom:6px;">STEP 1 ‚Äî drag to bookmarks bar</div>
          <a id="bookmarkletLink" href="#" class="drag-link" title="Drag me to your bookmarks bar!">üîñ Scrape Timetable</a>
        </div>
        <div style="color:var(--border);font-size:1.5rem;">‚Üí</div>
        <div style="flex:1;">
          <div style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);margin-bottom:6px;">STEP 2 ‚Äî click it on your timetable page</div>
          <div style="font-size:0.82rem;color:var(--text);">Data copies to clipboard automatically</div>
        </div>
        <div style="color:var(--border);font-size:1.5rem;">‚Üí</div>
        <div style="flex:1;">
          <div style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);margin-bottom:6px;">STEP 3 ‚Äî paste below</div>
          <div style="font-size:0.82rem;color:var(--text);">Then click Parse</div>
        </div>
      </div>

      <div style="margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;">
        <label style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.08em;">Paste scraped data here</label>
        <button class="btn btn-outline btn-sm" onclick="copyBookmarklet()">Copy bookmarklet code</button>
      </div>
      <textarea class="paste-area" id="pasteArea" placeholder="Paste the copied data here after running the bookmarklet on your timetable page‚Ä¶" style="height:100px;"></textarea>
      <div style="margin-top:12px;display:flex;gap:8px;">
        <button class="btn btn-accent" id="parsePasteBtn">Parse Pasted Data ‚Üí</button>
        <button class="btn btn-outline" onclick="clearAll()">Clear All</button>
      </div>
    </div>

    <!-- Loaded sources list (shared, always visible) -->
    <div id="sourcesSection" style="display:none;border-top:1px solid var(--border);padding:16px 28px 20px;">
      <div class="sources-header">
        <span class="sources-header-label">Loaded sources</span>
        <span class="sources-total" id="sourcesTotalLabel"></span>
      </div>
      <div class="sources-list" id="sourcesList"></div>
    </div>

  </div>

  <!-- ‚îÄ‚îÄ Status ‚îÄ‚îÄ -->
  <div class="status-bar" id="statusBar">
    <div class="dot"></div>
    <span id="statusText">No data loaded. Upload a file or paste scraped data to begin.</span>
  </div>

  <!-- ‚îÄ‚îÄ Field Mapping ‚îÄ‚îÄ -->
  <div class="panel mapping-panel" id="mappingPanel" style="margin-bottom:32px;">
    <h2>üóÇ Column Mapping</h2>
    <p>Tell the analyser which column corresponds to which field. Auto-detected columns are pre-selected.</p>
    <div class="mapping-grid" id="mappingGrid"></div>
    <div style="margin-top:20px;display:flex;gap:8px;">
      <button class="btn btn-accent" onclick="applyMapping()">Analyse ‚Üí</button>
      <button class="btn btn-outline" onclick="document.getElementById('mappingPanel').classList.remove('visible')">Cancel</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Analysis Results ‚îÄ‚îÄ -->
  <div id="results" style="display:none;">

    <!-- KPIs -->
    <div class="kpi-row" id="kpiRow"></div>

    <!-- Clash detection button -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
      <button class="btn clash-btn" id="clashBtn" onclick="runClashDetection()">‚ö° Detect Clashes</button>
      <span id="clashSummaryText" style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);"></span>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('staff')">By Staff</div>
      <div class="tab" onclick="switchTab('module')">By Module</div>
      <div class="tab" onclick="switchTab('week')">By Week</div>
      <div class="tab" onclick="switchTab('semester')">By Semester</div>
      <div class="tab" onclick="switchTab('heatmap')">Heatmap</div>
      <div class="tab" onclick="switchTab('clashes')" id="clashTab" style="display:none;">‚ö† Clashes</div>
      <div class="tab" onclick="switchTab('raw')">Raw Data</div>
    </div>

    <!-- By Staff -->
    <div class="tab-content active" id="tab-staff">
      <div class="filter-bar">
        <input type="text" id="staffFilter" placeholder="Filter staff‚Ä¶" oninput="renderStaffTable()">
        <select id="staffSemFilter" onchange="renderStaffTable()"><option value="">All Semesters</option></select>
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('staff')">Export CSV</button>
      </div>
      <div class="table-wrap" id="staffTable"></div>
    </div>

    <!-- By Module -->
    <div class="tab-content" id="tab-module">
      <div class="filter-bar">
        <input type="text" id="moduleFilter" placeholder="Filter modules‚Ä¶" oninput="renderModuleTable()">
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('module')">Export CSV</button>
      </div>
      <div class="table-wrap" id="moduleTable"></div>
    </div>

    <!-- By Week -->
    <div class="tab-content" id="tab-week">
      <div class="filter-bar">
        <select id="weekStaffFilter" onchange="renderWeekTable()"><option value="">All Staff</option></select>
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('week')">Export CSV</button>
      </div>
      <div class="table-wrap" id="weekTable"></div>
    </div>

    <!-- By Semester -->
    <div class="tab-content" id="tab-semester">
      <div class="table-wrap" id="semesterTable"></div>
    </div>

    <!-- Heatmap -->
    <div class="tab-content" id="tab-heatmap">
      <div class="filter-bar">
        <label style="font-family:DM Mono,monospace;font-size:0.72rem;color:var(--muted);">Show:</label>
        <select id="heatmapMetric" onchange="renderHeatmap()">
          <option value="hours">Hours per week</option>
          <option value="sessions">Sessions per week</option>
        </select>
      </div>
      <div id="heatmapContainer" style="overflow-x:auto;padding-bottom:8px;"></div>
    </div>

    <!-- Clashes -->
    <div class="tab-content" id="tab-clashes">
      <div class="filter-bar">
        <input type="text" id="clashFilter" placeholder="Filter by staff or module‚Ä¶" oninput="renderClashTable()">
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('clashes')">Export CSV</button>
      </div>
      <div class="table-wrap" id="clashTable"></div>
    </div>

    <!-- Raw Data -->
    <div class="tab-content" id="tab-raw">
      <div class="filter-bar">
        <input type="text" id="rawFilter" placeholder="Search all fields‚Ä¶" oninput="renderRawTable()">
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('raw')">Export CSV</button>
      </div>
      <div class="table-wrap" id="rawTable"></div>
    </div>

  </div>

</main>

<div class="tooltip" id="tooltip"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOKMARKLET GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const bookmarkletSrc = `(function(){
  var tables=Array.from(document.querySelectorAll('table')).filter(function(t){return t.rows.length>1;});
  if(tables.length===0){
    var items=document.querySelectorAll('[class*="event"],[class*="session"],[class*="timetable"],[class*="lesson"],[class*="slot"]');
    var divRows=[];
    items.forEach(function(el){divRows.push(el.innerText.replace(/\\n+/g,'|'));});
    if(divRows.length===0){alert('No timetable tables or events found on this page.');return;}
    navigator.clipboard.writeText(JSON.stringify({type:'divs',rows:divRows})).then(function(){alert('Scraped '+divRows.length+' items! Paste into the analyser.');});
    return;
  }
  var sig=function(t){return Array.from(t.rows[0].cells).map(function(c){return c.innerText.trim();}).join('|');};
  var sigCounts={};
  tables.forEach(function(t){var s=sig(t);sigCounts[s]=(sigCounts[s]||0)+1;});
  var bestSig=Object.keys(sigCounts).sort(function(a,b){return sigCounts[b]-sigCounts[a]||b.split('|').length-a.split('|').length;})[0];
  var matching=tables.filter(function(t){return sig(t)===bestSig;});
  var headers=bestSig.split('|');
  var rows=[];
  matching.forEach(function(t){
    for(var i=1;i<t.rows.length;i++){
      var row={};
      Array.from(t.rows[i].cells).forEach(function(c,j){row[headers[j]||'col'+j]=c.innerText.trim();});
      if(Object.values(row).some(function(v){return v;}))rows.push(row);
    }
  });
  var out=JSON.stringify({type:'table',headers:headers,rows:rows});
  navigator.clipboard.writeText(out).then(function(){alert('Scraped '+rows.length+' rows from '+matching.length+' table(s). Columns: '+headers.join(', ')+'\\n\\nPaste into the analyser!');}).catch(function(){prompt('Copy this:',out);});
})();`;

const encoded = 'javascript:' + encodeURIComponent(bookmarkletSrc);
document.getElementById('bookmarkletLink').href = encoded;
document.getElementById('bookmarkletCode').textContent = bookmarkletSrc.substring(0, 120) + '‚Ä¶';

function copyBookmarklet() {
  navigator.clipboard.writeText(encoded).then(() => {
    const btn = event.target;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy Code', 2000);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sources = [];        // array of {id, name, icon, rawRows, columns, mappedRows}
let rawRows = [];        // pending raw rows awaiting mapping (current import)
let mappedRows = [];     // merged mapped rows from ALL sources
let columns = [];        // columns of current pending import
let sortState = {};      // per-table sort state
let pendingSourceName = '';
let pendingSourceIcon = 'üìÑ';

const FIELD_KEYS = ['staff', 'module', 'date', 'startTime', 'endTime', 'duration', 'type', 'room', 'week', 'semester'];
const FIELD_LABELS = { staff:'Staff Name', module:'Module/Course', date:'Date', startTime:'Start Time', endTime:'End Time', duration:'Duration (hrs)', type:'Session Type', room:'Room', week:'Week Number', semester:'Semester' };
const AUTO_MAP_HINTS = {
  staff: ['staff','lecturer','tutor','teacher','instructor','name','faculty','convener'],
  module: ['module','course','unit','subject','code','title','class'],
  date: ['date','day'],
  startTime: ['start','from','begin','time'],
  endTime: ['end','finish','until','to'],
  duration: ['duration','hours','hrs','length','mins','minutes'],
  type: ['type','session','activity','kind','format','mode'],
  room: ['room','venue','location','building','space'],
  week: ['week','wk','w/c'],
  semester: ['semester','term','period','sem'],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Use event delegation on document so bindings work regardless of
// whether the dropzone pane is currently visible or hidden.
document.addEventListener('click', e => {
  const dz = e.target.closest('#dropzone');
  if (dz) { e.preventDefault(); document.getElementById('fileInput').click(); }
});
document.addEventListener('dragover', e => {
  if (e.target.closest('#dropzone')) { e.preventDefault(); document.getElementById('dropzone').classList.add('drag-over'); }
});
document.addEventListener('dragleave', e => {
  if (e.target.closest('#dropzone')) { document.getElementById('dropzone').classList.remove('drag-over'); }
});
document.addEventListener('drop', e => {
  if (e.target.closest('#dropzone')) {
    e.preventDefault();
    document.getElementById('dropzone').classList.remove('drag-over');
    const f = e.dataTransfer.files[0];
    if (f) handleFile(f);
  }
});
document.getElementById('fileInput').addEventListener('change', function() {
  if (this.files[0]) handleFile(this.files[0]);
});
document.getElementById('parsePasteBtn').addEventListener('click', parsePaste);

function handleFile(file) {
  pendingSourceName = file.name;
  pendingSourceIcon = file.name.endsWith('.csv') ? 'üìä' : 'üìÑ';
  const reader = new FileReader();
  reader.onload = e => {
    const txt = e.target.result;
    if (file.name.endsWith('.csv')) {
      parseCSV(txt);
    } else {
      parseHTML(txt);
    }
  };
  reader.readAsText(file);
}

function parseHTML(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const tables = Array.from(doc.querySelectorAll('table')).filter(t => t.rows.length > 1);
  if (!tables.length) { setStatus('error', 'No tables found in HTML file.'); return; }

  // Find the most common header signature (to handle nav/layout tables mixed in)
  const sig = t => Array.from(t.rows[0].cells).map(c => (c.innerText || c.textContent || '').trim()).join('|');
  const sigCounts = {};
  tables.forEach(t => { const s = sig(t); sigCounts[s] = (sigCounts[s] || 0) + 1; });
  // Pick the signature with the most tables; break ties by most columns
  const bestSig = Object.entries(sigCounts).sort((a, b) => b[1] - a[1] || b[0].split('|').length - a[0].split('|').length)[0][0];
  const matchingTables = tables.filter(t => sig(t) === bestSig);
  const headers = bestSig.split('|');

  const DELIM = '\x00';
  const rows = [];
  let multiStaffExpanded = 0;

  matchingTables.forEach(t => {
    for (let i = 1; i < t.rows.length; i++) {
      // For each cell, replace <br> with a delimiter BEFORE reading text
      const cellValues = Array.from(t.rows[i].cells).map(c => {
        const clone = c.cloneNode(true);
        clone.querySelectorAll('br').forEach(br => br.replaceWith(DELIM));
        return (clone.innerText || clone.textContent || '').trim();
      });

      // Split each cell on the delimiter
      const splitCells = cellValues.map(v =>
        v.split(DELIM).map(s => s.trim()).filter(Boolean)
      );
      const maxSplit = Math.max(...splitCells.map(s => s.length));

      if (maxSplit <= 1) {
        // Normal single-staff row
        const row = {};
        headers.forEach((h, j) => { row[h || 'col' + j] = (splitCells[j] && splitCells[j][0]) || ''; });
        if (Object.values(row).some(v => v)) rows.push(row);
      } else {
        // Multi-staff row: expand into one row per staff member
        multiStaffExpanded += maxSplit - 1;
        for (let k = 0; k < maxSplit; k++) {
          const row = {};
          headers.forEach((h, j) => {
            const parts = splitCells[j];
            row[h || 'col' + j] = parts.length > 1
              ? (parts[k] !== undefined ? parts[k] : parts[parts.length - 1])
              : (parts[0] || '');
          });
          if (Object.values(row).some(v => v)) rows.push(row);
        }
      }
    }
  });

  if (!rows.length) { setStatus('error', 'Tables found but no data rows.'); return; }
  const skipped = tables.length - matchingTables.length;
  const expandedNote = multiStaffExpanded ? ` ¬∑ ${multiStaffExpanded} multi-staff rows expanded` : '';
  columns = headers;
  rawRows = rows;
  setStatus('loaded', `Merged ${matchingTables.length} table${matchingTables.length>1?'s':''} ‚Üí ${rows.length} rows (${headers.length} columns: ${headers.join(', ')})${skipped ? ` ¬∑ ${skipped} non-matching table(s) ignored` : ''}${expandedNote}`);
  showMapping(pendingSourceName || 'Uploaded file');
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) { setStatus('error', 'CSV file appears empty.'); return; }
  const headers = parseCSVLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = parseCSVLine(lines[i]);
    const row = {};
    headers.forEach((h, j) => { row[h] = vals[j] || ''; });
    if (Object.values(row).some(v => v)) rows.push(row);
  }
  columns = headers;
  rawRows = rows;
  setStatus('loaded', `Loaded ${rows.length} rows from CSV (${headers.length} columns: ${headers.join(', ')})`);
  showMapping(pendingSourceName || 'Uploaded file');
}

function parseCSVLine(line) {
  const result = [];
  let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur.trim()); cur = ''; }
    else { cur += c; }
  }
  result.push(cur.trim());
  return result;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PASTE / BOOKMARKLET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parsePaste() {
  const text = document.getElementById('pasteArea').value.trim();
  if (!text) { setStatus('error', 'Nothing pasted.'); return; }
  pendingSourceName = 'Pasted data ' + (sources.length + 1);
  pendingSourceIcon = 'üìã';
  try {
    const obj = JSON.parse(text);
    if (obj.type === 'table' && obj.rows) {
      columns = obj.headers;
      rawRows = obj.rows;
      setStatus('loaded', `Loaded ${rawRows.length} scraped rows (${columns.length} columns)`);
      showMapping(pendingSourceName || 'Pasted data');
      return;
    }
    if (obj.type === 'divs' && obj.rows) {
      // Try to parse pipe-separated rows
      rawRows = obj.rows.map((r, i) => ({ '_row': r, '_index': i }));
      columns = ['_row'];
      setStatus('loaded', `Loaded ${rawRows.length} div-scraped rows. Please map fields manually.`);
      showMapping(pendingSourceName || 'Pasted data');
      return;
    }
  } catch(e) {}
  // Try CSV
  if (text.includes(',') || text.includes('\t')) {
    const sep = text.includes('\t') ? '\t' : ',';
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const headers = lines[0].split(sep).map(h => h.trim().replace(/"/g,''));
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const vals = lines[i].split(sep).map(v => v.trim().replace(/"/g,''));
      const row = {};
      headers.forEach((h, j) => row[h] = vals[j] || '');
      rows.push(row);
    }
    columns = headers;
    rawRows = rows;
    setStatus('loaded', `Parsed ${rows.length} rows from pasted text`);
    showMapping(pendingSourceName || 'Pasted data');
    return;
  }
  setStatus('error', 'Could not parse pasted data. Try pasting JSON from the bookmarklet or CSV text.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLUMN MAPPING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showMapping(sourceName) {
  pendingSourceName = sourceName || pendingSourceName || 'Source ' + (sources.length + 1);
  const panel = document.getElementById('mappingPanel');
  const grid = document.getElementById('mappingGrid');
  grid.innerHTML = '';

  FIELD_KEYS.forEach(key => {
    const div = document.createElement('div');
    div.className = 'map-field';
    const label = document.createElement('label');
    label.textContent = FIELD_LABELS[key];
    const sel = document.createElement('select');
    sel.id = 'map_' + key;
    sel.innerHTML = '<option value="">‚Äî skip ‚Äî</option>';
    columns.forEach(col => {
      const opt = document.createElement('option');
      opt.value = col;
      opt.textContent = col;
      sel.appendChild(opt);
    });
    // Auto-detect
    const hints = AUTO_MAP_HINTS[key];
    const match = columns.find(c => hints.some(h => c.toLowerCase().includes(h)));
    if (match) sel.value = match;
    div.appendChild(label);
    div.appendChild(sel);
    grid.appendChild(div);
  });

  panel.classList.add('visible');
}

function applyMapping() {
  const mapping = {};
  FIELD_KEYS.forEach(key => {
    const sel = document.getElementById('map_' + key);
    if (sel && sel.value) mapping[key] = sel.value;
  });

  if (!mapping.staff && !mapping.module) {
    alert('Please map at least Staff or Module column.');
    return;
  }

  const newMapped = rawRows.map(row => {
    const r = {};
    FIELD_KEYS.forEach(key => {
      r[key] = mapping[key] ? (row[mapping[key]] || '') : '';
    });
    if (!r.duration && r.startTime && r.endTime) {
      r.duration = parseHours(r.startTime, r.endTime);
    }
    if (!r.duration) r.duration = 1;
    else r.duration = parseFloat(r.duration) || 1;
    if (!r.week && r.date) r.week = dateToWeek(r.date);
    if (!r.semester && r.week) r.semester = weekToSemester(parseInt(r.week));
    return r;
  }).filter(r => r.staff || r.module);

  // Add as a new source
  const sourceId = Date.now();
  sources.push({
    id: sourceId,
    name: pendingSourceName || ('Source ' + (sources.length + 1)),
    icon: pendingSourceIcon || 'üìÑ',
    rawRows: [...rawRows],
    columns: [...columns],
    mappedRows: newMapped,
  });

  // Rebuild merged mappedRows from all sources
  rebuildMappedRows();

  document.getElementById('mappingPanel').classList.remove('visible');
  // Reset pending
  rawRows = []; columns = []; pendingSourceName = ''; pendingSourceIcon = 'üìÑ';
  document.getElementById('fileInput').value = '';
  document.getElementById('pasteArea').value = '';
  renderSourcesList();
  buildResults();
}

function rebuildMappedRows() {
  mappedRows = sources.flatMap(s => s.mappedRows);
}

function removeSource(id) {
  sources = sources.filter(s => s.id !== id);
  if (!sources.length) {
    clearAll();
    return;
  }
  rebuildMappedRows();
  renderSourcesList();
  buildResults();
  setStatus('loaded', `${sources.length} source${sources.length!==1?'s':''} loaded ¬∑ ${mappedRows.length} total rows`);
}

function renderSourcesList() {
  const section = document.getElementById('sourcesSection');
  const list = document.getElementById('sourcesList');
  const label = document.getElementById('sourcesTotalLabel');
  if (!sources.length) { section.style.display = 'none'; return; }
  section.style.display = 'block';
  label.textContent = `${mappedRows.length} rows total`;
  list.innerHTML = sources.map(s => `
    <div class="source-item">
      <span class="source-icon">${s.icon}</span>
      <div class="source-info">
        <div class="source-name">${s.name}</div>
        <div class="source-meta">${s.mappedRows.length} rows ¬∑ ${[...new Set(s.mappedRows.map(r=>r.semester).filter(Boolean))].join(', ') || 'no semester detected'}</div>
      </div>
      <button class="source-remove" onclick="removeSource(${s.id})" title="Remove this source">‚úï</button>
    </div>
  `).join('');
}

function parseHours(start, end) {
  const toMins = s => {
    const m = s.match(/(\d+):(\d+)/);
    if (!m) return null;
    return parseInt(m[1])*60 + parseInt(m[2]);
  };
  // handle am/pm
  const toMins2 = s => {
    const m = s.match(/(\d+)(?::(\d+))?\s*(am|pm)/i);
    if (!m) return toMins(s);
    let h = parseInt(m[1]), mn = parseInt(m[2]||0);
    if (m[3].toLowerCase() === 'pm' && h !== 12) h += 12;
    if (m[3].toLowerCase() === 'am' && h === 12) h = 0;
    return h*60 + mn;
  };
  const s = toMins2(start), e = toMins2(end);
  if (s === null || e === null) return 1;
  return Math.max(0.5, (e - s) / 60);
}

function dateToWeek(dateStr) {
  try {
    const d = new Date(dateStr);
    if (isNaN(d)) return '';
    const jan1 = new Date(d.getFullYear(), 0, 1);
    return Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
  } catch { return ''; }
}

function weekToSemester(week) {
  if (!week) return 'Unknown';
  if (week <= 20) return 'Semester 1';
  if (week <= 40) return 'Semester 2';
  return 'Summer';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD RESULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildResults() {
  // Reset clash state on new data load
  clashData = { run: false, clashPairs: [], effectiveHours: {} };
  document.getElementById('clashBtn').classList.remove('active');
  document.getElementById('clashBtn').textContent = '‚ö° Detect Clashes';
  document.getElementById('clashSummaryText').textContent = '';
  document.getElementById('clashTab').style.display = 'none';

  document.getElementById('results').style.display = 'block';
  if (sources.length > 1) {
    setStatus('loaded', `${sources.length} sources loaded ¬∑ ${mappedRows.length} total rows`);
  }
  buildKPIs();
  populateFilters();
  renderStaffTable();
  renderModuleTable();
  renderWeekTable();
  renderSemesterTable();
  renderHeatmap();
  renderRawTable();
}

function buildKPIs() {
  const totalHrs = mappedRows.reduce((s, r) => s + r.duration, 0);
  const staffSet = new Set(mappedRows.map(r => r.staff).filter(Boolean));
  const moduleSet = new Set(mappedRows.map(r => r.module).filter(Boolean));
  const weekSet = new Set(mappedRows.map(r => r.week).filter(Boolean));
  const semSet = new Set(mappedRows.map(r => r.semester).filter(Boolean));

  const clashCount = clashData.run ? mappedRows.filter(r => r._clash).length : null;
  const effectiveTotalHrs = clashData.run
    ? Object.values(clashData.effectiveHours).reduce((s, h) => s + h, 0)
    : null;

  let kpis = [
    [mappedRows.length, 'Sessions', ''],
    [totalHrs.toFixed(1), 'Total Hours (raw)', ''],
    [staffSet.size, 'Staff Members', ''],
    [moduleSet.size, 'Modules', ''],
    [weekSet.size, 'Weeks', ''],
    [semSet.size, 'Semesters', ''],
  ];

  if (clashData.run) {
    kpis.push([clashCount, 'Clashing Sessions', 'kpi-clash']);
    kpis.push([effectiveTotalHrs.toFixed(1), 'Effective Hours', '']);
  }

  document.getElementById('kpiRow').innerHTML = kpis
    .map(([v, l, cls]) => `<div class="kpi ${cls}"><div class="val">${v}</div><div class="lbl">${l}</div></div>`).join('');
}

function populateFilters() {
  const sems = [...new Set(mappedRows.map(r => r.semester).filter(Boolean))].sort();
  const staffs = [...new Set(mappedRows.map(r => r.staff).filter(Boolean))].sort();

  const semSel = document.getElementById('staffSemFilter');
  semSel.innerHTML = '<option value="">All Semesters</option>' + sems.map(s => `<option>${s}</option>`).join('');

  const weekStaffSel = document.getElementById('weekStaffFilter');
  weekStaffSel.innerHTML = '<option value="">All Staff</option>' + staffs.map(s => `<option>${s}</option>`).join('');
}

// ‚îÄ‚îÄ Staff table ‚îÄ‚îÄ
function renderStaffTable() {
  const filter = document.getElementById('staffFilter').value.toLowerCase();
  const semF = document.getElementById('staffSemFilter').value;

  const data = {};
  mappedRows.forEach(r => {
    if (!r.staff) return;
    if (filter && !r.staff.toLowerCase().includes(filter)) return;
    if (semF && r.semester !== semF) return;
    if (!data[r.staff]) data[r.staff] = { sessions:0, hours:0, clashSessions:0, modules: new Set(), semesters: new Set() };
    data[r.staff].sessions++;
    data[r.staff].hours += r.duration;
    if (r._clash) data[r.staff].clashSessions++;
    if (r.module) data[r.staff].modules.add(r.module);
    if (r.semester) data[r.staff].semesters.add(r.semester);
  });

  const showClash = clashData.run;
  // Build drill-down index: staff ‚Üí their sessions
  window._drillData = window._drillData || {};
  Object.entries(data).forEach(([name]) => {
    window._drillData[name] = mappedRows.filter(r => r.staff === name);
  });
  const rows = Object.entries(data).map(([name, d]) => ({
    name,
    hours: d.hours,
    effectiveHours: showClash ? (clashData.effectiveHours[name] || d.hours) : null,
    clashSessions: d.clashSessions,
    sessions: d.sessions,
    modules: d.modules.size,
    semesters: [...d.semesters].join(', '),
    _drillKey: name,
    _drillLabel: 'Staff Member',
  }));

  const maxHrs = Math.max(...rows.map(r => r.hours), 1);

  const cols = [['name','Staff'], ['hours', showClash ? 'Raw Hours' : 'Hours']];
  if (showClash) cols.push(['effectiveHours','Effective Hours'], ['clashSessions','Clashes']);
  cols.push(['sessions','Sessions'], ['modules','Modules'], ['semesters','Semesters']);

  renderTable('staffTable', rows, cols,
    (row, key) => {
      if (key === 'hours') return `${row.hours.toFixed(1)}<span class="mini-bar"><span class="mini-bar-fill" style="width:${row.hours/maxHrs*100}%"></span></span>`;
      if (key === 'effectiveHours') {
        const eff = row.effectiveHours !== null ? row.effectiveHours : row.hours;
        const saved = row.hours - eff;
        return `<strong>${eff.toFixed(1)}</strong>${saved > 0.01 ? ` <span style="color:var(--danger);font-size:0.7rem;">(-${saved.toFixed(1)})</span>` : ''}`;
      }
      if (key === 'clashSessions') return row.clashSessions > 0
        ? `<span class="badge clash-badge">${row.clashSessions}</span>`
        : `<span class="badge safe-badge">0</span>`;
      if (key === 'sessions') return `<span class="badge badge-teal">${row.sessions}</span>`;
      return row[key];
    }
  );
}

// ‚îÄ‚îÄ Module table ‚îÄ‚îÄ
function renderModuleTable() {
  const filter = document.getElementById('moduleFilter').value.toLowerCase();
  const data = {};
  mappedRows.forEach(r => {
    if (!r.module) return;
    if (filter && !r.module.toLowerCase().includes(filter)) return;
    if (!data[r.module]) data[r.module] = { sessions:0, hours:0, staff: new Set(), weeks: new Set() };
    data[r.module].sessions++;
    data[r.module].hours += r.duration;
    if (r.staff) data[r.module].staff.add(r.staff);
    if (r.week) data[r.module].weeks.add(r.week);
  });

  window._drillData = window._drillData || {};
  Object.entries(data).forEach(([mod]) => {
    window._drillData[mod] = mappedRows.filter(r => r.module === mod);
  });
  const rows = Object.entries(data).map(([mod, d]) => ({
    module: mod, sessions: d.sessions, hours: d.hours,
    staffCount: d.staff.size, weekCount: d.weeks.size,
    _drillKey: mod, _drillLabel: 'Module',
  }));

  const maxHrs = Math.max(...rows.map(r => r.hours), 1);

  renderTable('moduleTable', rows,
    [['module','Module'], ['hours','Total Hours'], ['sessions','Sessions'], ['staffCount','Staff'], ['weekCount','Weeks Active']],
    (row, key) => {
      if (key === 'hours') return `${row.hours.toFixed(1)}<span class="mini-bar"><span class="mini-bar-fill" style="width:${row.hours/maxHrs*100}%"></span></span>`;
      if (key === 'sessions') return `<span class="badge badge-yellow">${row.sessions}</span>`;
      return row[key];
    }
  );
}

// ‚îÄ‚îÄ Week table ‚îÄ‚îÄ
function renderWeekTable() {
  const staffF = document.getElementById('weekStaffFilter').value;
  const data = {};
  mappedRows.forEach(r => {
    if (!r.week) return;
    if (staffF && r.staff !== staffF) return;
    if (!data[r.week]) data[r.week] = { sessions:0, hours:0, staff: new Set(), modules: new Set() };
    data[r.week].sessions++;
    data[r.week].hours += r.duration;
    if (r.staff) data[r.week].staff.add(r.staff);
    if (r.module) data[r.week].modules.add(r.module);
  });

  window._drillData = window._drillData || {};
  Object.entries(data).forEach(([wk]) => {
    window._drillData['Week ' + wk] = mappedRows.filter(r => String(r.week) === String(wk));
  });
  const rows = Object.entries(data).sort((a, b) => a[0].localeCompare(b[0], undefined, {numeric:true})).map(([wk, d]) => ({
    week: wk, sessions: d.sessions, hours: d.hours,
    staffCount: d.staff.size, moduleCount: d.modules.size,
    _drillKey: 'Week ' + wk, _drillLabel: 'Week',
  }));

  const maxHrs = Math.max(...rows.map(r => r.hours), 1);
  renderTable('weekTable', rows,
    [['week','Week'], ['hours','Hours'], ['sessions','Sessions'], ['staffCount','Staff Active'], ['moduleCount','Modules']],
    (row, key) => {
      if (key === 'hours') return `${row.hours.toFixed(1)}<span class="mini-bar"><span class="mini-bar-fill" style="width:${row.hours/maxHrs*100}%"></span></span>`;
      if (key === 'sessions') return `<span class="badge badge-purple">${row.sessions}</span>`;
      return row[key];
    }
  );
}

// ‚îÄ‚îÄ Semester table ‚îÄ‚îÄ
function renderSemesterTable() {
  const data = {};
  mappedRows.forEach(r => {
    const sem = r.semester || 'Unknown';
    if (!data[sem]) data[sem] = { sessions:0, hours:0, staff: new Set(), modules: new Set() };
    data[sem].sessions++;
    data[sem].hours += r.duration;
    if (r.staff) data[sem].staff.add(r.staff);
    if (r.module) data[sem].modules.add(r.module);
  });

  window._drillData = window._drillData || {};
  Object.entries(data).forEach(([sem]) => {
    window._drillData[sem] = mappedRows.filter(r => (r.semester || 'Unknown') === sem);
  });
  const rows = Object.entries(data).map(([sem, d]) => ({
    semester: sem, sessions: d.sessions, hours: d.hours,
    staffCount: d.staff.size, moduleCount: d.modules.size,
    avgPerStaff: d.staff.size ? (d.hours / d.staff.size).toFixed(1) : '‚Äî',
    _drillKey: sem, _drillLabel: 'Semester',
  }));

  renderTable('semesterTable', rows,
    [['semester','Semester'], ['hours','Total Hours'], ['sessions','Sessions'], ['staffCount','Staff'], ['moduleCount','Modules'], ['avgPerStaff','Avg Hrs/Staff']],
    (row, key) => {
      if (key === 'sessions') return `<span class="badge badge-teal">${row.sessions}</span>`;
      if (key === 'hours') return `<strong>${parseFloat(row.hours).toFixed(1)}</strong>`;
      return row[key];
    }
  );
}

// ‚îÄ‚îÄ Raw table ‚îÄ‚îÄ
function renderRawTable() {
  const filter = document.getElementById('rawFilter').value.toLowerCase();
  const rows = filter ? mappedRows.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(filter))) : mappedRows;
  const cols = FIELD_KEYS.filter(k => rows.some(r => r[k]));
  renderTable('rawTable', rows,
    cols.map(k => [k, FIELD_LABELS[k]]),
    (row, key) => {
      let val = row[key] !== undefined ? row[key] : '';
      if (key === 'staff' && row._clash) {
        return `${val}<span class="clash-pill" title="${row._clashWith || 'Overlaps with another session'}">‚ö† clash</span>`;
      }
      return val;
    },
    50,
    row => row._clash ? 'clash-row' : ''
  );
}

// ‚îÄ‚îÄ Clash table ‚îÄ‚îÄ
function renderClashTable() {
  const filter = document.getElementById('clashFilter').value.toLowerCase();
  let pairs = clashData.clashPairs;
  if (filter) pairs = pairs.filter(p =>
    p.staff.toLowerCase().includes(filter) ||
    (p.moduleA||'').toLowerCase().includes(filter) ||
    (p.moduleB||'').toLowerCase().includes(filter)
  );
  if (!pairs.length) {
    document.getElementById('clashTable').innerHTML = '<div class="empty-state"><div class="big">‚úÖ</div><p>No clashes found.</p></div>';
    return;
  }
  const cols = [['staff','Staff'],['dateA','Date'],['timeA','Session A'],['moduleA','Module A'],['timeB','Session B'],['moduleB','Module B'],['overlapMins','Overlap (mins)']];
  renderTable('clashTable', pairs, cols, (row, key) => {
    if (key === 'overlapMins') return `<span class="badge clash-badge">${row[key]} min${row[key]!==1?'s':''}</span>`;
    if (key === 'staff') return `<strong>${row[key]}</strong>`;
    return row[key] || '‚Äî';
  });
}

// ‚îÄ‚îÄ Generic table renderer ‚îÄ‚îÄ
function renderTable(containerId, rows, cols, cellFn, limit = null, rowClassFn = null) {
  const container = document.getElementById(containerId);
  if (!rows.length) { container.innerHTML = '<div class="empty-state"><div class="big">üîç</div><p>No data to display.</p></div>'; return; }

  const state = sortState[containerId] || { col: null, dir: 1 };
  if (state.col) {
    rows = [...rows].sort((a, b) => {
      const av = isNaN(a[state.col]) ? a[state.col] : parseFloat(a[state.col]);
      const bv = isNaN(b[state.col]) ? b[state.col] : parseFloat(b[state.col]);
      return av > bv ? state.dir : av < bv ? -state.dir : 0;
    });
  }

  const displayRows = limit ? rows.slice(0, limit) : rows;

  const thead = `<thead><tr>${cols.map(([k, l]) => {
    let cls = '';
    if (state.col === k) cls = state.dir === 1 ? 'sort-asc' : 'sort-desc';
    return `<th class="${cls}" onclick="sortTable('${containerId}','${k}')">${l}</th>`;
  }).join('')}</tr></thead>`;

  const tbody = `<tbody>${displayRows.map(row => {
    const cls = (rowClassFn ? rowClassFn(row) : '') + (row._drillKey ? ' clickable-row' : '');
    const clickAttr = row._drillKey ? `onclick="openDrawer('${row._drillLabel||''}','${(row._drillKey||'').replace(/'/g,"\'")}',window._drillData&&window._drillData['${(row._drillKey||'').replace(/'/g,"\'")}']||[])"` : '';
    return `<tr class="${cls.trim()}" ${clickAttr}>${cols.map(([k]) => `<td>${cellFn ? cellFn(row, k) : (row[k] ?? '')}</td>`).join('')}</tr>`;
  }).join('')}${limit && rows.length > limit ? `<tr><td colspan="${cols.length}" style="text-align:center;color:var(--muted);font-family:'DM Mono',monospace;font-size:0.72rem;padding:16px;">‚Ä¶ and ${rows.length - limit} more rows</td></tr>` : ''}</tbody>`;

  container.innerHTML = `<table>${thead}${tbody}</table>`;
}

function sortTable(containerId, col) {
  const state = sortState[containerId] || { col: null, dir: 1 };
  if (state.col === col) state.dir *= -1;
  else { state.col = col; state.dir = -1; }
  sortState[containerId] = state;
  // Re-render
  const fns = { staffTable: renderStaffTable, moduleTable: renderModuleTable, weekTable: renderWeekTable, semesterTable: renderSemesterTable, rawTable: renderRawTable };
  if (fns[containerId]) fns[containerId]();
}

// ‚îÄ‚îÄ Heatmap (staff √ó week) ‚îÄ‚îÄ
function renderHeatmap() {
  const metric = document.getElementById('heatmapMetric').value;
  const staffList = [...new Set(mappedRows.map(r => r.staff).filter(Boolean))].sort();
  const weekList = [...new Set(mappedRows.map(r => r.week).filter(Boolean))].sort((a, b) => a - b);

  if (!staffList.length || !weekList.length) {
    document.getElementById('heatmapContainer').innerHTML = '<div class="empty-state"><div class="big">üìä</div><p>Need staff and week data for heatmap.</p></div>';
    return;
  }

  const grid = {};
  mappedRows.forEach(r => {
    if (!r.staff || !r.week) return;
    const k = `${r.staff}__${r.week}`;
    if (!grid[k]) grid[k] = { hours: 0, sessions: 0 };
    grid[k].hours += r.duration;
    grid[k].sessions++;
  });

  const vals = Object.values(grid).map(v => metric === 'hours' ? v.hours : v.sessions);
  const maxVal = Math.max(...vals, 1);

  const heatColour = (v, max) => {
    const t = v / max;
    if (t === 0) return `rgba(16,38,59,0.07)`;
    // Gradient: light blue-grey ‚Üí Nottingham Blue ‚Üí Rebels Gold at peak
    const r = Math.round(16 + (222-16)*t);
    const g = Math.round(38 + (180-38)*t*0.6);
    const b = Math.round(59 + (6-59)*t);
    return `rgb(${r},${g},${b})`;
  };

  const headerRow = `<div class="heatmap-row"><div class="heatmap-label"></div>${weekList.map(w => `<div class="heatmap-week-header">W${w}</div>`).join('')}</div>`;

  const rows = staffList.map(staff => {
    const cells = weekList.map(wk => {
      const k = `${staff}__${wk}`;
      const v = grid[k] ? (metric === 'hours' ? grid[k].hours : grid[k].sessions) : 0;
      const bg = heatColour(v, maxVal);
      const textCol = v/maxVal > 0.5 ? 'rgba(255,255,255,0.9)' : 'rgba(16,38,59,0.8)';
      const label = v > 0 ? (metric === 'hours' ? v.toFixed(1) : v) : '';
      return `<div class="heatmap-cell" style="background:${bg}" title="${staff} ¬∑ Week ${wk}: ${v > 0 ? (metric==='hours' ? v.toFixed(1)+' hrs' : v+' sessions') : 'none'}" style="color:${textCol}">${label}</div>`;
    }).join('');
    return `<div class="heatmap-row"><div class="heatmap-label" title="${staff}">${staff}</div>${cells}</div>`;
  }).join('');

  document.getElementById('heatmapContainer').innerHTML = `<div class="heatmap-grid">${headerRow}${rows}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLASH DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let clashData = { run: false, clashPairs: [], effectiveHours: {} };

function toAbsMinutes(row) {
  // Returns [start, end] in absolute minutes, using date + time.
  // Falls back to time-only (treating same day if no date).
  const parseTime = t => {
    if (!t) return null;
    const ampm = t.match(/(\d+)(?::(\d+))?\s*(am|pm)/i);
    if (ampm) {
      let h = parseInt(ampm[1]), m = parseInt(ampm[2]||0);
      if (ampm[3].toLowerCase()==='pm' && h!==12) h+=12;
      if (ampm[3].toLowerCase()==='am' && h===12) h=0;
      return h*60+m;
    }
    const hm = t.match(/(\d+):(\d+)/);
    if (hm) return parseInt(hm[1])*60+parseInt(hm[2]);
    return null;
  };

  let dayOffset = 0;
  if (row.date) {
    try {
      const d = new Date(row.date);
      if (!isNaN(d)) dayOffset = Math.floor(d.getTime() / 86400000) * 1440;
    } catch(e) {}
  }

  const st = parseTime(row.startTime);
  let en = parseTime(row.endTime);
  if (st === null) return null;
  if (en === null) en = st + Math.round((row.duration || 1) * 60);

  return [dayOffset + st, dayOffset + en];
}

function mergeIntervals(intervals) {
  // Returns total minutes covered by merged intervals
  if (!intervals.length) return 0;
  intervals.sort((a, b) => a[0] - b[0]);
  let merged = [intervals[0]];
  for (let i = 1; i < intervals.length; i++) {
    const last = merged[merged.length - 1];
    if (intervals[i][0] < last[1]) {
      last[1] = Math.max(last[1], intervals[i][1]);
    } else {
      merged.push(intervals[i]);
    }
  }
  return merged.reduce((s, [a, b]) => s + (b - a), 0) / 60;
}

function runClashDetection() {
  // Check we have enough time info
  const hasTime = mappedRows.some(r => r.startTime || r.endTime);
  if (!hasTime) {
    alert('Clash detection needs Start Time and/or End Time columns mapped. Please re-map your columns and include time fields.');
    return;
  }

  // Show working state immediately, then do the work after the browser has painted
  const btn = document.getElementById('clashBtn');
  btn.textContent = '‚è≥ Working‚Ä¶';
  btn.disabled = true;
  document.getElementById('clashSummaryText').textContent = 'Analysing sessions‚Ä¶';

  setTimeout(() => {
    // Reset row flags
    mappedRows.forEach(r => { r._clash = false; r._clashWith = ''; });

    // Group rows by staff member
    const byStaff = {};
    mappedRows.forEach((r, idx) => {
      if (!r.staff) return;
      if (!byStaff[r.staff]) byStaff[r.staff] = [];
      byStaff[r.staff].push({ row: r, idx, interval: toAbsMinutes(r) });
    });

    const clashPairs = [];
    const effectiveHours = {};

    Object.entries(byStaff).forEach(([staff, sessions]) => {
      // Compute effective hours (merging overlapping intervals)
      const intervals = sessions.map(s => s.interval).filter(Boolean);
      effectiveHours[staff] = intervals.length
        ? mergeIntervals(intervals)
        : sessions.reduce((s, x) => s + (x.row.duration || 1), 0);

      // Find clashing pairs
      for (let i = 0; i < sessions.length; i++) {
        for (let j = i + 1; j < sessions.length; j++) {
          const a = sessions[i], b = sessions[j];
          if (!a.interval || !b.interval) continue;
          const overlapStart = Math.max(a.interval[0], b.interval[0]);
          const overlapEnd   = Math.min(a.interval[1], b.interval[1]);
          if (overlapEnd > overlapStart) {
            const overlapMins = Math.round(overlapEnd - overlapStart);
            const descA = `${a.row.startTime||'?'}‚Äì${a.row.endTime||'?'} ${a.row.module||''}`.trim();
            const descB = `${b.row.startTime||'?'}‚Äì${b.row.endTime||'?'} ${b.row.module||''}`.trim();
            a.row._clash = true;
            b.row._clash = true;
            a.row._clashWith = `Clashes with: ${descB}`;
            b.row._clashWith = `Clashes with: ${descA}`;
            clashPairs.push({
              staff,
              dateA: a.row.date || a.row.week ? `${a.row.date||''} W${a.row.week||''}`.trim() : '‚Äî',
              timeA: `${a.row.startTime||'?'}‚Äì${a.row.endTime||'?'}`,
              moduleA: a.row.module || '‚Äî',
              timeB: `${b.row.startTime||'?'}‚Äì${b.row.endTime||'?'}`,
              moduleB: b.row.module || '‚Äî',
              overlapMins,
            });
          }
        }
      }
    });

    clashData = { run: true, clashPairs, effectiveHours };

    btn.disabled = false;
    btn.classList.add('active');
    btn.textContent = `‚ö° ${clashPairs.length} Clash${clashPairs.length !== 1 ? 'es' : ''} Found`;

    const clashTab = document.getElementById('clashTab');
    clashTab.style.display = '';
    document.getElementById('clashSummaryText').textContent =
      clashPairs.length === 0
        ? 'No simultaneous sessions detected.'
        : `${clashPairs.length} overlap${clashPairs.length!==1?'s':''} across ${new Set(clashPairs.map(p=>p.staff)).size} staff member${new Set(clashPairs.map(p=>p.staff)).size!==1?'s':''}.`;

    // Rebuild everything
    buildKPIs();
    renderStaffTable();
    renderRawTable();
    renderClashTable();

    if (clashPairs.length > 0) switchTab('clashes');
  }, 50); // 50ms gap lets the browser paint the "Working‚Ä¶" state before blocking
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRILL-DOWN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDrawer(label, title, sessions) {
  document.getElementById('ddLabel').textContent = label;
  document.getElementById('ddTitle').textContent = title;

  // Stats bar
  const totalHrs = sessions.reduce((s, r) => s + (r.duration || 1), 0);
  const staffSet = new Set(sessions.map(r => r.staff).filter(Boolean));
  const moduleSet = new Set(sessions.map(r => r.module).filter(Boolean));
  const clashCount = sessions.filter(r => r._clash).length;
  const stats = [
    [sessions.length, 'Sessions'],
    [totalHrs.toFixed(1), 'Hours'],
    [moduleSet.size > 1 ? moduleSet.size : staffSet.size,
     moduleSet.size > 1 ? 'Modules' : 'Staff'],
  ];
  if (clashData.run) stats.push([clashCount, 'Clashes']);
  document.getElementById('ddStats').innerHTML = stats
    .map(([v, l]) => `<div class="dd-stat"><div class="dd-stat-val">${v}</div><div class="dd-stat-lbl">${l}</div></div>`)
    .join('');

  // Group sessions: by week > date > time
  const grouped = {};
  sessions.forEach(r => {
    const grpKey = r.week ? `Week ${r.week}` : (r.date || r.semester || 'Unscheduled');
    if (!grouped[grpKey]) grouped[grpKey] = [];
    grouped[grpKey].push(r);
  });
  // Sort groups numerically by week number where possible
  const sortedGroups = Object.keys(grouped).sort((a, b) => {
    const na = parseInt(a.replace(/\D/g,'')), nb = parseInt(b.replace(/\D/g,''));
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    return a.localeCompare(b);
  });

  let html = '';
  sortedGroups.forEach(grp => {
    const grpSessions = grouped[grp].sort((a, b) => {
      const ta = a.startTime || '', tb = b.startTime || '';
      return ta.localeCompare(tb);
    });
    html += `<div class="dd-section-head">${grp} ‚Äî ${grpSessions.length} session${grpSessions.length!==1?'s':''}</div>`;
    grpSessions.forEach(r => {
      const timeStr = r.startTime ? `${r.startTime}${r.endTime ? '‚Äì'+r.endTime : ''}` : '‚Äî';
      const meta = [r.type, r.room].filter(Boolean).join(' ¬∑ ');
      const clashClass = r._clash ? ' is-clash' : '';
      const staffOrMod = label === 'Staff Member' ? (r.module || '‚Äî') : (r.staff || '‚Äî');
      const secondaryLabel = label === 'Staff Member' ? '' :
        `<div class="dd-meta">${r.staff || ''}</div>`;
      html += `<div class="dd-session-row${clashClass}">
        <div class="dd-time">${timeStr}</div>
        <div>
          <div class="dd-module">${staffOrMod}</div>
          ${secondaryLabel}
          ${meta ? `<div class="dd-meta">${meta}</div>` : ''}
        </div>
        <div>
          <div class="dd-hrs">${(r.duration||1).toFixed(1)}h</div>
          ${r._clash ? '<div class="dd-clash-flag">‚ö† clash</div>' : ''}
        </div>
      </div>`;
    });
  });

  document.getElementById('ddBody').innerHTML = html;
  document.getElementById('ddOverlay').classList.add('open');
  document.getElementById('ddPanel').classList.add('open');
}

function closeDrawer() {
  document.getElementById('ddOverlay').classList.remove('open');
  document.getElementById('ddPanel').classList.remove('open');
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeDrawer();
    document.getElementById('faqModal').classList.remove('open');
  }
});

function switchImportMethod(method) {
  document.querySelectorAll('.import-method-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.import-method-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('importPane-' + method).classList.add('active');
  document.getElementById(method === 'upload' ? 'methodBtn1' : 'methodBtn2').classList.add('active');
}

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  // Find the tab button that calls switchTab with this name
  document.querySelectorAll('.tab').forEach(t => {
    if (t.getAttribute('onclick') === `switchTab('${name}')`) t.classList.add('active');
  });
  document.getElementById('tab-' + name).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(type) {
  let rows, headers;
  if (type === 'raw') {
    headers = FIELD_KEYS;
    rows = mappedRows.map(r => FIELD_KEYS.map(k => `"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(','));
  } else if (type === 'staff') {
    headers = ['Staff','Hours','Sessions','Modules'];
    const data = {};
    mappedRows.forEach(r => {
      if (!r.staff) return;
      if (!data[r.staff]) data[r.staff] = {sessions:0,hours:0,modules:new Set()};
      data[r.staff].sessions++;
      data[r.staff].hours += r.duration;
      if (r.module) data[r.staff].modules.add(r.module);
    });
    rows = Object.entries(data).map(([n,d]) => `"${n}",${d.hours.toFixed(1)},${d.sessions},${d.modules.size}`);
  } else if (type === 'module') {
    headers = ['Module','Hours','Sessions','Staff'];
    const data = {};
    mappedRows.forEach(r => {
      if (!r.module) return;
      if (!data[r.module]) data[r.module] = {sessions:0,hours:0,staff:new Set()};
      data[r.module].sessions++;
      data[r.module].hours += r.duration;
      if (r.staff) data[r.module].staff.add(r.staff);
    });
    rows = Object.entries(data).map(([m,d]) => `"${m}",${d.hours.toFixed(1)},${d.sessions},${d.staff.size}`);
  } else if (type === 'week') {
    headers = ['Week','Hours','Sessions','Staff'];
    const data = {};
    mappedRows.forEach(r => {
      if (!r.week) return;
      if (!data[r.week]) data[r.week] = {sessions:0,hours:0,staff:new Set()};
      data[r.week].sessions++;
      data[r.week].hours += r.duration;
      if (r.staff) data[r.week].staff.add(r.staff);
    });
    rows = Object.entries(data).sort((a,b)=>a[0]-b[0]).map(([w,d]) => `${w},${d.hours.toFixed(1)},${d.sessions},${d.staff.size}`);
  }
  if (type === 'clashes') {
    headers = ['Staff','Date','Session A Time','Module A','Session B Time','Module B','Overlap (mins)'];
    rows = clashData.clashPairs.map(p =>
      [`"${p.staff}"`, `"${p.dateA||''}"`, `"${p.timeA}"`, `"${p.moduleA}"`, `"${p.timeB}"`, `"${p.moduleB}"`, p.overlapMins].join(',')
    );
  }
  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `timetable_${type}_${Date.now()}.csv`;
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setStatus(type, msg) {
  const bar = document.getElementById('statusBar');
  bar.className = 'status-bar ' + type;
  document.getElementById('statusText').textContent = msg;
}

function clearAll() {
  sources = []; rawRows = []; mappedRows = []; columns = [];
  pendingSourceName = ''; pendingSourceIcon = 'üìÑ';
  document.getElementById('pasteArea').value = '';
  document.getElementById('fileInput').value = '';
  document.getElementById('results').style.display = 'none';
  document.getElementById('mappingPanel').classList.remove('visible');
  document.getElementById('sourcesSection').style.display = 'none';
  document.getElementById('sourcesList').innerHTML = '';
  setStatus('', 'No data loaded. Upload a file or paste scraped data to begin.');
}
</script>
</body>
</html>
