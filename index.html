<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timetable Load Analyser</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0f13;
    --surface: #16181f;
    --surface2: #1e2029;
    --border: #2a2d3a;
    --accent: #e8c547;
    --accent2: #4ec9b0;
    --accent3: #c586c0;
    --text: #e0e2ea;
    --muted: #6b7080;
    --danger: #f47067;
    --success: #4ec9b0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-weight: 300;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  header {
    border-bottom: 1px solid var(--border);
    padding: 20px 40px;
    display: flex;
    align-items: center;
    gap: 16px;
    background: var(--surface);
  }
  header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 900;
    letter-spacing: -0.02em;
    color: var(--accent);
  }
  header span {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    background: var(--surface2);
    padding: 3px 8px;
    border-radius: 4px;
    border: 1px solid var(--border);
  }

  main { padding: 40px; max-width: 1400px; margin: 0 auto; }

  /* ‚îÄ‚îÄ Import panel ‚îÄ‚îÄ */
  .import-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 40px;
  }
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
  }
  .panel h2 {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--accent);
    margin-bottom: 16px;
  }
  .panel p { color: var(--muted); font-size: 0.875rem; line-height: 1.6; margin-bottom: 16px; }

  .dropzone {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--muted);
    font-size: 0.875rem;
  }
  .dropzone:hover, .dropzone.drag-over {
    border-color: var(--accent);
    background: rgba(232,197,71,0.04);
    color: var(--accent);
  }
  .dropzone input { display: none; }
  .dropzone .icon { font-size: 2rem; margin-bottom: 8px; }

  .bookmarklet-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .bookmarklet-box code {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent2);
    word-break: break-all;
    display: block;
    margin-bottom: 12px;
    line-height: 1.6;
  }
  .btn {
    display: inline-block;
    padding: 8px 18px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-accent { background: var(--accent); color: #0e0f13; }
  .btn-accent:hover { background: #f0d060; }
  .btn-outline { background: transparent; color: var(--text); border: 1px solid var(--border); }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-sm { padding: 5px 12px; font-size: 0.75rem; }

  .drag-link {
    display: inline-block;
    padding: 8px 16px;
    background: var(--accent3);
    color: #fff;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: grab;
    text-decoration: none;
    margin-top: 4px;
  }
  .drag-link:hover { background: #d499cc; }

  /* ‚îÄ‚îÄ Paste area ‚îÄ‚îÄ */
  textarea.paste-area {
    width: 100%;
    height: 120px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 12px;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
  }
  textarea.paste-area:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ */
  .status-bar {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 32px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .status-bar .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
  }
  .status-bar.loaded .dot { background: var(--success); }
  .status-bar.loaded { color: var(--success); }
  .status-bar.error .dot { background: var(--danger); }
  .status-bar.error { color: var(--danger); }

  /* ‚îÄ‚îÄ Field mapping ‚îÄ‚îÄ */
  .mapping-panel { display: none; }
  .mapping-panel.visible { display: block; }
  .mapping-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }
  .map-field label {
    display: block;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 5px;
  }
  .map-field select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 7px 10px;
    outline: none;
    cursor: pointer;
  }
  .map-field select:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0;
  }
  .tab {
    padding: 10px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    cursor: pointer;
    border-radius: 6px 6px 0 0;
    border: 1px solid transparent;
    border-bottom: none;
    transition: all 0.15s;
    position: relative;
    top: 1px;
  }
  .tab:hover { color: var(--text); }
  .tab.active {
    background: var(--surface);
    border-color: var(--border);
    color: var(--accent);
  }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* ‚îÄ‚îÄ Summary cards ‚îÄ‚îÄ */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }
  .kpi {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
  }
  .kpi .val {
    font-family: 'Playfair Display', serif;
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 6px;
  }
  .kpi .lbl {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  /* ‚îÄ‚îÄ Data tables ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }
  thead tr { border-bottom: 2px solid var(--border); }
  th {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--muted);
    text-align: left;
    padding: 10px 14px;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
  }
  th:hover { color: var(--accent); }
  th.sort-asc::after { content: ' ‚Üë'; color: var(--accent); }
  th.sort-desc::after { content: ' ‚Üì'; color: var(--accent); }
  td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }
  tbody tr:hover td { background: rgba(255,255,255,0.02); }
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    font-weight: 500;
  }
  .badge-teal { background: rgba(78,201,176,0.15); color: var(--accent2); }
  .badge-yellow { background: rgba(232,197,71,0.15); color: var(--accent); }
  .badge-purple { background: rgba(197,134,192,0.15); color: var(--accent3); }

  /* ‚îÄ‚îÄ Bar mini charts ‚îÄ‚îÄ */
  .mini-bar {
    height: 6px;
    border-radius: 3px;
    background: var(--border);
    overflow: hidden;
    min-width: 80px;
    display: inline-block;
    vertical-align: middle;
    margin-left: 8px;
  }
  .mini-bar-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--accent);
    transition: width 0.4s;
  }

  /* ‚îÄ‚îÄ Heatmap ‚îÄ‚îÄ */
  .heatmap-grid {
    display: grid;
    gap: 4px;
  }
  .heatmap-row { display: flex; gap: 4px; align-items: center; }
  .heatmap-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    width: 120px;
    flex-shrink: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .heatmap-cell {
    width: 36px;
    height: 28px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: rgba(0,0,0,0.7);
    font-weight: 500;
    transition: transform 0.15s;
    cursor: default;
    position: relative;
  }
  .heatmap-cell:hover { transform: scale(1.2); z-index: 10; }
  .heatmap-week-header {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--muted);
    width: 36px;
    text-align: center;
  }

  /* ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ */
  .filter-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .filter-bar input, .filter-bar select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 7px 12px;
    outline: none;
    transition: border-color 0.2s;
  }
  .filter-bar input:focus, .filter-bar select:focus { border-color: var(--accent); }
  .filter-bar input { min-width: 200px; }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--muted);
  }
  .empty-state .big { font-size: 3rem; margin-bottom: 16px; }
  .empty-state p { font-size: 0.875rem; line-height: 1.6; }

  /* ‚îÄ‚îÄ Export bar ‚îÄ‚îÄ */
  .export-bar {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-bottom: 16px;
  }

  /* ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ */
  .tooltip {
    position: fixed;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--text);
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
    display: none;
  }


  /* ‚îÄ‚îÄ Clash detection ‚îÄ‚îÄ */
  .clash-btn { background: var(--danger); color: #fff; }
  .clash-btn:hover { background: #ff8a82; }
  .clash-btn.active { background: #7a1a16; border: 1px solid var(--danger); color: var(--danger); }
  .clash-badge { background: rgba(244,112,103,0.18); color: var(--danger); border: 1px solid rgba(244,112,103,0.3); }
  .safe-badge { background: rgba(78,201,176,0.12); color: var(--accent2); }
  tr.clash-row td { background: rgba(244,112,103,0.08) !important; }
  tr.clash-row td:first-child { border-left: 3px solid var(--danger); }
  .clash-pill {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    background: rgba(244,112,103,0.18);
    color: var(--danger);
    border: 1px solid rgba(244,112,103,0.3);
    cursor: help;
    margin-left: 6px;
  }
  .kpi.kpi-clash { border-color: rgba(244,112,103,0.4); }
  .kpi.kpi-clash .val { color: var(--danger); }
  @media (max-width: 768px) {
    main { padding: 20px; }
    .import-grid { grid-template-columns: 1fr; }
    header { padding: 16px 20px; }
  }
</style>
</head>
<body>

<header>
  <h1>Timetable Load Analyser</h1>
  <span>v1.0</span>
</header>

<main>

  <!-- ‚îÄ‚îÄ Import Section ‚îÄ‚îÄ -->
  <div class="import-grid">

    <!-- File Upload -->
    <div class="panel">
      <h2>üìÅ Upload HTML / CSV</h2>
      <p>Download your timetable page as HTML (File ‚Üí Save As in your browser) or export as CSV, then drop it here.</p>
      <div class="dropzone" id="dropzone">
        <input type="file" id="fileInput" accept=".html,.htm,.csv,.txt">
        <div class="icon">‚¨Ü</div>
        <div>Drop file here or <strong>click to browse</strong></div>
        <div style="margin-top:6px;font-size:0.75rem;">Supports .html ¬∑ .htm ¬∑ .csv</div>
      </div>
    </div>

    <!-- Bookmarklet -->
    <div class="panel">
      <h2>üîñ Bookmarklet Scraper</h2>
      <p>Drag the button below to your bookmarks bar. Then navigate to your timetable page and click it ‚Äî the data will be copied to your clipboard, ready to paste below.</p>
      <div class="bookmarklet-box">
        <code id="bookmarkletCode">javascript:(function(){/* generated below */})()</code>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <a id="bookmarkletLink" href="#" class="drag-link" title="Drag me to your bookmarks bar!">üîñ Scrape Timetable</a>
          <button class="btn btn-outline btn-sm" onclick="copyBookmarklet()">Copy Code</button>
        </div>
      </div>
      <p style="font-size:0.75rem;">After clicking the bookmarklet on your timetable page, paste the result below:</p>
      <textarea class="paste-area" id="pasteArea" placeholder="Paste scraped JSON or HTML table data here‚Ä¶"></textarea>
      <div style="margin-top:10px;display:flex;gap:8px;">
        <button class="btn btn-accent" onclick="parsePaste()">Parse Pasted Data</button>
        <button class="btn btn-outline" onclick="clearAll()">Clear</button>
      </div>
    </div>

  </div>

  <!-- ‚îÄ‚îÄ Status ‚îÄ‚îÄ -->
  <div class="status-bar" id="statusBar">
    <div class="dot"></div>
    <span id="statusText">No data loaded. Upload a file or paste scraped data to begin.</span>
  </div>

  <!-- ‚îÄ‚îÄ Field Mapping ‚îÄ‚îÄ -->
  <div class="panel mapping-panel" id="mappingPanel" style="margin-bottom:32px;">
    <h2>üóÇ Column Mapping</h2>
    <p>Tell the analyser which column corresponds to which field. Auto-detected columns are pre-selected.</p>
    <div class="mapping-grid" id="mappingGrid"></div>
    <div style="margin-top:20px;display:flex;gap:8px;">
      <button class="btn btn-accent" onclick="applyMapping()">Analyse ‚Üí</button>
      <button class="btn btn-outline" onclick="document.getElementById('mappingPanel').classList.remove('visible')">Cancel</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Analysis Results ‚îÄ‚îÄ -->
  <div id="results" style="display:none;">

    <!-- KPIs -->
    <div class="kpi-row" id="kpiRow"></div>

    <!-- Clash detection button -->
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
      <button class="btn clash-btn" id="clashBtn" onclick="runClashDetection()">‚ö° Detect Clashes</button>
      <span id="clashSummaryText" style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--muted);"></span>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('staff')">By Staff</div>
      <div class="tab" onclick="switchTab('module')">By Module</div>
      <div class="tab" onclick="switchTab('week')">By Week</div>
      <div class="tab" onclick="switchTab('semester')">By Semester</div>
      <div class="tab" onclick="switchTab('heatmap')">Heatmap</div>
      <div class="tab" onclick="switchTab('clashes')" id="clashTab" style="display:none;">‚ö† Clashes</div>
      <div class="tab" onclick="switchTab('raw')">Raw Data</div>
    </div>

    <!-- By Staff -->
    <div class="tab-content active" id="tab-staff">
      <div class="filter-bar">
        <input type="text" id="staffFilter" placeholder="Filter staff‚Ä¶" oninput="renderStaffTable()">
        <select id="staffSemFilter" onchange="renderStaffTable()"><option value="">All Semesters</option></select>
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('staff')">Export CSV</button>
      </div>
      <div class="table-wrap" id="staffTable"></div>
    </div>

    <!-- By Module -->
    <div class="tab-content" id="tab-module">
      <div class="filter-bar">
        <input type="text" id="moduleFilter" placeholder="Filter modules‚Ä¶" oninput="renderModuleTable()">
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('module')">Export CSV</button>
      </div>
      <div class="table-wrap" id="moduleTable"></div>
    </div>

    <!-- By Week -->
    <div class="tab-content" id="tab-week">
      <div class="filter-bar">
        <select id="weekStaffFilter" onchange="renderWeekTable()"><option value="">All Staff</option></select>
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('week')">Export CSV</button>
      </div>
      <div class="table-wrap" id="weekTable"></div>
    </div>

    <!-- By Semester -->
    <div class="tab-content" id="tab-semester">
      <div class="table-wrap" id="semesterTable"></div>
    </div>

    <!-- Heatmap -->
    <div class="tab-content" id="tab-heatmap">
      <div class="filter-bar">
        <label style="font-family:DM Mono,monospace;font-size:0.72rem;color:var(--muted);">Show:</label>
        <select id="heatmapMetric" onchange="renderHeatmap()">
          <option value="hours">Hours per week</option>
          <option value="sessions">Sessions per week</option>
        </select>
      </div>
      <div id="heatmapContainer" style="overflow-x:auto;padding-bottom:8px;"></div>
    </div>

    <!-- Clashes -->
    <div class="tab-content" id="tab-clashes">
      <div class="filter-bar">
        <input type="text" id="clashFilter" placeholder="Filter by staff or module‚Ä¶" oninput="renderClashTable()">
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('clashes')">Export CSV</button>
      </div>
      <div class="table-wrap" id="clashTable"></div>
    </div>

    <!-- Raw Data -->
    <div class="tab-content" id="tab-raw">
      <div class="filter-bar">
        <input type="text" id="rawFilter" placeholder="Search all fields‚Ä¶" oninput="renderRawTable()">
      </div>
      <div class="export-bar">
        <button class="btn btn-outline btn-sm" onclick="exportCSV('raw')">Export CSV</button>
      </div>
      <div class="table-wrap" id="rawTable"></div>
    </div>

  </div>

</main>

<div class="tooltip" id="tooltip"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOKMARKLET GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const bookmarkletSrc = `(function(){
  var tables=Array.from(document.querySelectorAll('table')).filter(function(t){return t.rows.length>1;});
  if(tables.length===0){
    var items=document.querySelectorAll('[class*="event"],[class*="session"],[class*="timetable"],[class*="lesson"],[class*="slot"]');
    var divRows=[];
    items.forEach(function(el){divRows.push(el.innerText.replace(/\\n+/g,'|'));});
    if(divRows.length===0){alert('No timetable tables or events found on this page.');return;}
    navigator.clipboard.writeText(JSON.stringify({type:'divs',rows:divRows})).then(function(){alert('Scraped '+divRows.length+' items! Paste into the analyser.');});
    return;
  }
  var sig=function(t){return Array.from(t.rows[0].cells).map(function(c){return c.innerText.trim();}).join('|');};
  var sigCounts={};
  tables.forEach(function(t){var s=sig(t);sigCounts[s]=(sigCounts[s]||0)+1;});
  var bestSig=Object.keys(sigCounts).sort(function(a,b){return sigCounts[b]-sigCounts[a]||b.split('|').length-a.split('|').length;})[0];
  var matching=tables.filter(function(t){return sig(t)===bestSig;});
  var headers=bestSig.split('|');
  var rows=[];
  matching.forEach(function(t){
    for(var i=1;i<t.rows.length;i++){
      var row={};
      Array.from(t.rows[i].cells).forEach(function(c,j){row[headers[j]||'col'+j]=c.innerText.trim();});
      if(Object.values(row).some(function(v){return v;}))rows.push(row);
    }
  });
  var out=JSON.stringify({type:'table',headers:headers,rows:rows});
  navigator.clipboard.writeText(out).then(function(){alert('Scraped '+rows.length+' rows from '+matching.length+' table(s). Columns: '+headers.join(', ')+'\\n\\nPaste into the analyser!');}).catch(function(){prompt('Copy this:',out);});
})();`;

const encoded = 'javascript:' + encodeURIComponent(bookmarkletSrc);
document.getElementById('bookmarkletLink').href = encoded;
document.getElementById('bookmarkletCode').textContent = bookmarkletSrc.substring(0, 120) + '‚Ä¶';

function copyBookmarklet() {
  navigator.clipboard.writeText(encoded).then(() => {
    const btn = event.target;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy Code', 2000);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let rawRows = [];        // parsed raw rows from source
let mappedRows = [];     // rows after column mapping applied
let columns = [];        // detected column names
let sortState = {};      // per-table sort state

const FIELD_KEYS = ['staff', 'module', 'date', 'startTime', 'endTime', 'duration', 'type', 'room', 'week', 'semester'];
const FIELD_LABELS = { staff:'Staff Name', module:'Module/Course', date:'Date', startTime:'Start Time', endTime:'End Time', duration:'Duration (hrs)', type:'Session Type', room:'Room', week:'Week Number', semester:'Semester' };
const AUTO_MAP_HINTS = {
  staff: ['staff','lecturer','tutor','teacher','instructor','name','faculty','convener'],
  module: ['module','course','unit','subject','code','title','class'],
  date: ['date','day'],
  startTime: ['start','from','begin','time'],
  endTime: ['end','finish','until','to'],
  duration: ['duration','hours','hrs','length','mins','minutes'],
  type: ['type','session','activity','kind','format','mode'],
  room: ['room','venue','location','building','space'],
  week: ['week','wk','w/c'],
  semester: ['semester','term','period','sem'],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');

dropzone.addEventListener('click', () => fileInput.click());
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('drag-over'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('drag-over'); const f = e.dataTransfer.files[0]; if(f) handleFile(f); });
fileInput.addEventListener('change', () => { if(fileInput.files[0]) handleFile(fileInput.files[0]); });

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const content = e.target.result;
    if (file.name.endsWith('.csv')) {
      parseCSV(content);
    } else {
      parseHTML(content);
    }
  };
  reader.readAsText(file);
}

function parseHTML(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const tables = Array.from(doc.querySelectorAll('table')).filter(t => t.rows.length > 1);
  if (!tables.length) { setStatus('error', 'No tables found in HTML file.'); return; }

  // Find the most common header signature (to handle nav/layout tables mixed in)
  const sig = t => Array.from(t.rows[0].cells).map(c => (c.innerText || c.textContent || '').trim()).join('|');
  const sigCounts = {};
  tables.forEach(t => { const s = sig(t); sigCounts[s] = (sigCounts[s] || 0) + 1; });
  // Pick the signature with the most tables; break ties by most columns
  const bestSig = Object.entries(sigCounts).sort((a, b) => b[1] - a[1] || b[0].split('|').length - a[0].split('|').length)[0][0];
  const matchingTables = tables.filter(t => sig(t) === bestSig);
  const headers = bestSig.split('|');

  const DELIM = '\x00';
  const rows = [];
  let multiStaffExpanded = 0;

  matchingTables.forEach(t => {
    for (let i = 1; i < t.rows.length; i++) {
      // For each cell, replace <br> with a delimiter BEFORE reading text
      const cellValues = Array.from(t.rows[i].cells).map(c => {
        const clone = c.cloneNode(true);
        clone.querySelectorAll('br').forEach(br => br.replaceWith(DELIM));
        return (clone.innerText || clone.textContent || '').trim();
      });

      // Split each cell on the delimiter
      const splitCells = cellValues.map(v =>
        v.split(DELIM).map(s => s.trim()).filter(Boolean)
      );
      const maxSplit = Math.max(...splitCells.map(s => s.length));

      if (maxSplit <= 1) {
        // Normal single-staff row
        const row = {};
        headers.forEach((h, j) => { row[h || 'col' + j] = (splitCells[j] && splitCells[j][0]) || ''; });
        if (Object.values(row).some(v => v)) rows.push(row);
      } else {
        // Multi-staff row: expand into one row per staff member
        multiStaffExpanded += maxSplit - 1;
        for (let k = 0; k < maxSplit; k++) {
          const row = {};
          headers.forEach((h, j) => {
            const parts = splitCells[j];
            row[h || 'col' + j] = parts.length > 1
              ? (parts[k] !== undefined ? parts[k] : parts[parts.length - 1])
              : (parts[0] || '');
          });
          if (Object.values(row).some(v => v)) rows.push(row);
        }
      }
    }
  });

  if (!rows.length) { setStatus('error', 'Tables found but no data rows.'); return; }
  const skipped = tables.length - matchingTables.length;
  const expandedNote = multiStaffExpanded ? ` ¬∑ ${multiStaffExpanded} multi-staff rows expanded` : '';
  columns = headers;
  rawRows = rows;
  setStatus('loaded', `Merged ${matchingTables.length} table${matchingTables.length>1?'s':''} ‚Üí ${rows.length} rows (${headers.length} columns: ${headers.join(', ')})${skipped ? ` ¬∑ ${skipped} non-matching table(s) ignored` : ''}${expandedNote}`);
  showMapping();
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) { setStatus('error', 'CSV file appears empty.'); return; }
  const headers = parseCSVLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = parseCSVLine(lines[i]);
    const row = {};
    headers.forEach((h, j) => { row[h] = vals[j] || ''; });
    if (Object.values(row).some(v => v)) rows.push(row);
  }
  columns = headers;
  rawRows = rows;
  setStatus('loaded', `Loaded ${rows.length} rows from CSV (${headers.length} columns: ${headers.join(', ')})`);
  showMapping();
}

function parseCSVLine(line) {
  const result = [];
  let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur.trim()); cur = ''; }
    else { cur += c; }
  }
  result.push(cur.trim());
  return result;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PASTE / BOOKMARKLET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parsePaste() {
  const text = document.getElementById('pasteArea').value.trim();
  if (!text) { setStatus('error', 'Nothing pasted.'); return; }
  try {
    const obj = JSON.parse(text);
    if (obj.type === 'table' && obj.rows) {
      columns = obj.headers;
      rawRows = obj.rows;
      setStatus('loaded', `Loaded ${rawRows.length} scraped rows (${columns.length} columns)`);
      showMapping();
      return;
    }
    if (obj.type === 'divs' && obj.rows) {
      // Try to parse pipe-separated rows
      rawRows = obj.rows.map((r, i) => ({ '_row': r, '_index': i }));
      columns = ['_row'];
      setStatus('loaded', `Loaded ${rawRows.length} div-scraped rows. Please map fields manually.`);
      showMapping();
      return;
    }
  } catch(e) {}
  // Try CSV
  if (text.includes(',') || text.includes('\t')) {
    const sep = text.includes('\t') ? '\t' : ',';
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const headers = lines[0].split(sep).map(h => h.trim().replace(/"/g,''));
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const vals = lines[i].split(sep).map(v => v.trim().replace(/"/g,''));
      const row = {};
      headers.forEach((h, j) => row[h] = vals[j] || '');
      rows.push(row);
    }
    columns = headers;
    rawRows = rows;
    setStatus('loaded', `Parsed ${rows.length} rows from pasted text`);
    showMapping();
    return;
  }
  setStatus('error', 'Could not parse pasted data. Try pasting JSON from the bookmarklet or CSV text.');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLUMN MAPPING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showMapping() {
  const panel = document.getElementById('mappingPanel');
  const grid = document.getElementById('mappingGrid');
  grid.innerHTML = '';

  FIELD_KEYS.forEach(key => {
    const div = document.createElement('div');
    div.className = 'map-field';
    const label = document.createElement('label');
    label.textContent = FIELD_LABELS[key];
    const sel = document.createElement('select');
    sel.id = 'map_' + key;
    sel.innerHTML = '<option value="">‚Äî skip ‚Äî</option>';
    columns.forEach(col => {
      const opt = document.createElement('option');
      opt.value = col;
      opt.textContent = col;
      sel.appendChild(opt);
    });
    // Auto-detect
    const hints = AUTO_MAP_HINTS[key];
    const match = columns.find(c => hints.some(h => c.toLowerCase().includes(h)));
    if (match) sel.value = match;
    div.appendChild(label);
    div.appendChild(sel);
    grid.appendChild(div);
  });

  panel.classList.add('visible');
}

function applyMapping() {
  const mapping = {};
  FIELD_KEYS.forEach(key => {
    const sel = document.getElementById('map_' + key);
    if (sel && sel.value) mapping[key] = sel.value;
  });

  if (!mapping.staff && !mapping.module) {
    alert('Please map at least Staff or Module column.');
    return;
  }

  mappedRows = rawRows.map(row => {
    const r = {};
    FIELD_KEYS.forEach(key => {
      r[key] = mapping[key] ? (row[mapping[key]] || '') : '';
    });
    // Try to derive duration if not mapped
    if (!r.duration && r.startTime && r.endTime) {
      r.duration = parseHours(r.startTime, r.endTime);
    }
    if (!r.duration) r.duration = 1; // default 1hr
    else r.duration = parseFloat(r.duration) || 1;
    // Derive week from date if not mapped
    if (!r.week && r.date) r.week = dateToWeek(r.date);
    if (!r.semester && r.week) r.semester = weekToSemester(parseInt(r.week));
    return r;
  }).filter(r => r.staff || r.module);

  document.getElementById('mappingPanel').classList.remove('visible');
  buildResults();
}

function parseHours(start, end) {
  const toMins = s => {
    const m = s.match(/(\d+):(\d+)/);
    if (!m) return null;
    return parseInt(m[1])*60 + parseInt(m[2]);
  };
  // handle am/pm
  const toMins2 = s => {
    const m = s.match(/(\d+)(?::(\d+))?\s*(am|pm)/i);
    if (!m) return toMins(s);
    let h = parseInt(m[1]), mn = parseInt(m[2]||0);
    if (m[3].toLowerCase() === 'pm' && h !== 12) h += 12;
    if (m[3].toLowerCase() === 'am' && h === 12) h = 0;
    return h*60 + mn;
  };
  const s = toMins2(start), e = toMins2(end);
  if (s === null || e === null) return 1;
  return Math.max(0.5, (e - s) / 60);
}

function dateToWeek(dateStr) {
  try {
    const d = new Date(dateStr);
    if (isNaN(d)) return '';
    const jan1 = new Date(d.getFullYear(), 0, 1);
    return Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
  } catch { return ''; }
}

function weekToSemester(week) {
  if (!week) return 'Unknown';
  if (week <= 20) return 'Semester 1';
  if (week <= 40) return 'Semester 2';
  return 'Summer';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD RESULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildResults() {
  // Reset clash state on new data load
  clashData = { run: false, clashPairs: [], effectiveHours: {} };
  document.getElementById('clashBtn').classList.remove('active');
  document.getElementById('clashBtn').textContent = '‚ö° Detect Clashes';
  document.getElementById('clashSummaryText').textContent = '';
  document.getElementById('clashTab').style.display = 'none';

  document.getElementById('results').style.display = 'block';
  buildKPIs();
  populateFilters();
  renderStaffTable();
  renderModuleTable();
  renderWeekTable();
  renderSemesterTable();
  renderHeatmap();
  renderRawTable();
}

function buildKPIs() {
  const totalHrs = mappedRows.reduce((s, r) => s + r.duration, 0);
  const staffSet = new Set(mappedRows.map(r => r.staff).filter(Boolean));
  const moduleSet = new Set(mappedRows.map(r => r.module).filter(Boolean));
  const weekSet = new Set(mappedRows.map(r => r.week).filter(Boolean));
  const semSet = new Set(mappedRows.map(r => r.semester).filter(Boolean));

  const clashCount = clashData.run ? mappedRows.filter(r => r._clash).length : null;
  const effectiveTotalHrs = clashData.run
    ? Object.values(clashData.effectiveHours).reduce((s, h) => s + h, 0)
    : null;

  let kpis = [
    [mappedRows.length, 'Sessions', ''],
    [totalHrs.toFixed(1), 'Total Hours (raw)', ''],
    [staffSet.size, 'Staff Members', ''],
    [moduleSet.size, 'Modules', ''],
    [weekSet.size, 'Weeks', ''],
    [semSet.size, 'Semesters', ''],
  ];

  if (clashData.run) {
    kpis.push([clashCount, 'Clashing Sessions', 'kpi-clash']);
    kpis.push([effectiveTotalHrs.toFixed(1), 'Effective Hours', '']);
  }

  document.getElementById('kpiRow').innerHTML = kpis
    .map(([v, l, cls]) => `<div class="kpi ${cls}"><div class="val">${v}</div><div class="lbl">${l}</div></div>`).join('');
}

function populateFilters() {
  const sems = [...new Set(mappedRows.map(r => r.semester).filter(Boolean))].sort();
  const staffs = [...new Set(mappedRows.map(r => r.staff).filter(Boolean))].sort();

  const semSel = document.getElementById('staffSemFilter');
  semSel.innerHTML = '<option value="">All Semesters</option>' + sems.map(s => `<option>${s}</option>`).join('');

  const weekStaffSel = document.getElementById('weekStaffFilter');
  weekStaffSel.innerHTML = '<option value="">All Staff</option>' + staffs.map(s => `<option>${s}</option>`).join('');
}

// ‚îÄ‚îÄ Staff table ‚îÄ‚îÄ
function renderStaffTable() {
  const filter = document.getElementById('staffFilter').value.toLowerCase();
  const semF = document.getElementById('staffSemFilter').value;

  const data = {};
  mappedRows.forEach(r => {
    if (!r.staff) return;
    if (filter && !r.staff.toLowerCase().includes(filter)) return;
    if (semF && r.semester !== semF) return;
    if (!data[r.staff]) data[r.staff] = { sessions:0, hours:0, clashSessions:0, modules: new Set(), semesters: new Set() };
    data[r.staff].sessions++;
    data[r.staff].hours += r.duration;
    if (r._clash) data[r.staff].clashSessions++;
    if (r.module) data[r.staff].modules.add(r.module);
    if (r.semester) data[r.staff].semesters.add(r.semester);
  });

  const showClash = clashData.run;
  const rows = Object.entries(data).map(([name, d]) => ({
    name,
    hours: d.hours,
    effectiveHours: showClash ? (clashData.effectiveHours[name] || d.hours) : null,
    clashSessions: d.clashSessions,
    sessions: d.sessions,
    modules: d.modules.size,
    semesters: [...d.semesters].join(', ')
  }));

  const maxHrs = Math.max(...rows.map(r => r.hours), 1);

  const cols = [['name','Staff'], ['hours', showClash ? 'Raw Hours' : 'Hours']];
  if (showClash) cols.push(['effectiveHours','Effective Hours'], ['clashSessions','Clashes']);
  cols.push(['sessions','Sessions'], ['modules','Modules'], ['semesters','Semesters']);

  renderTable('staffTable', rows, cols,
    (row, key) => {
      if (key === 'hours') return `${row.hours.toFixed(1)}<span class="mini-bar"><span class="mini-bar-fill" style="width:${row.hours/maxHrs*100}%"></span></span>`;
      if (key === 'effectiveHours') {
        const eff = row.effectiveHours !== null ? row.effectiveHours : row.hours;
        const saved = row.hours - eff;
        return `<strong>${eff.toFixed(1)}</strong>${saved > 0.01 ? ` <span style="color:var(--danger);font-size:0.7rem;">(-${saved.toFixed(1)})</span>` : ''}`;
      }
      if (key === 'clashSessions') return row.clashSessions > 0
        ? `<span class="badge clash-badge">${row.clashSessions}</span>`
        : `<span class="badge safe-badge">0</span>`;
      if (key === 'sessions') return `<span class="badge badge-teal">${row.sessions}</span>`;
      return row[key];
    }
  );
}

// ‚îÄ‚îÄ Module table ‚îÄ‚îÄ
function renderModuleTable() {
  const filter = document.getElementById('moduleFilter').value.toLowerCase();
  const data = {};
  mappedRows.forEach(r => {
    if (!r.module) return;
    if (filter && !r.module.toLowerCase().includes(filter)) return;
    if (!data[r.module]) data[r.module] = { sessions:0, hours:0, staff: new Set(), weeks: new Set() };
    data[r.module].sessions++;
    data[r.module].hours += r.duration;
    if (r.staff) data[r.module].staff.add(r.staff);
    if (r.week) data[r.module].weeks.add(r.week);
  });

  const rows = Object.entries(data).map(([mod, d]) => ({
    module: mod, sessions: d.sessions, hours: d.hours,
    staffCount: d.staff.size, weekCount: d.weeks.size
  }));

  const maxHrs = Math.max(...rows.map(r => r.hours), 1);

  renderTable('moduleTable', rows,
    [['module','Module'], ['hours','Total Hours'], ['sessions','Sessions'], ['staffCount','Staff'], ['weekCount','Weeks Active']],
    (row, key) => {
      if (key === 'hours') return `${row.hours.toFixed(1)}<span class="mini-bar"><span class="mini-bar-fill" style="width:${row.hours/maxHrs*100}%"></span></span>`;
      if (key === 'sessions') return `<span class="badge badge-yellow">${row.sessions}</span>`;
      return row[key];
    }
  );
}

// ‚îÄ‚îÄ Week table ‚îÄ‚îÄ
function renderWeekTable() {
  const staffF = document.getElementById('weekStaffFilter').value;
  const data = {};
  mappedRows.forEach(r => {
    if (!r.week) return;
    if (staffF && r.staff !== staffF) return;
    if (!data[r.week]) data[r.week] = { sessions:0, hours:0, staff: new Set(), modules: new Set() };
    data[r.week].sessions++;
    data[r.week].hours += r.duration;
    if (r.staff) data[r.week].staff.add(r.staff);
    if (r.module) data[r.week].modules.add(r.module);
  });

  const rows = Object.entries(data).sort((a, b) => a[0].localeCompare(b[0], undefined, {numeric:true})).map(([wk, d]) => ({
    week: wk, sessions: d.sessions, hours: d.hours,
    staffCount: d.staff.size, moduleCount: d.modules.size
  }));

  const maxHrs = Math.max(...rows.map(r => r.hours), 1);
  renderTable('weekTable', rows,
    [['week','Week'], ['hours','Hours'], ['sessions','Sessions'], ['staffCount','Staff Active'], ['moduleCount','Modules']],
    (row, key) => {
      if (key === 'hours') return `${row.hours.toFixed(1)}<span class="mini-bar"><span class="mini-bar-fill" style="width:${row.hours/maxHrs*100}%"></span></span>`;
      if (key === 'sessions') return `<span class="badge badge-purple">${row.sessions}</span>`;
      return row[key];
    }
  );
}

// ‚îÄ‚îÄ Semester table ‚îÄ‚îÄ
function renderSemesterTable() {
  const data = {};
  mappedRows.forEach(r => {
    const sem = r.semester || 'Unknown';
    if (!data[sem]) data[sem] = { sessions:0, hours:0, staff: new Set(), modules: new Set() };
    data[sem].sessions++;
    data[sem].hours += r.duration;
    if (r.staff) data[sem].staff.add(r.staff);
    if (r.module) data[sem].modules.add(r.module);
  });

  const rows = Object.entries(data).map(([sem, d]) => ({
    semester: sem, sessions: d.sessions, hours: d.hours,
    staffCount: d.staff.size, moduleCount: d.modules.size,
    avgPerStaff: d.staff.size ? (d.hours / d.staff.size).toFixed(1) : '‚Äî'
  }));

  renderTable('semesterTable', rows,
    [['semester','Semester'], ['hours','Total Hours'], ['sessions','Sessions'], ['staffCount','Staff'], ['moduleCount','Modules'], ['avgPerStaff','Avg Hrs/Staff']],
    (row, key) => {
      if (key === 'sessions') return `<span class="badge badge-teal">${row.sessions}</span>`;
      if (key === 'hours') return `<strong>${parseFloat(row.hours).toFixed(1)}</strong>`;
      return row[key];
    }
  );
}

// ‚îÄ‚îÄ Raw table ‚îÄ‚îÄ
function renderRawTable() {
  const filter = document.getElementById('rawFilter').value.toLowerCase();
  const rows = filter ? mappedRows.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(filter))) : mappedRows;
  const cols = FIELD_KEYS.filter(k => rows.some(r => r[k]));
  renderTable('rawTable', rows,
    cols.map(k => [k, FIELD_LABELS[k]]),
    (row, key) => {
      let val = row[key] !== undefined ? row[key] : '';
      if (key === 'staff' && row._clash) {
        return `${val}<span class="clash-pill" title="${row._clashWith || 'Overlaps with another session'}">‚ö† clash</span>`;
      }
      return val;
    },
    50,
    row => row._clash ? 'clash-row' : ''
  );
}

// ‚îÄ‚îÄ Clash table ‚îÄ‚îÄ
function renderClashTable() {
  const filter = document.getElementById('clashFilter').value.toLowerCase();
  let pairs = clashData.clashPairs;
  if (filter) pairs = pairs.filter(p =>
    p.staff.toLowerCase().includes(filter) ||
    (p.moduleA||'').toLowerCase().includes(filter) ||
    (p.moduleB||'').toLowerCase().includes(filter)
  );
  if (!pairs.length) {
    document.getElementById('clashTable').innerHTML = '<div class="empty-state"><div class="big">‚úÖ</div><p>No clashes found.</p></div>';
    return;
  }
  const cols = [['staff','Staff'],['dateA','Date'],['timeA','Session A'],['moduleA','Module A'],['timeB','Session B'],['moduleB','Module B'],['overlapMins','Overlap (mins)']];
  renderTable('clashTable', pairs, cols, (row, key) => {
    if (key === 'overlapMins') return `<span class="badge clash-badge">${row[key]} min${row[key]!==1?'s':''}</span>`;
    if (key === 'staff') return `<strong>${row[key]}</strong>`;
    return row[key] || '‚Äî';
  });
}

// ‚îÄ‚îÄ Generic table renderer ‚îÄ‚îÄ
function renderTable(containerId, rows, cols, cellFn, limit = null, rowClassFn = null) {
  const container = document.getElementById(containerId);
  if (!rows.length) { container.innerHTML = '<div class="empty-state"><div class="big">üîç</div><p>No data to display.</p></div>'; return; }

  const state = sortState[containerId] || { col: null, dir: 1 };
  if (state.col) {
    rows = [...rows].sort((a, b) => {
      const av = isNaN(a[state.col]) ? a[state.col] : parseFloat(a[state.col]);
      const bv = isNaN(b[state.col]) ? b[state.col] : parseFloat(b[state.col]);
      return av > bv ? state.dir : av < bv ? -state.dir : 0;
    });
  }

  const displayRows = limit ? rows.slice(0, limit) : rows;

  const thead = `<thead><tr>${cols.map(([k, l]) => {
    let cls = '';
    if (state.col === k) cls = state.dir === 1 ? 'sort-asc' : 'sort-desc';
    return `<th class="${cls}" onclick="sortTable('${containerId}','${k}')">${l}</th>`;
  }).join('')}</tr></thead>`;

  const tbody = `<tbody>${displayRows.map(row => {
    const cls = rowClassFn ? rowClassFn(row) : '';
    return `<tr class="${cls}">${cols.map(([k]) => `<td>${cellFn ? cellFn(row, k) : (row[k] ?? '')}</td>`).join('')}</tr>`;
  }).join('')}${limit && rows.length > limit ? `<tr><td colspan="${cols.length}" style="text-align:center;color:var(--muted);font-family:'DM Mono',monospace;font-size:0.72rem;padding:16px;">‚Ä¶ and ${rows.length - limit} more rows</td></tr>` : ''}</tbody>`;

  container.innerHTML = `<table>${thead}${tbody}</table>`;
}

function sortTable(containerId, col) {
  const state = sortState[containerId] || { col: null, dir: 1 };
  if (state.col === col) state.dir *= -1;
  else { state.col = col; state.dir = -1; }
  sortState[containerId] = state;
  // Re-render
  const fns = { staffTable: renderStaffTable, moduleTable: renderModuleTable, weekTable: renderWeekTable, semesterTable: renderSemesterTable, rawTable: renderRawTable };
  if (fns[containerId]) fns[containerId]();
}

// ‚îÄ‚îÄ Heatmap (staff √ó week) ‚îÄ‚îÄ
function renderHeatmap() {
  const metric = document.getElementById('heatmapMetric').value;
  const staffList = [...new Set(mappedRows.map(r => r.staff).filter(Boolean))].sort();
  const weekList = [...new Set(mappedRows.map(r => r.week).filter(Boolean))].sort((a, b) => a - b);

  if (!staffList.length || !weekList.length) {
    document.getElementById('heatmapContainer').innerHTML = '<div class="empty-state"><div class="big">üìä</div><p>Need staff and week data for heatmap.</p></div>';
    return;
  }

  const grid = {};
  mappedRows.forEach(r => {
    if (!r.staff || !r.week) return;
    const k = `${r.staff}__${r.week}`;
    if (!grid[k]) grid[k] = { hours: 0, sessions: 0 };
    grid[k].hours += r.duration;
    grid[k].sessions++;
  });

  const vals = Object.values(grid).map(v => metric === 'hours' ? v.hours : v.sessions);
  const maxVal = Math.max(...vals, 1);

  const heatColour = (v, max) => {
    const t = v / max;
    if (t === 0) return `rgba(42,45,58,0.5)`;
    const r = Math.round(232 * t + 30 * (1-t));
    const g = Math.round(197 * t * 0.4 + 201 * (1-t));
    const b = Math.round(71 * t * 0.2 + 176 * (1-t));
    return `rgb(${r},${g},${b})`;
  };

  const headerRow = `<div class="heatmap-row"><div class="heatmap-label"></div>${weekList.map(w => `<div class="heatmap-week-header">W${w}</div>`).join('')}</div>`;

  const rows = staffList.map(staff => {
    const cells = weekList.map(wk => {
      const k = `${staff}__${wk}`;
      const v = grid[k] ? (metric === 'hours' ? grid[k].hours : grid[k].sessions) : 0;
      const bg = heatColour(v, maxVal);
      const label = v > 0 ? (metric === 'hours' ? v.toFixed(1) : v) : '';
      return `<div class="heatmap-cell" style="background:${bg}" title="${staff} ¬∑ Week ${wk}: ${v > 0 ? (metric==='hours' ? v.toFixed(1)+' hrs' : v+' sessions') : 'none'}">${label}</div>`;
    }).join('');
    return `<div class="heatmap-row"><div class="heatmap-label" title="${staff}">${staff}</div>${cells}</div>`;
  }).join('');

  document.getElementById('heatmapContainer').innerHTML = `<div class="heatmap-grid">${headerRow}${rows}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLASH DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let clashData = { run: false, clashPairs: [], effectiveHours: {} };

function toAbsMinutes(row) {
  // Returns [start, end] in absolute minutes, using date + time.
  // Falls back to time-only (treating same day if no date).
  const parseTime = t => {
    if (!t) return null;
    const ampm = t.match(/(\d+)(?::(\d+))?\s*(am|pm)/i);
    if (ampm) {
      let h = parseInt(ampm[1]), m = parseInt(ampm[2]||0);
      if (ampm[3].toLowerCase()==='pm' && h!==12) h+=12;
      if (ampm[3].toLowerCase()==='am' && h===12) h=0;
      return h*60+m;
    }
    const hm = t.match(/(\d+):(\d+)/);
    if (hm) return parseInt(hm[1])*60+parseInt(hm[2]);
    return null;
  };

  let dayOffset = 0;
  if (row.date) {
    try {
      const d = new Date(row.date);
      if (!isNaN(d)) dayOffset = Math.floor(d.getTime() / 86400000) * 1440;
    } catch(e) {}
  }

  const st = parseTime(row.startTime);
  let en = parseTime(row.endTime);
  if (st === null) return null;
  if (en === null) en = st + Math.round((row.duration || 1) * 60);

  return [dayOffset + st, dayOffset + en];
}

function mergeIntervals(intervals) {
  // Returns total minutes covered by merged intervals
  if (!intervals.length) return 0;
  intervals.sort((a, b) => a[0] - b[0]);
  let merged = [intervals[0]];
  for (let i = 1; i < intervals.length; i++) {
    const last = merged[merged.length - 1];
    if (intervals[i][0] < last[1]) {
      last[1] = Math.max(last[1], intervals[i][1]);
    } else {
      merged.push(intervals[i]);
    }
  }
  return merged.reduce((s, [a, b]) => s + (b - a), 0) / 60;
}

function runClashDetection() {
  // Check we have enough time info
  const hasTime = mappedRows.some(r => r.startTime || r.endTime);
  if (!hasTime) {
    alert('Clash detection needs Start Time and/or End Time columns mapped. Please re-map your columns and include time fields.');
    return;
  }

  // Show working state immediately, then do the work after the browser has painted
  const btn = document.getElementById('clashBtn');
  btn.textContent = '‚è≥ Working‚Ä¶';
  btn.disabled = true;
  document.getElementById('clashSummaryText').textContent = 'Analysing sessions‚Ä¶';

  setTimeout(() => {
    // Reset row flags
    mappedRows.forEach(r => { r._clash = false; r._clashWith = ''; });

    // Group rows by staff member
    const byStaff = {};
    mappedRows.forEach((r, idx) => {
      if (!r.staff) return;
      if (!byStaff[r.staff]) byStaff[r.staff] = [];
      byStaff[r.staff].push({ row: r, idx, interval: toAbsMinutes(r) });
    });

    const clashPairs = [];
    const effectiveHours = {};

    Object.entries(byStaff).forEach(([staff, sessions]) => {
      // Compute effective hours (merging overlapping intervals)
      const intervals = sessions.map(s => s.interval).filter(Boolean);
      effectiveHours[staff] = intervals.length
        ? mergeIntervals(intervals)
        : sessions.reduce((s, x) => s + (x.row.duration || 1), 0);

      // Find clashing pairs
      for (let i = 0; i < sessions.length; i++) {
        for (let j = i + 1; j < sessions.length; j++) {
          const a = sessions[i], b = sessions[j];
          if (!a.interval || !b.interval) continue;
          const overlapStart = Math.max(a.interval[0], b.interval[0]);
          const overlapEnd   = Math.min(a.interval[1], b.interval[1]);
          if (overlapEnd > overlapStart) {
            const overlapMins = Math.round(overlapEnd - overlapStart);
            const descA = `${a.row.startTime||'?'}‚Äì${a.row.endTime||'?'} ${a.row.module||''}`.trim();
            const descB = `${b.row.startTime||'?'}‚Äì${b.row.endTime||'?'} ${b.row.module||''}`.trim();
            a.row._clash = true;
            b.row._clash = true;
            a.row._clashWith = `Clashes with: ${descB}`;
            b.row._clashWith = `Clashes with: ${descA}`;
            clashPairs.push({
              staff,
              dateA: a.row.date || a.row.week ? `${a.row.date||''} W${a.row.week||''}`.trim() : '‚Äî',
              timeA: `${a.row.startTime||'?'}‚Äì${a.row.endTime||'?'}`,
              moduleA: a.row.module || '‚Äî',
              timeB: `${b.row.startTime||'?'}‚Äì${b.row.endTime||'?'}`,
              moduleB: b.row.module || '‚Äî',
              overlapMins,
            });
          }
        }
      }
    });

    clashData = { run: true, clashPairs, effectiveHours };

    btn.disabled = false;
    btn.classList.add('active');
    btn.textContent = `‚ö° ${clashPairs.length} Clash${clashPairs.length !== 1 ? 'es' : ''} Found`;

    const clashTab = document.getElementById('clashTab');
    clashTab.style.display = '';
    document.getElementById('clashSummaryText').textContent =
      clashPairs.length === 0
        ? 'No simultaneous sessions detected.'
        : `${clashPairs.length} overlap${clashPairs.length!==1?'s':''} across ${new Set(clashPairs.map(p=>p.staff)).size} staff member${new Set(clashPairs.map(p=>p.staff)).size!==1?'s':''}.`;

    // Rebuild everything
    buildKPIs();
    renderStaffTable();
    renderRawTable();
    renderClashTable();

    if (clashPairs.length > 0) switchTab('clashes');
  }, 50); // 50ms gap lets the browser paint the "Working‚Ä¶" state before blocking
}

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  // Find the tab button that calls switchTab with this name
  document.querySelectorAll('.tab').forEach(t => {
    if (t.getAttribute('onclick') === `switchTab('${name}')`) t.classList.add('active');
  });
  document.getElementById('tab-' + name).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(type) {
  let rows, headers;
  if (type === 'raw') {
    headers = FIELD_KEYS;
    rows = mappedRows.map(r => FIELD_KEYS.map(k => `"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(','));
  } else if (type === 'staff') {
    headers = ['Staff','Hours','Sessions','Modules'];
    const data = {};
    mappedRows.forEach(r => {
      if (!r.staff) return;
      if (!data[r.staff]) data[r.staff] = {sessions:0,hours:0,modules:new Set()};
      data[r.staff].sessions++;
      data[r.staff].hours += r.duration;
      if (r.module) data[r.staff].modules.add(r.module);
    });
    rows = Object.entries(data).map(([n,d]) => `"${n}",${d.hours.toFixed(1)},${d.sessions},${d.modules.size}`);
  } else if (type === 'module') {
    headers = ['Module','Hours','Sessions','Staff'];
    const data = {};
    mappedRows.forEach(r => {
      if (!r.module) return;
      if (!data[r.module]) data[r.module] = {sessions:0,hours:0,staff:new Set()};
      data[r.module].sessions++;
      data[r.module].hours += r.duration;
      if (r.staff) data[r.module].staff.add(r.staff);
    });
    rows = Object.entries(data).map(([m,d]) => `"${m}",${d.hours.toFixed(1)},${d.sessions},${d.staff.size}`);
  } else if (type === 'week') {
    headers = ['Week','Hours','Sessions','Staff'];
    const data = {};
    mappedRows.forEach(r => {
      if (!r.week) return;
      if (!data[r.week]) data[r.week] = {sessions:0,hours:0,staff:new Set()};
      data[r.week].sessions++;
      data[r.week].hours += r.duration;
      if (r.staff) data[r.week].staff.add(r.staff);
    });
    rows = Object.entries(data).sort((a,b)=>a[0]-b[0]).map(([w,d]) => `${w},${d.hours.toFixed(1)},${d.sessions},${d.staff.size}`);
  }
  if (type === 'clashes') {
    headers = ['Staff','Date','Session A Time','Module A','Session B Time','Module B','Overlap (mins)'];
    rows = clashData.clashPairs.map(p =>
      [`"${p.staff}"`, `"${p.dateA||''}"`, `"${p.timeA}"`, `"${p.moduleA}"`, `"${p.timeB}"`, `"${p.moduleB}"`, p.overlapMins].join(',')
    );
  }
  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `timetable_${type}_${Date.now()}.csv`;
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setStatus(type, msg) {
  const bar = document.getElementById('statusBar');
  bar.className = 'status-bar ' + type;
  document.getElementById('statusText').textContent = msg;
}

function clearAll() {
  rawRows = []; mappedRows = []; columns = [];
  document.getElementById('pasteArea').value = '';
  document.getElementById('fileInput').value = '';
  document.getElementById('results').style.display = 'none';
  document.getElementById('mappingPanel').classList.remove('visible');
  setStatus('', 'No data loaded. Upload a file or paste scraped data to begin.');
}
</script>
</body>
</html>
